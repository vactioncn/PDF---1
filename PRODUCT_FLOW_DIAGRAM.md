# PDF解读系统 - 产品逻辑图

## 一、整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              PDF解读系统                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌───────────┐ │
│  │  文档解析     │ -> │  书籍管理     │ -> │  个性化解读   │ -> │ 书籍重构   │ │
│  │(parser_test) │    │(admin_books) │    │(aigen_test)  │    │(restructure)│ │
│  └──────────────┘    └──────────────┘    └──────────────┘    └───────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、核心流程：文档解析 (parser_test_page.html)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         文档解析流程                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [上传PDF/EPUB文件]                                                         │
│          │                                                                  │
│          ▼                                                                  │
│   ┌──────────────────┐                                                      │
│   │ 步骤1: 目录清洗   │  ← 按钮: [目录清洗]                                   │
│   │ POST /api/parse/ │                                                      │
│   │    clean_toc     │                                                      │
│   └────────┬─────────┘                                                      │
│            │ 输出: 清洗后的目录列表 (cleaned_toc)                              │
│            │ 显示: 目录清洗对比弹窗（清洗前 vs 清洗后）                          │
│            ▼                                                                │
│   ┌──────────────────┐                                                      │
│   │ 步骤2: 解析内容   │  ← 按钮: [解析内容与统计] (依赖步骤1完成)               │
│   │ POST /api/parse/ │                                                      │
│   │    extract       │                                                      │
│   └────────┬─────────┘                                                      │
│            │ 输出: 章节内容列表 (entries)                                     │
│            │       每个章节包含: title, content, word_count                  │
│            ▼                                                                │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │                      解析结果表格                                  │      │
│   │  ┌────────┬────────┬────────┬────────┬────────┬────────┐        │      │
│   │  │目录标题│抽取内容│统计字数│ 翻译   │章节概述│ 重构   │        │      │
│   │  ├────────┼────────┼────────┼────────┼────────┼────────┤        │      │
│   │  │ 第1章  │ [查看] │ 5000字 │[翻译]  │ [概述] │[重构]  │        │      │
│   │  │ 第2章  │ [查看] │12000字 │[翻译]  │ [概述] │[重构]  │        │      │
│   │  └────────┴────────┴────────┴────────┴────────┴────────┘        │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│            │                                                                │
│            ▼                                                                │
│   ┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐   │
│   │ [目录与摘要读取]  │     │ [文章结构重构]    │     │ [基本信息入库]    │   │
│   │ 生成目录+摘要文本 │     │ 分割超长章节      │     │ 保存到数据库      │   │
│   │ 用于后续AI处理   │     │ 生成新标题        │     │ POST /api/parse/ │   │
│   └──────────────────┘     └──────────────────┘     │    ingest        │   │
│                                                     └──────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心流程：个性化解读 (aigen_test_page.html)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         个性化解读流程                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 1. 选择书籍和章节                                                 │      │
│   │    [书籍下拉框] → 加载章节列表 → [章节下拉框]                      │      │
│   │    数据来源: GET /api/admin/books, GET /api/admin/books/{id}     │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                              │                                              │
│                              ▼                                              │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 2. 解读提示词调适 (4个Tab)                                        │      │
│   │    ┌─────────┬─────────┬─────────┬─────────┐                     │      │
│   │    │📖 导读  │📝 正文  │❓ 问答  │💡 问题  │                     │      │
│   │    └─────────┴─────────┴─────────┴─────────┘                     │      │
│   │    每个Tab: [提示词文本框] + [单独生成] 按钮                       │      │
│   │    底部: [加载已保存] [保存提示词]                                 │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                              │                                              │
│                              ▼                                              │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 3. 用户偏好设置                                                   │      │
│   │    ┌─────────────┬─────────────┬─────────────┬─────────────┐     │      │
│   │    │A. 创业CEO   │B. 产品经理  │C. 知识工作者│D. 职场人士  │     │      │
│   │    └─────────────┴─────────────┴─────────────┴─────────────┘     │      │
│   │                                                                   │      │
│   │    解读密度: [20% 主干] [50% 核心] [70% 深度]                     │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                              │                                              │
│                              ▼                                              │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 4. 生成解读                                                       │      │
│   │    [📋 目录与摘要读取] → 生成目录+摘要文本                         │      │
│   │    [生成解读] → POST /api/generate                                │      │
│   │                                                                   │      │
│   │    输入: chapterTitle, chapterText, userProfession,              │      │
│   │          readingGoal, focus, density, prompt_parts               │      │
│   │                                                                   │      │
│   │    输出: {                                                        │      │
│   │      personalized_intro: "个性化导读",                            │      │
│   │      interpretation: "正文讲解",                                  │      │
│   │      summary_and_application: "应用场景",                         │      │
│   │      powerful_questions: "思考问题",                              │      │
│   │      quiz: [{question, options, answer, explanation}],           │      │
│   │      _thinking_process: "深度思考过程"                            │      │
│   │    }                                                              │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                              │                                              │
│                              ▼                                              │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 5. 解读结果展示                                                   │      │
│   │    - 🔧 调试信息 (模型、参数等)                                   │      │
│   │    - 🧠 深度思考过程 (reasoning_content)                          │      │
│   │    - 📄 解读结果 (Markdown渲染)                                   │      │
│   │    - 🎙️ 播客音频 [生成播客] (可选)                                │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、核心流程：书籍重构 (book_restructure_page.html)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         书籍重构流程                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 1. 选择书籍和配置                                                 │      │
│   │    [书籍下拉框] + [分割字数上限: 5000]                            │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                              │                                              │
│                              ▼                                              │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 2. 目录重构提示词                                                 │      │
│   │    [提示词文本框] - 包含 {chapters} 占位符                        │      │
│   │    [🔄 重构目录] 按钮                                             │      │
│   │                                                                   │      │
│   │    调用: POST /api/test/doubao-thinking                          │      │
│   │    输入: 目录+摘要文本 → 深度思考模型                             │      │
│   │    输出: 新的Part结构 (Part 1, Part 2, ...)                       │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                              │                                              │
│                              ▼                                              │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 3. 重构后的目录                                                   │      │
│   │    显示: 🧠 思考过程 + ✅ 重构后的目录                            │      │
│   │    格式: Part 1: {主题名称}                                       │      │
│   │          覆盖章节: 1, 2, 3                                        │      │
│   │          摘要: {主题摘要}                                         │      │
│   │                                                                   │      │
│   │    [📖 新书生成] 按钮 (依赖重构目录完成)                          │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                              │                                              │
│                              ▼                                              │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │ 4. 新书生成                                                       │      │
│   │    - 解析新目录结构                                               │      │
│   │    - 匹配原章节内容                                               │      │
│   │    - 合并内容 + 分割超长段落                                      │      │
│   │    - 调用 POST /api/restructure/split-article 生成新标题          │      │
│   │    - 显示新书结构                                                 │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、管理功能

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         管理功能                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────────────────────┐    ┌──────────────────────────────┐     │
│   │ 书籍管理 (admin_books.html)  │    │ 章节管理 (admin.html)        │     │
│   │                              │    │                              │     │
│   │ - 查看所有书籍               │    │ - 查看所有章节               │     │
│   │ - 查看书籍详情(章节列表)     │    │ - 单个删除                   │     │
│   │ - 单个删除                   │    │ - 批量删除                   │     │
│   │ - 批量删除                   │    │ - 分页浏览                   │     │
│   │ - 分页浏览                   │    │                              │     │
│   └──────────────────────────────┘    └──────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、按钮依赖关系

```
文档解析页面:
  [目录清洗] ──启用──> [解析内容与统计] ──启用──> [目录与摘要读取]
                                        ──启用──> [文章结构重构]
                                        ──启用──> [基本信息入库]

个性化解读页面:
  [选择书籍] ──加载章节──> [选择章节] ──启用──> [目录与摘要读取]
                                      ──启用──> [生成解读]
  
  [生成解读] ──完成后──> [生成播客] (可选)

书籍重构页面:
  [选择书籍] ──启用──> [重构目录] ──完成后启用──> [新书生成]
```

---

## 七、数据流向

```
                    ┌─────────────┐
                    │  PDF/EPUB   │
                    │   文件      │
                    └──────┬──────┘
                           │
                           ▼
              ┌────────────────────────┐
              │     文档解析           │
              │  (目录清洗+内容提取)   │
              └────────────┬───────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │      SQLite数据库      │
              │  books + chapters      │
              └────────────┬───────────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │ 个性化   │    │ 书籍     │    │ 管理     │
    │ 解读     │    │ 重构     │    │ 功能     │
    └──────────┘    └──────────┘    └──────────┘
           │               │
           ▼               ▼
    ┌──────────┐    ┌──────────┐
    │ 豆包API  │    │ 豆包API  │
    │ 深度思考 │    │ 深度思考 │
    └──────────┘    └──────────┘
           │               │
           ▼               ▼
    ┌──────────┐    ┌──────────┐
    │ 解读结果 │    │ 新书结构 │
    │ (JSON)   │    │          │
    └──────────┘    └──────────┘
```

---

## 八、API接口汇总

| 功能模块 | 接口 | 方法 | 说明 |
|---------|------|------|------|
| 文档解析 | /api/parse/clean_toc | POST | 目录清洗 |
| 文档解析 | /api/parse/extract | POST | 内容提取 |
| 文档解析 | /api/parse/ingest | POST | 批量入库 |
| 内容生成 | /api/generate | POST | 生成解读 |
| 内容生成 | /api/generate/part | POST | 单独生成某部分 |
| 深度思考 | /api/test/doubao-thinking | POST | 调用深度思考模型 |
| 文章重构 | /api/restructure/split-article | POST | 分割长文章 |
| 书籍管理 | /api/admin/books | GET | 获取书籍列表 |
| 书籍管理 | /api/admin/books/{id} | GET | 获取书籍详情 |
| 书籍管理 | /api/admin/books/{id} | DELETE | 删除书籍 |
| 设置管理 | /api/settings/prompt_parts | GET/POST | 提示词配置 |
