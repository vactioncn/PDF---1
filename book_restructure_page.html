<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ä¹¦ç±é‡æ„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        color-scheme: light;
        font-family: "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        background-color: #f8fafc;
        color: #0f172a;
      }

      /* å¯¼èˆªæ æ ·å¼ */
      .top-navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 20px;
        margin: -24px -24px 24px -24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .nav-container {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        flex-wrap: wrap;
      }

      .nav-brand {
        color: white;
        font-weight: 600;
        font-size: 18px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-brand:hover {
        opacity: 0.9;
      }

      .nav-links {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .nav-link {
        color: white;
        text-decoration: none;
        padding: 8px 14px;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .nav-link.active {
        background: rgba(255, 255, 255, 0.25);
        font-weight: 500;
      }

      body {
        margin: 0;
        padding: 24px;
        max-width: 1600px;
        margin: 0 auto;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 32px;
        font-weight: 600;
        color: #0f172a;
      }

      .subtitle {
        color: #64748b;
        font-size: 14px;
        margin-bottom: 32px;
      }

      .panel {
        background: #ffffff;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 24px;
        border: 1px solid #e2e8f0;
      }

      .panel h2 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      label {
        font-weight: 600;
        font-size: 14px;
        color: #475569;
      }

      select,
      input[type="text"],
      input[type="number"],
      textarea {
        padding: 10px 14px;
        border: 1.5px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: #ffffff;
      }

      select:focus,
      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      button {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        background: #2563eb;
        color: white;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      button.secondary {
        background: #64748b;
      }

      button:disabled {
        background: #cbd5e1;
        color: #94a3b8;
        cursor: not-allowed;
        transform: none;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }

      .status {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        background: #f1f5f9;
        border-left: 4px solid #cbd5e1;
      }

      .status.info {
        background: #eff6ff;
        border-left-color: #3b82f6;
        color: #1e40af;
      }

      .status.success {
        background: #f0fdf4;
        border-left-color: #10b981;
        color: #065f46;
      }

      .status.error {
        background: #fef2f2;
        border-left-color: #ef4444;
        color: #991b1b;
      }
    </style>
  </head>
  <body>
    <!-- å¯¼èˆªæ  -->
    <nav class="top-navbar">
      <div class="nav-container">
        <a href="/" class="nav-brand">ğŸ“š PDFè§£è¯»ç³»ç»Ÿ</a>
        <div class="nav-links">
          <a href="/" class="nav-link">ğŸ  é¦–é¡µ</a>
          <a href="/aigen_test_page.html" class="nav-link">âœ¨ ä¸ªæ€§åŒ–è§£è¯»</a>
          <a href="/book_restructure_page.html" class="nav-link active">ğŸ“š ä¹¦ç±é‡æ„</a>
          <a href="/test_doubao_thinking.html" class="nav-link">ğŸ§  æ·±åº¦æ€è€ƒæµ‹è¯•</a>
          <a href="/test_thinking.html" class="nav-link">ğŸ”¬ æ€è€ƒæ¨¡å‹æµ‹è¯•</a>
          <a href="/parser_test_page.html" class="nav-link">ğŸ“„ æ–‡æ¡£è§£æ</a>
          <a href="/admin_books.html" class="nav-link">ğŸ“– ä¹¦ç±ç®¡ç†</a>
          <a href="/admin.html" class="nav-link">âš™ï¸ ç³»ç»Ÿç®¡ç†</a>
        </div>
      </div>
    </nav>

    <h1>ğŸ“š ä¹¦ç±é‡æ„</h1>
    <p class="subtitle">é€‰æ‹©ä¹¦ç±ï¼Œä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å‹é‡æ„ç›®å½•ç»“æ„ï¼Œç”Ÿæˆæ–°ä¹¦ç±</p>

    <section class="panel">
      <h2>ğŸ“š é€‰æ‹©ä¹¦ç±å’Œé…ç½®</h2>
      <div class="form-grid" style="margin-bottom: 16px;">
        <div class="form-group">
          <label for="restructureBookSelect">é€‰æ‹©ä¹¦ç±</label>
          <select id="restructureBookSelect">
            <option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="restructureMaxWords">åˆ†å‰²å­—æ•°ä¸Šé™ï¼ˆæ¯æ®µæœ€å¤§å­—æ•°ï¼‰</label>
          <input type="number" id="restructureMaxWords" value="5000" min="1000" max="20000" step="500" />
        </div>
      </div>

      <div class="form-group full-width" style="margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label for="restructurePrompt" style="margin: 0;">ç›®å½•é‡æ„æç¤ºè¯</label>
          <button id="restructureTocButton" class="secondary" disabled style="padding: 10px 20px; font-size: 14px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">ğŸ”„ é‡æ„ç›®å½•</button>
        </div>
        <textarea id="restructurePrompt" rows="15" placeholder="è¾“å…¥é‡æ„æç¤ºè¯..."></textarea>
      </div>

      <div id="restructureResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0; color: #1e293b; font-size: 16px;">ğŸ“‹ é‡æ„åçš„ç›®å½•</h3>
          <button id="generateNewBookButton" class="secondary" disabled style="padding: 8px 16px; font-size: 14px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">ğŸ“– æ–°ä¹¦ç”Ÿæˆ</button>
        </div>
        <div id="restructureResultContent" style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #e2e8f0; max-height: 500px; overflow-y: auto;"></div>
      </div>

      <div id="newBookResult" style="display: none; margin-top: 16px; padding: 16px; background: #f0fdf4; border-radius: 8px; border: 1px solid #86efac;">
        <h3 style="margin: 0 0 12px 0; color: #065f46; font-size: 16px;">âœ… æ–°ä¹¦ç”Ÿæˆå®Œæˆ</h3>
        <div id="newBookResultContent" style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #86efac; max-height: 600px; overflow-y: auto;"></div>
      </div>

      <div class="status" id="restructureStatus" style="display: none; margin-top: 16px;"></div>
    </section>

    <script>
      // é»˜è®¤çš„ç›®å½•é‡æ„æç¤ºè¯
      const DEFAULT_RESTRUCTURE_PROMPT = `ä½ æ˜¯ä¸€ä½è¶…å‰å®³çš„æ·±åº¦é˜…è¯»è¾¾äººï¼Œç‰¹åˆ«æ“…é•¿ç»“æ„åŒ–åˆ†æã€‚ç°åœ¨è¦æ ¹æ®å…¨ä¹¦çš„"ç« èŠ‚æ ‡é¢˜ + æ‘˜è¦"ï¼Œç»™è¿™æœ¬ä¹¦æ­å»ºä¸€ä¸ªè¶…æ¸…æ™°çš„é«˜å±‚è¯­ä¹‰ç»“æ„ã€‚

ä¸‹é¢æœ‰ä¸€ç»„ç« èŠ‚ä¿¡æ¯ï¼Œæ¯ä¸€é¡¹éƒ½åŒ…å«ç« èŠ‚ç¼–å·ã€ç« èŠ‚æ ‡é¢˜å’Œç« èŠ‚æ‘˜è¦ï¼š
<chapters>
{chapters}
</chapters>

ä½ çš„ä»»åŠ¡æ˜¯ï¼Œä¾æ®è¿™äº›æ ‡é¢˜å’Œæ‘˜è¦ï¼ŒæŒ‰ç…§è¯­ä¹‰å…³ç³»ï¼ŒæŠŠæ•´æœ¬ä¹¦é‡æ–°åˆ†æˆåˆé€‚æ•°é‡çš„è¶…æœ‰è¶£çš„é«˜å±‚ä¸»é¢˜ï¼ˆPartï¼‰ã€‚å…·ä½“è¦æ±‚å¦‚ä¸‹ï¼š
1. å¥½å¥½åƒé€å…¨ä¹¦å†…å®¹ï¼š
    - è®¤çœŸè¯»å®Œæ‰€æœ‰ç« èŠ‚çš„æ ‡é¢˜å’Œæ‘˜è¦ã€‚
    - æ‰¾å‡ºå…¨ä¹¦çš„æ ¸å¿ƒæ€æƒ³ã€ä¸»è¦è¯é¢˜ï¼Œè¿˜æœ‰ä½œè€…æƒ³è¦è§£å†³çš„é—®é¢˜ã€‚
2. è¿›è¡Œè¯­ä¹‰å¤§èšç±»ï¼Œåˆ’åˆ†å‡ºåˆé€‚æ•°é‡çš„"è¶…æ£’å¤§ä¸»é¢˜ / ç²¾å½©ç¯‡ç« ï¼ˆPartï¼‰"ï¼š
    - æ¯ä¸ªä¸»é¢˜é‡Œé¢çš„å†…å®¹å¾—ç´§å¯†ç›¸å…³ã€‚
    - ä¸»é¢˜ä¹‹é—´å°½é‡åˆ«é‡å¤ã€‚
    - èƒ½ä½“ç°ä½œè€…çš„é‡è¦æ€æƒ³æ¿å—ã€‚
    - ä¸»é¢˜åç§°è¦é€šä¿—æ˜“æ‡‚ï¼Œç”ŸåŠ¨æœ‰è¶£ï¼Œè®©äººçœ‹äº†å°±æƒ³è¯»ï¼Œåˆ«æé‚£ç§å¾ˆå­¦æœ¯çš„é£æ ¼ã€‚
3. åˆ—å‡ºæ¯ä¸ªä¸»é¢˜åŒ…å«çš„ç« èŠ‚ç¼–å·ï¼Œå†ç»™æ¯ä¸ªä¸»é¢˜å†™ä¸€ä¸ªæ–°çš„æ‘˜è¦ã€‚

è¾“å‡ºæ ¼å¼å¿…é¡»æ˜¯ä¸‹é¢è¿™æ ·ï¼š
Part 1ï¼š{ä¸»é¢˜åç§°}
    è¦†ç›–ç« èŠ‚ï¼š{ç« èŠ‚ç¼–å·åˆ—è¡¨}
    æ‘˜è¦ï¼š{å¯¹è¯¥ä¸»é¢˜å†…å®¹çš„ç®€è¦æ¦‚æ‹¬}

Part 2ï¼š{ä¸»é¢˜åç§°}
    è¦†ç›–ç« èŠ‚ï¼š{ç« èŠ‚ç¼–å·åˆ—è¡¨}
    æ‘˜è¦ï¼š{å¯¹è¯¥ä¸»é¢˜å†…å®¹çš„ç®€è¦æ¦‚æ‹¬}

Part 3ï¼š{ä¸»é¢˜åç§°}
    è¦†ç›–ç« èŠ‚ï¼š{ç« èŠ‚ç¼–å·åˆ—è¡¨}
    æ‘˜è¦ï¼š{å¯¹è¯¥ä¸»é¢˜å†…å®¹çš„ç®€è¦æ¦‚æ‹¬}

åˆ«åšå¤šä½™è§£é‡Šï¼Œä¹Ÿåˆ«é‡å¤ç»™æ‘˜è¦ï¼Œåªè¦ç»™å‡º"ä¸»é¢˜åç§° + åŒ…å«ç« èŠ‚ + ä¸»é¢˜æ‘˜è¦"å°±è¡Œã€‚`;

      // çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
      function renderStatus(element, message, type = "info") {
        if (!element) return;
        element.textContent = message;
        element.className = `status ${type}`;
        element.style.display = "block";
      }

      // HTMLè½¬ä¹‰å‡½æ•°
      function escapeHtml(text) {
        if (text === null || text === undefined) {
          return '';
        }
        if (typeof text !== 'string') {
          text = String(text);
        }
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      /**
       * ç”Ÿæˆç›®å½•ä¸æ‘˜è¦æ–‡æœ¬
       * 
       * è¾“å…¥ï¼šç« èŠ‚æ•°ç»„
       * è¾“å‡ºï¼šæ ¼å¼åŒ–çš„æ–‡æœ¬å­—ç¬¦ä¸²ï¼ˆç« èŠ‚åºå·+ç« èŠ‚æ ‡é¢˜+æ‘˜è¦ï¼‰
       * 
       * @param {Array} entries - ç« èŠ‚æ•°ç»„ï¼Œæ¯ä¸ªç« èŠ‚å¯¹è±¡åŒ…å« title_zh, title, summary ç­‰å­—æ®µ
       * @returns {string} ç”Ÿæˆçš„ç›®å½•ä¸æ‘˜è¦æ–‡æœ¬
       */
      function generateTocSummaryText(entries) {
        if (!entries || entries.length === 0) {
          return "";
        }

        let text = "";
        for (let i = 0; i < entries.length; i++) {
          const entry = entries[i];
          const chapterNumber = i + 1;
          const chapterTitle = entry.title_zh || entry.title || `ç¬¬${chapterNumber}ç« `;
          const chapterSummary = entry.summary || "";

          // æ ¼å¼ï¼šç« èŠ‚åºå·+ç« èŠ‚æ ‡é¢˜+æ‘˜è¦
          text += `${chapterNumber}. ${chapterTitle}`;
          if (chapterSummary) {
            text += `\n${chapterSummary}`;
          }
          text += "\n\n";
        }

        return text.trim();
      }

      /**
       * ä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å‹è¿›è¡Œå†…å®¹è§£è¯»
       * 
       * è¾“å‡ºä¸¤éƒ¨åˆ†ï¼š
       * 1. reasoning_content: æ€è€ƒè¿‡ç¨‹ - æ¨¡å‹çš„æ¨ç†å’Œæ€è€ƒè¿‡ç¨‹
       * 2. content: æœ€ç»ˆç»“æœ - æ€è€ƒåå¾—å‡ºçš„æœ€ç»ˆç­”æ¡ˆ
       * 
       * @param {string} content - è¦è§£è¯»çš„å†…å®¹ï¼ˆå¦‚ç« èŠ‚æ­£æ–‡ï¼‰
       * @param {string} prompt - è§£è¯»æç¤ºè¯ï¼ˆå¯åŒ…å«å ä½ç¬¦å¦‚ {chapter_fulltext}ï¼‰
       * @param {Object} options - å¯é€‰å‚æ•°
       * @param {string} options.model - æ¨¡å‹åç§°ï¼Œé»˜è®¤ 'doubao-seed-1-6-251015'
       * @param {number} options.temperature - æ¸©åº¦å‚æ•°ï¼Œé»˜è®¤ 0.3
       * @param {number} options.max_tokens - æœ€å¤§tokenæ•°ï¼Œé»˜è®¤ 16000
       * @param {number} options.timeout - è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 300000 (5åˆ†é’Ÿ)
       * @param {Object} options.replacements - å ä½ç¬¦æ›¿æ¢å¯¹è±¡ï¼Œå¦‚ {chapter_fulltext: '...', chapter_title: '...'}
       * @returns {Promise<Object>} è¿”å›å¯¹è±¡åŒ…å«ä¸¤éƒ¨åˆ†ï¼š
       *   - reasoning_content {string|null}: ç¬¬ä¸€éƒ¨åˆ† - æ€è€ƒè¿‡ç¨‹ï¼ˆæ¨¡å‹çš„æ¨ç†è¿‡ç¨‹ï¼‰
       *   - content {string|null}: ç¬¬äºŒéƒ¨åˆ† - æœ€ç»ˆç»“æœï¼ˆæ€è€ƒåå¾—å‡ºçš„ç­”æ¡ˆï¼‰
       *   - success {boolean}: æ˜¯å¦æˆåŠŸ
       */
      async function interpretWithDeepThinking(content, prompt, options = {}) {
        const {
          model = 'doubao-seed-1-6-251015',
          temperature = 0.3,
          max_tokens = 16000,
          timeout = 300000,
          replacements = {}
        } = options;

        // æ„å»ºå®Œæ•´çš„ promptï¼šæ›¿æ¢å ä½ç¬¦
        let finalPrompt = prompt;
        
        // ç¡®ä¿ replacements æ˜¯ä¸€ä¸ªå¯¹è±¡
        const safeReplacements = (replacements && typeof replacements === 'object' && !Array.isArray(replacements)) ? replacements : {};
        
        // é»˜è®¤æ›¿æ¢ {chapter_fulltext} ä¸ºå†…å®¹
        if (content && !safeReplacements.chapter_fulltext) {
          safeReplacements.chapter_fulltext = content;
        }
        
        // æ‰§è¡Œæ‰€æœ‰å ä½ç¬¦æ›¿æ¢ - å‚è€ƒ parser_test_page.html çš„å®ç°æ–¹å¼
        if (safeReplacements && typeof safeReplacements === 'object' && !Array.isArray(safeReplacements)) {
          // ä½¿ç”¨ Object.keys ä»£æ›¿ Object.entriesï¼Œé¿å… forEach é—®é¢˜
          const keys = Object.keys(safeReplacements);
          for (let i = 0; i < keys.length; i++) {
            const placeholder = keys[i];
            const value = safeReplacements[placeholder];
            if (value !== undefined && value !== null) {
              const regex = new RegExp(`{${placeholder}}`, 'g');
              finalPrompt = finalPrompt.replace(regex, String(value));
            }
          }
        }

        try {
          // åˆ›å»º AbortController ç”¨äºè¶…æ—¶æ§åˆ¶ - å‚è€ƒ parser_test_page.html
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), timeout);
          
          // è°ƒç”¨æ·±åº¦æ€è€ƒæ¥å£
          let response;
          try {
            response = await fetch("/api/test/doubao-thinking", {
              method: "POST",
              headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
              },
              body: JSON.stringify({
                prompt: finalPrompt,
                temperature: temperature,
                max_tokens: max_tokens,
                model: model,
              }),
              signal: controller.signal,
            });
          } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === "AbortError") {
              throw new Error("è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰ï¼Œè¯·ç¨åé‡è¯•");
            }
            // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            const errorMsg = fetchError.message || String(fetchError);
            if (errorMsg.includes("Failed to fetch") || errorMsg.includes("NetworkError")) {
              throw new Error("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š\n1. æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼ˆç«¯å£5001ï¼‰\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ›´å¤šé”™è¯¯ä¿¡æ¯");
            }
            throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${errorMsg}`);
          }
          clearTimeout(timeoutId);

          if (!response.ok) {
            let errorMessage = "ç”Ÿæˆå¤±è´¥";
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          let data;
          try {
            data = await response.json();
          } catch (jsonError) {
            throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ${jsonError.message}`);
          }
          
          // ç¡®ä¿ data æ˜¯ä¸€ä¸ªå¯¹è±¡
          if (!data || typeof data !== 'object' || Array.isArray(data)) {
            throw new Error('åç«¯è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
          }
          
          // è¿”å›ç»“æ„åŒ–çš„ç»“æœï¼šç¬¬ä¸€éƒ¨åˆ† - æ€è€ƒè¿‡ç¨‹ï¼Œç¬¬äºŒéƒ¨åˆ† - æœ€ç»ˆç»“æœ
          return {
            reasoning_content: (data.reasoning_content && typeof data.reasoning_content === 'string') ? data.reasoning_content : null, // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€è€ƒè¿‡ç¨‹
            content: (data.content && typeof data.content === 'string') ? data.content : null,                     // ç¬¬äºŒéƒ¨åˆ†ï¼šæœ€ç»ˆç»“æœ
            success: true
          };

        } catch (error) {
          // ç»Ÿä¸€é”™è¯¯å¤„ç†
          let errorMessage = "è§£è¯»å¤±è´¥";
          if (error.name === "AbortError" || error.name === "TimeoutError") {
            errorMessage = "è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•";
          } else if (error.message) {
            errorMessage = error.message;
          } else if (error instanceof TypeError && error.message.includes("fetch")) {
            errorMessage = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ";
          }
          
          throw new Error(errorMessage);
        }
      }

      // ========== ä¹¦ç±é‡æ„åŠŸèƒ½ ==========
      let restructureBook = null;
      let restructureChapters = [];
      let restructuredTocContent = null; // å­˜å‚¨é‡æ„åçš„ç›®å½•å†…å®¹
      let newBookStructure = null; // å­˜å‚¨æ–°ä¹¦ç±ç»“æ„

      // ä¸ºä¹¦ç±é‡æ„åŠ è½½ä¹¦ç±åˆ—è¡¨
      async function loadBooksForRestructure() {
        const restructureBookSelect = document.getElementById("restructureBookSelect");
        if (!restructureBookSelect) return;

        try {
          const response = await fetch("/api/admin/books?page=1&per_page=100");
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }

          const booksList = data.books || [];
          restructureBookSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>';
          booksList.forEach((book) => {
            const option = document.createElement("option");
            option.value = book.id;
            option.textContent = `${book.filename} (${book.chapter_count}ç« )`;
            restructureBookSelect.appendChild(option);
          });
        } catch (error) {
          console.error("åŠ è½½ä¹¦ç±å¤±è´¥:", error);
          const restructureStatus = document.getElementById("restructureStatus");
          if (restructureStatus) {
            renderStatus(restructureStatus, `åŠ è½½ä¹¦ç±å¤±è´¥: ${error.message}`, "error");
          }
        }
      }

      // ä¹¦ç±é€‰æ‹©å˜åŒ–äº‹ä»¶
      const restructureBookSelect = document.getElementById("restructureBookSelect");
      if (restructureBookSelect) {
        restructureBookSelect.addEventListener("change", async (e) => {
          const bookId = e.target.value;
          const restructureTocButton = document.getElementById("restructureTocButton");
          const restructureStatus = document.getElementById("restructureStatus");
          
          if (bookId) {
            try {
              const response = await fetch(`/api/admin/books/${bookId}`);
              const data = await response.json();
              if (data.error) {
                throw new Error(data.error);
              }

              restructureBook = data.book;
              restructureChapters = data.chapters || [];
              
              // å¯ç”¨é‡æ„ç›®å½•æŒ‰é’®
              if (restructureTocButton) {
                restructureTocButton.disabled = false;
              }
              
              if (restructureStatus) {
                renderStatus(restructureStatus, `å·²åŠ è½½ä¹¦ç±ï¼š${restructureBook.filename} (${restructureChapters.length}ç« )`, "success");
              }
            } catch (error) {
              console.error("åŠ è½½ä¹¦ç±ç« èŠ‚å¤±è´¥:", error);
              if (restructureStatus) {
                renderStatus(restructureStatus, `åŠ è½½å¤±è´¥: ${error.message}`, "error");
              }
            }
          } else {
            restructureBook = null;
            restructureChapters = [];
            if (restructureTocButton) {
              restructureTocButton.disabled = true;
            }
          }
        });
      }

      // é‡æ„ç›®å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const restructureTocButton = document.getElementById("restructureTocButton");
      if (restructureTocButton) {
        restructureTocButton.addEventListener("click", async () => {
          if (!restructureBook || !restructureChapters || restructureChapters.length === 0) {
            const restructureStatus = document.getElementById("restructureStatus");
            if (restructureStatus) {
              renderStatus(restructureStatus, "è¯·å…ˆé€‰æ‹©ä¹¦ç±", "error");
            }
            return;
          }

          const restructurePrompt = document.getElementById("restructurePrompt");
          if (!restructurePrompt || !restructurePrompt.value.trim()) {
            const restructureStatus = document.getElementById("restructureStatus");
            if (restructureStatus) {
              renderStatus(restructureStatus, "è¯·è¾“å…¥é‡æ„æç¤ºè¯", "error");
            }
            return;
          }

          // ç¦ç”¨æŒ‰é’®
          restructureTocButton.disabled = true;
          restructureTocButton.textContent = "é‡æ„ä¸­...";
          
          const restructureResult = document.getElementById("restructureResult");
          const restructureResultContent = document.getElementById("restructureResultContent");
          const restructureStatus = document.getElementById("restructureStatus");
          const generateNewBookButton = document.getElementById("generateNewBookButton");

          if (restructureResult) {
            restructureResult.style.display = "none";
          }
          if (restructureStatus) {
            renderStatus(restructureStatus, "æ­£åœ¨è¯»å–ä¹¦ç±ç›®å½•ä¸æ‘˜è¦...", "info");
          }

          try {
            // ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆç›®å½•ä¸æ‘˜è¦æ–‡æœ¬
            const tocSummaryText = generateTocSummaryText(restructureChapters);
            
            if (restructureStatus) {
              renderStatus(restructureStatus, "æ­£åœ¨è°ƒç”¨æ·±åº¦æ€è€ƒæ¨¡å‹ç”Ÿæˆæ–°ç›®å½•...", "info");
            }

            // ç¬¬äºŒæ­¥ï¼šæ„å»ºå®Œæ•´çš„æç¤ºè¯ï¼ˆç”¨æˆ·æç¤ºè¯ + åŸç›®å½•ä¸æ‘˜è¦ï¼‰
            const userPrompt = restructurePrompt.value.trim();
            // æ›¿æ¢æç¤ºè¯ä¸­çš„ {chapters} å ä½ç¬¦
            const fullPrompt = userPrompt.replace(/{chapters}/g, tocSummaryText);

            // ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨æ·±åº¦æ€è€ƒæ¨¡å‹
            const result = await interpretWithDeepThinking(
              tocSummaryText,  // content
              fullPrompt,       // prompt
              {
                replacements: {
                  chapters: tocSummaryText
                }
              }
            );

            // ä¿å­˜é‡æ„åçš„ç›®å½•å†…å®¹
            restructuredTocContent = result.content;

            // ç¬¬å››æ­¥ï¼šæ˜¾ç¤ºç»“æœ
            if (restructureResultContent) {
              // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆç»“æœ
              let resultHtml = "";
              
              // æ€è€ƒè¿‡ç¨‹
              if (result.reasoning_content) {
                resultHtml += `<div style="margin-bottom: 16px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">`;
                resultHtml += `<h5 style="margin-top: 0; margin-bottom: 12px; color: #1e40af; font-size: 15px; font-weight: 600;">ğŸ§  æ€è€ƒè¿‡ç¨‹</h5>`;
                resultHtml += `<div style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; font-size: 14px; max-height: 300px; overflow-y: auto; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #bfdbfe;">${escapeHtml(result.reasoning_content)}</div>`;
                resultHtml += `</div>`;
              }
              
              // æœ€ç»ˆç»“æœï¼ˆé‡æ„åçš„ç›®å½•ï¼‰
              if (result.content) {
                resultHtml += `<div style="padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">`;
                resultHtml += `<h5 style="margin-top: 0; margin-bottom: 12px; color: #065f46; font-size: 15px; font-weight: 600;">âœ… é‡æ„åçš„ç›®å½•</h5>`;
                resultHtml += `<div style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; font-size: 14px; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #86efac;">${escapeHtml(result.content)}</div>`;
                resultHtml += `</div>`;
              } else {
                resultHtml += `<div style="padding: 12px; background: #fee2e2; border-radius: 6px; border-left: 3px solid #ef4444;">`;
                resultHtml += `<p style="color: #991b1b; margin: 0;">âŒ æœªè·å–åˆ°é‡æ„ç»“æœ</p>`;
                resultHtml += `</div>`;
              }
              
              restructureResultContent.innerHTML = resultHtml;
            }

            if (restructureResult) {
              restructureResult.style.display = "block";
            }
            
            // å¯ç”¨æ–°ä¹¦ç”ŸæˆæŒ‰é’®
            if (generateNewBookButton && result.content) {
              generateNewBookButton.disabled = false;
            }
            
            if (restructureStatus) {
              renderStatus(restructureStatus, "ç›®å½•é‡æ„å®Œæˆï¼å¯ä»¥ç‚¹å‡»ã€æ–°ä¹¦ç”Ÿæˆã€‘æŒ‰é’®ç”Ÿæˆæ–°ä¹¦", "success");
            }
          } catch (error) {
            console.error("é‡æ„ç›®å½•å¤±è´¥:", error);
            const errorMessage = error.message || "é‡æ„å¤±è´¥";
            if (restructureStatus) {
              renderStatus(restructureStatus, `é‡æ„å¤±è´¥: ${errorMessage}`, "error");
            }
            if (restructureResultContent) {
              restructureResultContent.innerHTML = `<p style='color: #ef4444;'>${escapeHtml(errorMessage)}</p>`;
            }
            if (restructureResult) {
              restructureResult.style.display = "block";
            }
          } finally {
            // æ¢å¤æŒ‰é’®
            restructureTocButton.disabled = false;
            restructureTocButton.textContent = "ğŸ”„ é‡æ„ç›®å½•";
          }
        });
      }

      /**
       * è§£ææ–°ç›®å½•ç»“æ„ï¼Œæå–PART1, PART2ç­‰ç« èŠ‚ä¿¡æ¯
       * @param {string} tocText - é‡æ„åçš„ç›®å½•æ–‡æœ¬
       * @returns {Array} ç« èŠ‚æ•°ç»„ï¼ŒåŒ…å« {title: string, partNumber: number, coveredChapters: Array, summary: string}
       */
      function parseNewTocStructure(tocText) {
        if (!tocText) {
          console.warn("parseNewTocStructure: tocText ä¸ºç©º");
          return [];
        }
        
        console.log("å¼€å§‹è§£æç›®å½•ç»“æ„ï¼ŒåŸå§‹æ–‡æœ¬é•¿åº¦:", tocText.length);
        console.log("åŸå§‹æ–‡æœ¬é¢„è§ˆ:", tocText.substring(0, 500));
        
        const parts = [];
        const lines = tocText.split('\n');
        let currentPart = null;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const trimmedLine = line.trim();
          
          // è·³è¿‡ç©ºè¡Œ
          if (!trimmedLine) continue;
          
          // åŒ¹é… Part 1ï¼šæ ‡é¢˜ æˆ– Part 1: æ ‡é¢˜ æˆ– PART 1ï¼šæ ‡é¢˜ï¼ˆæ”¯æŒå¤§å°å†™ã€ä¸­è‹±æ–‡å†’å·ã€å¯èƒ½çš„å‰åç©ºæ ¼ï¼‰
          const partMatch = trimmedLine.match(/^(?:Part|PART|éƒ¨åˆ†|ç¬¬\s*)?\s*(\d+)[ï¼š:ï¼š]\s*(.+)$/i);
          if (partMatch) {
            // ä¿å­˜ä¸Šä¸€ä¸ªpart
            if (currentPart) {
              console.log(`ä¿å­˜ Part ${currentPart.partNumber}:`, currentPart);
              parts.push(currentPart);
            }
            // åˆ›å»ºæ–°çš„part
            const partNumber = parseInt(partMatch[1]);
            const title = partMatch[2].trim();
            currentPart = {
              partNumber: partNumber,
              title: title,
              coveredChapters: [],
              summary: ""
            };
            console.log(`å‘ç°æ–° Part ${partNumber}: ${title}`);
            continue;
          }
          
          // åŒ¹é…"è¦†ç›–ç« èŠ‚ï¼š"æˆ–"è¦†ç›–ç« èŠ‚:"ï¼ˆæ”¯æŒå‰é¢æœ‰ç¼©è¿›æˆ–ç©ºæ ¼ï¼‰
          if (currentPart) {
            const coveredMatch = trimmedLine.match(/è¦†ç›–ç« èŠ‚[ï¼š:ï¼š]\s*(.+)$/);
            if (coveredMatch) {
              const chapterText = coveredMatch[1].trim();
              // æå–ç« èŠ‚ç¼–å·ï¼Œæ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šé€—å·ã€é¡¿å·ã€ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ç­‰
              const chapterNumbers = chapterText
                .split(/[ï¼Œ,ã€\s\t]+/)  // æ”¯æŒé€—å·ã€é¡¿å·ã€ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦åˆ†éš”
                .map(n => {
                  // ç§»é™¤å¯èƒ½çš„æ‹¬å·ã€å¼•å·ç­‰
                  const cleaned = n.replace(/[ï¼ˆï¼‰()\[\]ã€ã€‘""''ã€,ï¼Œ]/g, '').trim();
                  const num = parseInt(cleaned);
                  return isNaN(num) ? null : num;
                })
                .filter(n => n !== null && n > 0);
              
              currentPart.coveredChapters = chapterNumbers;
              console.log(`Part ${currentPart.partNumber} è¦†ç›–ç« èŠ‚:`, chapterNumbers);
              continue;
            }
          }
          
          // åŒ¹é…"æ‘˜è¦ï¼š"æˆ–"æ‘˜è¦:"ï¼ˆæ”¯æŒå‰é¢æœ‰ç¼©è¿›æˆ–ç©ºæ ¼ï¼‰
          if (currentPart) {
            const summaryMatch = trimmedLine.match(/æ‘˜è¦[ï¼š:ï¼š]\s*(.+)$/);
            if (summaryMatch) {
              currentPart.summary = summaryMatch[1].trim();
              console.log(`Part ${currentPart.partNumber} æ‘˜è¦:`, currentPart.summary.substring(0, 50) + '...');
              continue;
            }
          }
          
          // å¦‚æœå½“å‰æœ‰partï¼Œä¸”ä¸æ˜¯Partå¼€å¤´ï¼Œå¯èƒ½æ˜¯æ‘˜è¦çš„ç»­è¡Œï¼ˆéœ€è¦æ›´æ™ºèƒ½çš„åˆ¤æ–­ï¼‰
          if (currentPart && !trimmedLine.match(/^(?:Part|PART|éƒ¨åˆ†|ç¬¬\s*)\s*\d+/i)) {
            // å¦‚æœå·²ç»æœ‰æ‘˜è¦å†…å®¹ï¼Œä¸”è¿™è¡Œä¸æ˜¯"è¦†ç›–ç« èŠ‚"ï¼Œåˆ™ä½œä¸ºæ‘˜è¦ç»­è¡Œ
            if (currentPart.summary || (!trimmedLine.match(/è¦†ç›–ç« èŠ‚[ï¼š:ï¼š]/))) {
              // å¦‚æœè¿™è¡Œä¸æ˜¯æ–°çš„Partå¼€å¤´ï¼Œå¯èƒ½æ˜¯æ‘˜è¦çš„ç»­è¡Œ
              if (!trimmedLine.match(/^(?:Part|PART|éƒ¨åˆ†|ç¬¬\s*)\s*\d+/i)) {
                if (currentPart.summary) {
                  currentPart.summary += '\n' + trimmedLine;
                } else {
                  // å¦‚æœè¿˜æ²¡æœ‰è®¾ç½®æ‘˜è¦ï¼Œå¯èƒ½æ˜¯æ‘˜è¦çš„ç¬¬ä¸€è¡Œï¼ˆæ²¡æœ‰"æ‘˜è¦ï¼š"æ ‡è®°ï¼‰
                  // ä½†åªæœ‰åœ¨è¿™è¡Œçœ‹èµ·æ¥ä¸åƒå…¶ä»–æ ¼å¼æ—¶æ‰ä½œä¸ºæ‘˜è¦
                  if (!trimmedLine.match(/è¦†ç›–ç« èŠ‚[ï¼š:ï¼š]/) && 
                      !trimmedLine.match(/^\d+[\.ã€]/)) { // ä¸æ˜¯æ•°å­—å¼€å¤´çš„åˆ—è¡¨é¡¹
                    currentPart.summary = trimmedLine;
                  }
                }
              }
            }
          }
        }
        
        // ä¿å­˜æœ€åä¸€ä¸ªpart
        if (currentPart) {
          console.log(`ä¿å­˜æœ€åä¸€ä¸ª Part ${currentPart.partNumber}:`, currentPart);
          parts.push(currentPart);
        }
        
        const sortedParts = parts.sort((a, b) => a.partNumber - b.partNumber);
        console.log(`è§£æå®Œæˆï¼Œå…±æ‰¾åˆ° ${sortedParts.length} ä¸ªéƒ¨åˆ†:`, sortedParts.map(p => `Part ${p.partNumber}: ${p.title} (${p.coveredChapters.length}ç« )`));
        
        return sortedParts;
      }

      /**
       * æ ¹æ®æ–°ç›®å½•åŒ¹é…åŸä¹¦ç±ç« èŠ‚å†…å®¹
       * @param {Array} newParts - æ–°ç›®å½•çš„ç« èŠ‚æ•°ç»„
       * @param {Array} originalChapters - åŸä¹¦ç±çš„ç« èŠ‚æ•°ç»„
       * @returns {Array} åŒ¹é…åçš„ç« èŠ‚å†…å®¹æ•°ç»„
       */
      function matchChaptersToNewParts(newParts, originalChapters) {
        const matchedContent = [];
        
        for (const part of newParts) {
          // æ ¹æ®è¦†ç›–ç« èŠ‚ç¼–å·åŒ¹é…åŸç« èŠ‚
          let combinedContent = '';
          const matchedChapters = [];
          
          if (part.coveredChapters && part.coveredChapters.length > 0) {
            // ä½¿ç”¨æŒ‡å®šçš„ç« èŠ‚ç¼–å·
            for (const chapterNum of part.coveredChapters) {
              const chapterIndex = chapterNum - 1; // ç« èŠ‚ç¼–å·ä»1å¼€å§‹ï¼Œæ•°ç»„ç´¢å¼•ä»0å¼€å§‹
              if (chapterIndex >= 0 && chapterIndex < originalChapters.length) {
                const chapter = originalChapters[chapterIndex];
                const content = chapter.content_zh || chapter.content || '';
                if (content) {
                  combinedContent += content + '\n\n';
                  matchedChapters.push(chapter);
                }
              }
            }
          } else {
            // å¦‚æœæ²¡æœ‰æŒ‡å®šç« èŠ‚ç¼–å·ï¼Œå°è¯•æ ¹æ®æ ‡é¢˜åŒ¹é…
            const matchedChaptersByTitle = originalChapters.filter(chapter => {
              const chapterTitle = (chapter.title_zh || chapter.title || '').toLowerCase();
              const partTitle = part.title.toLowerCase();
              return chapterTitle.includes(partTitle) || partTitle.includes(chapterTitle);
            });
            
            for (const chapter of matchedChaptersByTitle) {
              const content = chapter.content_zh || chapter.content || '';
              if (content) {
                combinedContent += content + '\n\n';
                matchedChapters.push(chapter);
              }
            }
          }
          
          matchedContent.push({
            partNumber: part.partNumber,
            title: part.title,
            summary: part.summary || '',
            content: combinedContent.trim(),
            originalChapters: matchedChapters,
            coveredChapters: part.coveredChapters || []
          });
        }
        
        return matchedContent;
      }

      /**
       * è°ƒç”¨å•æ®µæ–‡ç« åˆ†å‰²æ¥å£
       * @param {string} title - ç« èŠ‚æ ‡é¢˜
       * @param {string} content - ç« èŠ‚å†…å®¹
       * @param {number} maxWordCount - æœ€å¤§å­—æ•°
       * @returns {Promise<Array>} åˆ†å‰²åçš„æ®µè½æ•°ç»„
       */
      async function splitChapterContent(title, content, maxWordCount) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†é’Ÿè¶…æ—¶
        
        try {
          const response = await fetch("/api/restructure/split-chapter", {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "Accept": "application/json"
            },
            body: JSON.stringify({
              title: title || "æœªå‘½åç« èŠ‚",
              content: content.trim(),
              max_word_count: maxWordCount,
              word_count: 0 // åç«¯ä¼šè‡ªåŠ¨è®¡ç®—
            }),
            signal: controller.signal,
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            let errorMessage = `åˆ†å‰²å¤±è´¥ (çŠ¶æ€ç : ${response.status})`;
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              // å¦‚æœæ— æ³•è¯»å–å“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯æ¶ˆæ¯
            }
            throw new Error(errorMessage);
          }
          
          let splitResult;
          try {
            splitResult = await response.json();
          } catch (jsonError) {
            throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ${jsonError.message}`);
          }
          
          const segments = splitResult.segments || [];
          
          if (segments.length === 0) {
            throw new Error("åˆ†å‰²å¤±è´¥ï¼Œæœªç”Ÿæˆä»»ä½•ç‰‡æ®µ");
          }
          
          // æ ¼å¼åŒ–è¿”å›ç»“æœ
          return segments.map((segment, index) => ({
            title: segment.title || `ç¬¬${index + 1}éƒ¨åˆ†`,
            content: segment.content || "",
            word_count: segment.word_count || 0
          }));
          
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === "AbortError") {
            throw new Error("è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡10åˆ†é’Ÿï¼‰ï¼Œè¯·ç¨åé‡è¯•æˆ–å‡å°‘æ–‡ç« é•¿åº¦");
          }
          const errorMsg = fetchError.message || String(fetchError);
          if (errorMsg.includes("Failed to fetch") || errorMsg.includes("NetworkError")) {
            throw new Error("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ");
          }
          throw fetchError;
        }
      }

      // æ–°ä¹¦ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const generateNewBookButton = document.getElementById("generateNewBookButton");
      if (generateNewBookButton) {
        generateNewBookButton.addEventListener("click", async () => {
          if (!restructuredTocContent) {
            const restructureStatus = document.getElementById("restructureStatus");
            if (restructureStatus) {
              renderStatus(restructureStatus, "è¯·å…ˆå®Œæˆç›®å½•é‡æ„", "error");
            }
            return;
          }

          const restructureMaxWords = document.getElementById("restructureMaxWords");
          const maxWordCount = parseInt(restructureMaxWords?.value || "5000");
          
          if (isNaN(maxWordCount) || maxWordCount <= 0) {
            const restructureStatus = document.getElementById("restructureStatus");
            if (restructureStatus) {
              renderStatus(restructureStatus, "åˆ†å‰²å­—æ•°ä¸Šé™è®¾ç½®æ— æ•ˆ", "error");
            }
            return;
          }

          // ç¦ç”¨æŒ‰é’®
          generateNewBookButton.disabled = true;
          generateNewBookButton.textContent = "ç”Ÿæˆä¸­...";
          
          const restructureStatus = document.getElementById("restructureStatus");
          const newBookResult = document.getElementById("newBookResult");
          const newBookResultContent = document.getElementById("newBookResultContent");

          if (newBookResult) {
            newBookResult.style.display = "none";
          }
          if (restructureStatus) {
            renderStatus(restructureStatus, "å¼€å§‹ç”Ÿæˆæ–°ä¹¦...", "info");
          }

          try {
            // ç¬¬ä¸€æ­¥ï¼šè§£ææ–°ç›®å½•ç»“æ„
            if (restructureStatus) {
              renderStatus(restructureStatus, "æ­£åœ¨è§£ææ–°ç›®å½•ç»“æ„...", "info");
            }
            
            console.log("å¼€å§‹è§£ææ–°ç›®å½•ç»“æ„ï¼Œå†…å®¹:", restructuredTocContent);
            const newParts = parseNewTocStructure(restructuredTocContent);
            
            if (newParts.length === 0) {
              // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
              const preview = restructuredTocContent.substring(0, 200);
              const errorMsg = `æ— æ³•è§£ææ–°ç›®å½•ç»“æ„ã€‚\n\n` +
                `æœŸæœ›æ ¼å¼ï¼š\n` +
                `Part 1ï¼šæ ‡é¢˜\n` +
                `    è¦†ç›–ç« èŠ‚ï¼š1,2,3\n` +
                `    æ‘˜è¦ï¼š...\n\n` +
                `å®é™…å†…å®¹é¢„è§ˆï¼š\n${preview}\n\n` +
                `è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†è§£ææ—¥å¿—ã€‚`;
              console.error("è§£æå¤±è´¥ï¼ŒåŸå§‹å†…å®¹:", restructuredTocContent);
              throw new Error(errorMsg);
            }
            
            // æ£€æŸ¥æ¯ä¸ªpartæ˜¯å¦æœ‰è¦†ç›–ç« èŠ‚
            const partsWithoutChapters = newParts.filter(p => !p.coveredChapters || p.coveredChapters.length === 0);
            if (partsWithoutChapters.length > 0) {
              console.warn("ä»¥ä¸‹éƒ¨åˆ†æ²¡æœ‰æ‰¾åˆ°è¦†ç›–ç« èŠ‚:", partsWithoutChapters.map(p => `Part ${p.partNumber}: ${p.title}`));
              // è¿™ä¸ç®—è‡´å‘½é”™è¯¯ï¼Œå¯ä»¥ç»§ç»­å¤„ç†
            }

            // ç¬¬äºŒæ­¥ï¼šåŒ¹é…åŸä¹¦ç±ç« èŠ‚å†…å®¹åˆ°æ–°ç›®å½•
            if (restructureStatus) {
              renderStatus(restructureStatus, `æ­£åœ¨åŒ¹é…åŸä¹¦ç±ç« èŠ‚åˆ°æ–°ç›®å½•ï¼ˆ${newParts.length}ä¸ªéƒ¨åˆ†ï¼‰...`, "info");
            }
            const matchedContent = matchChaptersToNewParts(newParts, restructureChapters);

            // ç¬¬ä¸‰æ­¥ï¼šé€ç« å¤„ç† - åˆå¹¶å†…å®¹å¹¶åˆ†å‰²
            const newBookChapters = [];
            
            for (let i = 0; i < matchedContent.length; i++) {
              const part = matchedContent[i];
              
              if (restructureStatus) {
                renderStatus(restructureStatus, `æ­£åœ¨å¤„ç†ç¬¬ ${i + 1}/${matchedContent.length} éƒ¨åˆ†ï¼š${part.title}...`, "info");
              }

              // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œè·³è¿‡
              if (!part.content || part.content.trim().length === 0) {
                newBookChapters.push({
                  partNumber: part.partNumber,
                  title: part.title,
                  summary: part.summary,
                  segments: [{
                    title: part.title,
                    content: "[è¯¥éƒ¨åˆ†æš‚æ— å†…å®¹]",
                    word_count: 0
                  }]
                });
                continue;
              }

              try {
                // è°ƒç”¨åˆ†å‰²æ¥å£
                const segments = await splitChapterContent(part.title, part.content, maxWordCount);
                
                newBookChapters.push({
                  partNumber: part.partNumber,
                  title: part.title,
                  summary: part.summary,
                  segments: segments
                });

                if (restructureStatus) {
                  renderStatus(restructureStatus, `ç¬¬ ${i + 1} éƒ¨åˆ†å®Œæˆï¼š${segments.length} ä¸ªæ®µè½`, "info");
                }
              } catch (error) {
                console.error(`å¤„ç†ç¬¬ ${i + 1} éƒ¨åˆ†å¤±è´¥:`, error);
                // å¦‚æœåˆ†å‰²å¤±è´¥ï¼Œä»ç„¶ä¿ç•™åŸå†…å®¹
                newBookChapters.push({
                  partNumber: part.partNumber,
                  title: part.title,
                  summary: part.summary,
                  segments: [{
                    title: part.title,
                    content: part.content,
                    word_count: part.content.length,
                    error: error.message
                  }]
                });
              }
            }

            // ä¿å­˜æ–°ä¹¦ç±ç»“æ„
            newBookStructure = {
              originalBook: restructureBook,
              newToc: restructuredTocContent,
              chapters: newBookChapters,
              maxWordCount: maxWordCount,
              generatedAt: new Date().toISOString()
            };

            // ç¬¬å››æ­¥ï¼šæ˜¾ç¤ºæ–°ä¹¦ç»“æ„
            if (newBookResultContent) {
              let resultHtml = `<div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6;">`;
              resultHtml += `<h4 style="margin: 0 0 8px 0; color: #1e40af;">ğŸ“š æ–°ä¹¦ç»“æ„</h4>`;
              resultHtml += `<div style="font-size: 13px; color: #475569;">`;
              resultHtml += `<div>åŸä¹¦ç±ï¼š${restructureBook?.filename || 'æœªçŸ¥'}</div>`;
              resultHtml += `<div>æ–°ä¹¦ç±éƒ¨åˆ†æ•°ï¼š${newBookChapters.length}</div>`;
              resultHtml += `<div>åˆ†å‰²å­—æ•°ä¸Šé™ï¼š${maxWordCount}å­—</div>`;
              resultHtml += `<div>ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</div>`;
              resultHtml += `</div></div>`;

              // æ˜¾ç¤ºæ¯ä¸ªéƒ¨åˆ†çš„è¯¦ç»†ä¿¡æ¯
              for (const chapter of newBookChapters) {
                resultHtml += `<div style="margin-bottom: 20px; padding: 16px; background: #ffffff; border-radius: 8px; border: 1px solid #e2e8f0;">`;
                resultHtml += `<h5 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; font-weight: 600;">Part ${chapter.partNumber}ï¼š${escapeHtml(chapter.title)}</h5>`;
                if (chapter.summary) {
                  resultHtml += `<div style="font-size: 13px; color: #64748b; margin-bottom: 12px; padding: 8px; background: #f8fafc; border-radius: 4px;">æ‘˜è¦ï¼š${escapeHtml(chapter.summary)}</div>`;
                }
                resultHtml += `<div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">åŒ…å« ${chapter.segments.length} ä¸ªæ®µè½</div>`;
                
                // æ˜¾ç¤ºæ¯ä¸ªæ®µè½
                for (let j = 0; j < chapter.segments.length; j++) {
                  const segment = chapter.segments[j];
                  resultHtml += `<div style="margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #cbd5e1;">`;
                  resultHtml += `<div style="font-weight: 600; color: #475569; margin-bottom: 6px;">æ®µè½ ${j + 1}ï¼š${escapeHtml(segment.title)}</div>`;
                  if (segment.word_count > 0) {
                    resultHtml += `<div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">å­—æ•°ï¼š${segment.word_count.toLocaleString()} å­—</div>`;
                  }
                  if (segment.error) {
                    resultHtml += `<div style="font-size: 12px; color: #ef4444; margin-bottom: 8px;">âš ï¸ åˆ†å‰²å¤±è´¥ï¼š${escapeHtml(segment.error)}</div>`;
                  }
                  resultHtml += `<div style="font-size: 13px; color: #64748b; max-height: 100px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6;">${escapeHtml(segment.content.substring(0, 500))}${segment.content.length > 500 ? '...' : ''}</div>`;
                  resultHtml += `</div>`;
                }
                
                resultHtml += `</div>`;
              }

              newBookResultContent.innerHTML = resultHtml;
            }

            if (newBookResult) {
              newBookResult.style.display = "block";
            }
            if (restructureStatus) {
              renderStatus(restructureStatus, `æ–°ä¹¦ç”Ÿæˆå®Œæˆï¼å…± ${newBookChapters.length} ä¸ªéƒ¨åˆ†`, "success");
            }
          } catch (error) {
            console.error("ç”Ÿæˆæ–°ä¹¦å¤±è´¥:", error);
            const errorMessage = error.message || "ç”Ÿæˆå¤±è´¥";
            if (restructureStatus) {
              renderStatus(restructureStatus, `ç”Ÿæˆå¤±è´¥: ${errorMessage}`, "error");
            }
            if (newBookResultContent) {
              newBookResultContent.innerHTML = `<p style='color: #ef4444;'>${escapeHtml(errorMessage)}</p>`;
            }
            if (newBookResult) {
              newBookResult.style.display = "block";
            }
          } finally {
            // æ¢å¤æŒ‰é’®
            generateNewBookButton.disabled = false;
            generateNewBookButton.textContent = "ğŸ“– æ–°ä¹¦ç”Ÿæˆ";
          }
        });
      }

      // è‡ªåŠ¨é«˜äº®å½“å‰é¡µé¢çš„å¯¼èˆªé“¾æ¥
      function highlightCurrentNav() {
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-link').forEach(link => {
          if (link.getAttribute('href') === currentPath || 
              (currentPath === '/' && link.getAttribute('href') === '/') ||
              (currentPath !== '/' && currentPath.endsWith(link.getAttribute('href'))) ||
              link.getAttribute('href').includes(currentPath)) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      }

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", () => {
        // è®¾ç½®é»˜è®¤æç¤ºè¯
        const restructurePrompt = document.getElementById("restructurePrompt");
        if (restructurePrompt) {
          restructurePrompt.value = DEFAULT_RESTRUCTURE_PROMPT;
        }
        
        // åŠ è½½ä¹¦ç±åˆ—è¡¨
        loadBooksForRestructure();
        
        // é«˜äº®å¯¼èˆª
        highlightCurrentNav();
      });
    </script>
  </body>
</html>

