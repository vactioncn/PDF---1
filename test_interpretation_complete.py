#!/usr/bin/env python3
"""
å®Œæ•´æµ‹è¯•è§£è¯»ç”Ÿæˆæµç¨‹
æ¨¡æ‹Ÿå®é™…è°ƒç”¨ï¼Œæ£€æŸ¥æ€è€ƒè¿‡ç¨‹æ˜¯å¦æ­£ç¡®æå–
"""
import os
import sys
import json
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

try:
    from volcenginesdkarkruntime import Ark
    ARK_SDK_AVAILABLE = True
except ImportError:
    ARK_SDK_AVAILABLE = False
    print("âŒ volcenginesdkarkruntime SDK æœªå®‰è£…")
    sys.exit(1)

def test_interpretation_with_thinking():
    """æµ‹è¯•è§£è¯»ç”Ÿæˆï¼Œæ£€æŸ¥æ€è€ƒè¿‡ç¨‹"""
    
    api_key = os.environ.get("ARK_API_KEY") or os.environ.get("DOUBAO_API_KEY")
    if not api_key:
        print("âŒ æœªæ‰¾åˆ° ARK_API_KEY æˆ– DOUBAO_API_KEY")
        return False
    
    print("="*80)
    print("å®Œæ•´è§£è¯»ç”Ÿæˆæµ‹è¯•ï¼ˆæ£€æŸ¥æ·±åº¦æ€è€ƒè¿‡ç¨‹ï¼‰")
    print("="*80)
    
    # æ¨¡æ‹Ÿå®é™…çš„è§£è¯»æç¤ºè¯ï¼ˆä»æ•°æ®åº“ä¸­è¯»å–çš„æ ¼å¼ï¼‰
    system_message = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„JSONæ ¼å¼è¾“å‡ºåŠ©æ‰‹ï¼Œä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å¼ã€‚

ã€å…³é”®è¦æ±‚ã€‘
- **é‡è¦**ï¼šä½ å¿…é¡»å…ˆå±•ç¤ºä½ çš„è¯¦ç»†æ€è€ƒè¿‡ç¨‹ï¼ˆä½¿ç”¨ <thinking>...</thinking> æ ‡ç­¾åŒ…è£¹ï¼‰ï¼Œç„¶åå†è¾“å‡ºJSON
- æ€è€ƒè¿‡ç¨‹åº”è¯¥è¯¦ç»†ã€å®Œæ•´ï¼ŒåŒ…æ‹¬å¦‚ä½•ç†è§£éœ€æ±‚ã€å¦‚ä½•ç»„ç»‡å†…å®¹ç­‰
- æœ€ç»ˆè¾“å‡ºå¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–çš„è¯´æ˜æ–‡å­—ã€markdownæ ‡è®°æˆ–æ³¨é‡Š
- JSONè¾“å‡ºçš„ç¬¬ä¸€ä¸ªå­—ç¬¦å¿…é¡»æ˜¯ {ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦å¿…é¡»æ˜¯ }
- ä¸è¦ä½¿ç”¨ ```json æˆ– ``` ç­‰markdownä»£ç å—æ ‡è®°
- ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·æç¤ºè¯çš„è¦æ±‚ç”Ÿæˆå†…å®¹"""

    # æ¨¡æ‹Ÿå®é™…çš„ç”¨æˆ·æç¤ºè¯ï¼ˆè§£è¯»æç¤ºè¯ï¼‰
    user_prompt = """ä½ æ˜¯"é˜…è¯»ä¸€æœ¬é€š"çš„ AI è®²ä¹¦åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡ä¸æ˜¯æ€»ç»“ï¼Œè€Œæ˜¯æŠŠå†…å®¹è®²æ‡‚ï¼šç”¨æœ´å®ã€æ¸…æ™°ã€é€»è¾‘é¡ºçš„æ–¹å¼ï¼Œåƒä¸€ä½è€å¿ƒçš„è®²ä¹¦è€å¸ˆï¼ŒæŠŠä¹¦è®²å¾—è®©ç”¨æˆ·å¬æ‡‚ã€ç”¨å¾—ä¸Šã€‚

ä½ çš„è®²è§£é£æ ¼ï¼š
è‰¾æ€å¥‡ï¼šæœ´å®ã€é€»è¾‘æ¸…æ¥šã€ä¸è£…ï¼›
è´¹æ›¼ï¼šæŠŠå¤æ‚å†…å®¹è®²åˆ°ä¸­å­¦ç”Ÿéƒ½èƒ½å¬æ‡‚ï¼›
æœ‰ä¾‹å­ã€æœ‰æ¨ç†ã€æœ‰"è®²æ•…äº‹æ„Ÿ"ã€‚

ä¸€ã€è¾“å…¥æ ¼å¼ï¼ˆæ¥è‡ªç³»ç»Ÿï¼‰
ä½ ä¼šæ”¶åˆ°ä»¥ä¸‹è¾“å…¥ï¼ˆç»“æ„å›ºå®šï¼‰ï¼š
{
  "user_profile": {
    "profession": "CEO",
    "reading_goal": "æå‡ç®¡ç†æŠ€èƒ½",
    "focus_preference": "å¯è½åœ°çš„åº”ç”¨æ¡ˆä¾‹",
    "explanation_density": "30% æ ¸å¿ƒ"
  },
  "chapter_summary": "è¿™æ˜¯æµ‹è¯•ç« èŠ‚æ‘˜è¦ï¼šå…³äºå¦‚ä½•é€šè¿‡æ·±åº¦æ€è€ƒæ¥è§£å†³é—®é¢˜ã€‚",
  "chapter_fulltext": "è¿™æ˜¯æµ‹è¯•ç« èŠ‚çš„å®Œæ•´å†…å®¹ã€‚æ·±åº¦æ€è€ƒæ˜¯ä¸€ç§ç³»ç»Ÿæ€§çš„æ€ç»´æ–¹å¼ï¼Œå®ƒè¦æ±‚æˆ‘ä»¬ä¸ä»…ä»…çœ‹åˆ°è¡¨é¢ç°è±¡ï¼Œè¿˜è¦æ·±å…¥åˆ†æé—®é¢˜çš„æœ¬è´¨ã€‚å¯¹äºCEOæ¥è¯´ï¼Œæ·±åº¦æ€è€ƒå¯ä»¥å¸®åŠ©åšå‡ºæ›´å¥½çš„æˆ˜ç•¥å†³ç­–ã€‚"
}

è¯´æ˜ï¼š
explanation_density å°†ç›´æ¥å†³å®šè®²è§£çš„å¯†åº¦ï¼Œåªä¼šå‡ºç°ä¸‰ç§ï¼š
"20% ä¸»å¹²"
"30% æ ¸å¿ƒ"
"50% æ·±åº¦"
ä½ å¿…é¡»ä¸¥æ ¼ä¾ç…§æ­¤å¯†åº¦æ§åˆ¶è®²è§£çš„ä¿¡æ¯é‡ã€‚

äºŒã€ä½ çš„ä»»åŠ¡ï¼ˆå¿…é¡»æŒ‰é¡ºåºå®Œæˆ 5 ä¸ªéƒ¨åˆ†ï¼‰
æœ€ç»ˆè¾“å‡ºåŒ…å«äº”éƒ¨åˆ†ï¼Œè¯·ä¸¥æ ¼æŒ‰é¡ºåºå’Œç»“æ„è¾“å‡ºï¼š

ã€ä¸€ã€ä¸ªæ€§åŒ–å¯¼è¯»æ‘˜è¦ã€‘
ç›®æ ‡ï¼š
ç»“åˆç”¨æˆ·åå¥½ï¼ˆèŒä¸š / é˜…è¯»ç›®çš„ / å…³æ³¨ç‚¹ï¼‰+ ç« èŠ‚æ‘˜è¦ï¼Œä¸ºç”¨æˆ·ç”Ÿæˆä¸€æ®µ 150â€“300 å­—çš„"ä¸ªæ€§åŒ–å¯¼è¯»"ã€‚
è¦æ±‚ï¼š
æ¸…æ¥šå‘Šè¯‰ç”¨æˆ·ï¼š
è¿™ä¸€èŠ‚åœ¨è®²ä»€ä¹ˆï¼›
å’Œä»–ï¼ˆä¾‹å¦‚ CEOï¼‰æœ‰ä»€ä¹ˆå…³ç³»ï¼›
å¯¹ä»–çš„é˜…è¯»ç›®æ ‡ï¼ˆå¦‚ï¼šæå‡ç®¡ç†æŠ€èƒ½ï¼‰æœ‰ä»€ä¹ˆä»·å€¼ï¼›
ä¸ºä»€ä¹ˆå€¼å¾—è¯»ã€‚
è¯­è¨€å£è¯­åŒ–ï¼Œåƒä¸€ä¸ªæœ‹å‹è€å¿ƒåœ°è¯´ï¼š
"å¦‚æœä¸€å¥è¯è®²æ˜ç™½ï¼Œè¿™ä¸€èŠ‚å…¶å®æ˜¯åœ¨è¯´â€¦â€¦"
ä¸è¦æœºæ¢°é‡å¤ç« èŠ‚æ‘˜è¦ï¼Œè¦é‡å†™ã€‚

ã€äºŒã€æ­£æ–‡è®²è§£ï¼ˆä¾ç…§ç”¨æˆ·é€‰æ‹©çš„å¯†åº¦ï¼‰ã€‘
è¯·ç”¨è‰¾æ€å¥‡ + è´¹æ›¼çš„é£æ ¼ï¼ŒæŠŠåŸæ–‡é‡æ–°è®²è§£å‡ºæ¥ã€‚
è®²è§£å†…å®¹å¯†åº¦å–å†³äº user_profile.explanation_densityï¼š
30% æ ¸å¿ƒï¼ˆå½“å‰é€‰æ‹©ï¼‰ï¼š
åœ¨ä¸»å¹²åŸºç¡€ä¸Šè¡¥å……å…³é”®ä¾‹å­ & é‡è¦ç»†èŠ‚ï¼›
æ§åˆ¶è¦ç‚¹çº¦ 4â€“6 ä¸ªã€‚

è®²è§£ç»“æ„å»ºè®®å¦‚ä¸‹ï¼ˆå¼ºåˆ¶ï¼‰ï¼š
æ•´ä½“æ¡†æ¶
2â€“4 å¥è®²æ¸…æ¥šè¿™ä¸€èŠ‚çš„ä¸»æ—¨ä¸ä½œè€…è¦å›ç­”çš„é—®é¢˜ã€‚
åˆ†ç‚¹è®²è§£
ä»¥ 4â€“6 ä¸ªè¦ç‚¹å±•å¼€ï¼ˆæ•°é‡ä¾ç…§å¯†åº¦ï¼‰ï¼›
æ¯ä¸ªè¦ç‚¹å¿…é¡»åŒ…å«ï¼š
è¿™ä¸ªè§‚ç‚¹è®²çš„æ˜¯ä»€ä¹ˆï¼›
ä½œè€…ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼ˆæ¨ç†é“¾ï¼‰ï¼›
ä¸€ä¸ªé€šä¿—ä¾‹å­æˆ–æ¯”å–»ï¼›
é¿å…åŸæ–‡ç…§æ¬ã€‚
å°ç»“
3â€“5 å¥è¯æ€»ç»“ï¼š
è¿™ä¸€èŠ‚çš„éª¨æ¶æ˜¯ä»€ä¹ˆï¼Ÿ
å“ªäº›æ˜¯å®¹æ˜“å¿½ç•¥çš„è¯¯è§£ï¼Ÿ
å¦‚æœåªèƒ½è®°ä¸¤å¥è¯ï¼Œè¯¥è®°ä»€ä¹ˆï¼Ÿ

ã€ä¸‰ã€ç°å®ç”Ÿæ´»ä¸­çš„ä¸¾ä¸€åä¸‰åº”ç”¨ã€‘
ç»“åˆç”¨æˆ·èº«ä»½ä¸é˜…è¯»ç›®æ ‡ï¼ˆå¦‚ CEOã€æå‡ç®¡ç†æŠ€èƒ½ï¼‰ï¼Œè¾“å‡º 2â€“4 ä¸ªå¯è½åœ°çš„åº”ç”¨åœºæ™¯ã€‚
æ¯ä¸ªåº”ç”¨åœºæ™¯å¿…é¡»åŒ…å«ä¸‰éƒ¨åˆ†ï¼š
ã€åœºæ™¯ã€‘
ç”¨ä¸€å¥è¯è¯´æ˜è¿™æ˜¯ç°å®ä¸­çš„ä»€ä¹ˆåœºæ™¯ï¼›
ã€æ€ä¹ˆç”¨ã€‘
ç»™å‡ºæ¸…æ™°çš„æ­¥éª¤æˆ–è¡Œä¸ºå»ºè®®ï¼Œä¸å¯ç©ºæ³›ï¼›
ã€å¯èƒ½æ•ˆæœã€‘
ç®€çŸ­æè¿°æ‰§è¡Œåå¯èƒ½å¸¦æ¥çš„æ”¹å–„ã€‚

ã€å››ã€çŸ¥è¯†ç‚¹é€‰æ‹©é¢˜ï¼ˆ3â€“5 é¢˜ï¼‰ã€‘
ä»ä½ çš„è®²è§£å†…å®¹ä¸­æŒ‘é€‰ 3â€“5 ä¸ªå…³é”®çŸ¥è¯†ç‚¹ï¼Œè®¾è®¡æˆé€‰æ‹©é¢˜ã€‚
æ¯é¢˜æ ¼å¼ï¼š
ç¬¬ X é¢˜
é¢˜å¹²ï¼šâ€¦â€¦
A. â€¦â€¦
B. â€¦â€¦
C. â€¦â€¦
D. â€¦â€¦
æ­£ç¡®ç­”æ¡ˆï¼šX
è§£æï¼šç”¨ 1â€“3 å¥è¯è§£é‡Šä¸ºä»€ä¹ˆã€‚

è¦æ±‚ï¼š
é¢˜ç›®å¿…é¡»åŸºäºä½ çš„è®²è§£ï¼ˆä¸æ˜¯åŸæ–‡ï¼Œä¹Ÿä¸æ˜¯æ‰©å±•å†…å®¹ï¼‰ï¼›
é€‰é¡¹è¦æœ‰è¿·æƒ‘æ€§ä½†ä¸æ¶æ„ï¼›
é‡ç‚¹è€ƒæ ¸æ¦‚å¿µç†è§£ä¸é€»è¾‘å…³ç³»ã€‚

ã€äº”ã€ä¸€ä¸ªæœ€å¼ºæœ‰åŠ›çš„æ€è€ƒé—®é¢˜ã€‘
ç»“åˆï¼š
ç”¨æˆ·èŒä¸šï¼ˆå¦‚ CEOï¼‰
é˜…è¯»ç›®çš„ï¼ˆæå‡ç®¡ç†æŠ€èƒ½ï¼‰
å†…å®¹æ ¸å¿ƒæ€æƒ³
æå‡º ä¸€ä¸ª æå…·åŠ›é‡çš„å¼€æ”¾å¼é—®é¢˜ã€‚
ç‰¹å¾ï¼š
æŒ‡å‘ç°å®ï¼Œè€Œä¸æ˜¯æŠ½è±¡å“²å­¦ï¼›
å¸®åŠ©ç”¨æˆ·é‡æ–°å®¡è§†è‡ªå·±çš„è¡Œä¸ºæ¨¡å¼ã€ä¹ æƒ¯æˆ–å†³ç­–ï¼›
è¦å…·ä½“åˆ°èƒ½è®©ä»–ç«‹å³äº§ç”Ÿè‡ªæˆ‘åæ€ã€‚
é¿å…ï¼š
"ä½ æœ‰ä»€ä¹ˆæ”¶è·ï¼Ÿ"è¿™ç±»æ³›æ³›ä¹‹é—®ï¼›
åŒæ—¶æå‡ºå¤šä¸ªé—®é¢˜ã€‚

ç°åœ¨è¯·æ ¹æ®ä»¥ä¸Šè¦æ±‚ï¼Œç”Ÿæˆå®Œæ•´çš„è§£è¯»å†…å®¹ã€‚è®°ä½ï¼šå…ˆå±•ç¤ºä½ çš„æ€è€ƒè¿‡ç¨‹ï¼Œç„¶åè¾“å‡ºJSONã€‚"""

    model = "doubao-seed-1-6-thinking-250715"
    base_url = "https://ark.cn-beijing.volces.com/api/v3"
    
    print(f"\nğŸ“¤ å‘é€è¯·æ±‚...")
    print(f"   æ¨¡å‹: {model}")
    print(f"   thinking: {{'type': 'enabled'}}")
    print(f"   æç¤ºè¯é•¿åº¦: {len(user_prompt)} å­—ç¬¦")
    
    try:
        client = Ark(
            base_url=base_url,
            api_key=api_key,
            timeout=1800,
        )
        
        response = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": system_message},
                {"role": "user", "content": user_prompt},
            ],
            temperature=0.3,
            max_tokens=16000,
            thinking={
                "type": "enabled"
            },
        )
        
        print("âœ… è¯·æ±‚æˆåŠŸï¼Œæ”¶åˆ°å“åº”\n")
        
        # æå–å†…å®¹
        choice = response.choices[0]
        message = choice.message
        content_text = message.content
        
        print(f"ğŸ“¥ å“åº”åˆ†æ:")
        print(f"   content ç±»å‹: {type(content_text)}")
        print(f"   content é•¿åº¦: {len(content_text) if content_text else 0} å­—ç¬¦")
        
        # æ£€æŸ¥ reasoning_content
        reasoning_content = None
        if hasattr(message, 'reasoning_content') and message.reasoning_content:
            reasoning_content = message.reasoning_content
            print(f"\nâœ… æ‰¾åˆ° reasoning_content å­—æ®µï¼")
            print(f"   ç±»å‹: {type(reasoning_content)}")
            print(f"   é•¿åº¦: {len(reasoning_content) if isinstance(reasoning_content, str) else 'N/A'} å­—ç¬¦")
            if isinstance(reasoning_content, str):
                print(f"   å‰500å­—ç¬¦:\n{reasoning_content[:500]}...\n")
        else:
            print(f"\nâŒ æœªæ‰¾åˆ° reasoning_content å­—æ®µ")
            print(f"   message çš„æ‰€æœ‰å±æ€§: {[attr for attr in dir(message) if not attr.startswith('_')]}")
        
        # æ£€æŸ¥ content ä¸­æ˜¯å¦åŒ…å«æ€è€ƒè¿‡ç¨‹
        if content_text:
            if '<thinking>' in content_text:
                print(f"\nâœ… content ä¸­åŒ…å« <thinking> æ ‡ç­¾")
            else:
                print(f"\nâš ï¸ content ä¸­ä¸åŒ…å« <thinking> æ ‡ç­¾")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ JSON
            json_start = content_text.find('{')
            if json_start > 0:
                print(f"   JSON å¼€å§‹ä½ç½®: {json_start} å­—ç¬¦")
                if json_start > 100:
                    potential_thinking = content_text[:json_start]
                    print(f"   JSON ä¹‹å‰çš„å†…å®¹ï¼ˆå¯èƒ½æ˜¯æ€è€ƒè¿‡ç¨‹ï¼Œé•¿åº¦: {len(potential_thinking)} å­—ç¬¦ï¼‰")
                    print(f"   å‰500å­—ç¬¦:\n{potential_thinking[:500]}...\n")
        
        # æ¨¡æ‹Ÿ _add_debug_info_to_result çš„å¤„ç†
        print("\n" + "="*80)
        print("æ¨¡æ‹Ÿ _add_debug_info_to_result å¤„ç†:")
        print("="*80)
        
        # å°† reasoning_content æ·»åŠ åˆ° content_text å‰é¢
        if reasoning_content and isinstance(reasoning_content, str):
            combined_content = f"<thinking>\n{reasoning_content}\n</thinking>\n\n{content_text}"
            print(f"âœ… åˆå¹¶åçš„å†…å®¹é•¿åº¦: {len(combined_content)} å­—ç¬¦")
            
            # æå–æ€è€ƒè¿‡ç¨‹
            import re
            thinking_match = re.search(r'<thinking>(.*?)</thinking>', combined_content, re.IGNORECASE | re.DOTALL)
            if thinking_match:
                extracted_thinking = thinking_match.group(1).strip()
                print(f"âœ… æˆåŠŸæå–æ€è€ƒè¿‡ç¨‹ï¼Œé•¿åº¦: {len(extracted_thinking)} å­—ç¬¦")
                print(f"   å‰500å­—ç¬¦:\n{extracted_thinking[:500]}...\n")
            else:
                print(f"âŒ æœªèƒ½ä»åˆå¹¶å†…å®¹ä¸­æå–æ€è€ƒè¿‡ç¨‹")
        else:
            print(f"âš ï¸ æ²¡æœ‰ reasoning_contentï¼Œæ— æ³•æµ‹è¯•åˆå¹¶é€»è¾‘")
        
        print("\n" + "="*80)
        print("æµ‹è¯•å®Œæˆ")
        print("="*80)
        
        return True
        
    except Exception as e:
        print(f"\nâŒ æµ‹è¯•å¤±è´¥: {type(e).__name__}: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    success = test_interpretation_with_thinking()
    sys.exit(0 if success else 1)

