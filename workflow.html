<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€ç«™å¼è§£è¯»æµç¨‹ - PDFè§£è¯»ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
        }
        .top-navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        .nav-brand {
            color: white;
            font-weight: 600;
            font-size: 18px;
            text-decoration: none;
        }
        .nav-links { display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .nav-link:hover { background: rgba(255,255,255,0.2); }
        .nav-link.active { background: rgba(255,255,255,0.25); font-weight: 500; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        .header h1 { font-size: 28px; color: #1e293b; margin-bottom: 8px; }
        .header p { color: #64748b; }

        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .steps-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        .step-dot {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border-radius: 20px;
            font-size: 14px;
            color: #94a3b8;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .step-dot.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        .step-dot.completed {
            background: #10b981;
            color: white;
            border-color: transparent;
        }
        .step-dot:hover:not(.active) { border-color: #667eea; }
        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: currentColor;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        .step-dot.active .step-num,
        .step-dot.completed .step-num { background: rgba(255,255,255,0.3); }

        /* æ­¥éª¤é¢æ¿ */
        .step-panel {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .step-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .step-panel h2 {
            font-size: 22px;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .step-panel .desc {
            color: #64748b;
            margin-bottom: 24px;
            font-size: 14px;
        }

        /* è¡¨å•å…ƒç´  */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
            font-size: 14px;
        }
        input[type="file"], select, textarea, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        textarea { min-height: 120px; resize: vertical; font-family: inherit; }

        /* æŒ‰é’® */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-secondary:hover { background: #475569; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px; }

        /* çŠ¶æ€æç¤º */
        .status {
            padding: 12px 16px;
            border-radius: 10px;
            margin-top: 16px;
            font-size: 14px;
            display: none;
        }
        .status.show { display: block; }
        .status.info { background: #eff6ff; color: #1e40af; border-left: 4px solid #3b82f6; }
        .status.success { background: #f0fdf4; color: #166534; border-left: 4px solid #22c55e; }
        .status.error { background: #fef2f2; color: #991b1b; border-left: 4px solid #ef4444; }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }
        .progress-bar.show { display: block; }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* ç”¨æˆ·åå¥½å¡ç‰‡ */
        .preference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .pref-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pref-card:hover { border-color: #667eea; background: #f8fafc; }
        .pref-card.selected { border-color: #667eea; background: #eff6ff; }
        .pref-card h4 { color: #1e293b; margin-bottom: 8px; }
        .pref-card p { font-size: 13px; color: #64748b; line-height: 1.6; }

        /* å¯†åº¦é€‰æ‹© */
        .density-options { display: flex; gap: 12px; flex-wrap: wrap; }
        .density-btn {
            flex: 1;
            min-width: 150px;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .density-btn:hover { border-color: #667eea; }
        .density-btn.selected { border-color: #667eea; background: #eff6ff; }
        .density-btn strong { display: block; color: #1e293b; margin-bottom: 4px; }
        .density-btn span { font-size: 12px; color: #64748b; }

        /* ç»“æœå±•ç¤º */
        .result-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }
        .result-box h4 { color: #1e293b; margin-bottom: 12px; }
        .markdown-content { line-height: 1.8; color: #334155; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { margin-top: 20px; margin-bottom: 10px; color: #1e293b; }
        .markdown-content p { margin-bottom: 12px; }
        .markdown-content ul, .markdown-content ol { padding-left: 24px; margin-bottom: 12px; }

        /* ç« èŠ‚åˆ—è¡¨ */
        .chapter-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-top: 12px;
        }
        .chapter-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chapter-item:last-child { border-bottom: none; }
        .chapter-item:hover { background: #f8fafc; }
        .chapter-title { font-size: 14px; color: #1e293b; }
        .chapter-words { font-size: 12px; color: #94a3b8; }

        /* æ€è€ƒè¿‡ç¨‹ */
        .thinking-box {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }
        .thinking-box h5 { color: #1e40af; margin-bottom: 8px; }
        .thinking-box pre { white-space: pre-wrap; font-size: 13px; color: #334155; line-height: 1.6; }

        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* éŸ³é¢‘æ’­æ”¾å™¨ */
        .audio-player { margin-top: 20px; }
        .audio-player audio { width: 100%; }
    </style>
</head>
<body>
    <nav class="top-navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">ğŸ“š PDFè§£è¯»ç³»ç»Ÿ</a>
            <div class="nav-links">
                <a href="/" class="nav-link">ğŸ  é¦–é¡µ</a>
                <a href="/workflow.html" class="nav-link active">ğŸš€ ä¸€ç«™å¼æµç¨‹</a>
                <a href="/aigen_test_page.html" class="nav-link">âœ¨ ä¸ªæ€§åŒ–è§£è¯»</a>
                <a href="/parser_test_page.html" class="nav-link">ğŸ“„ æ–‡æ¡£è§£æ</a>
                <a href="/admin_books.html" class="nav-link">ğŸ“– ä¹¦ç±ç®¡ç†</a>
                <a href="/flow_diagram.html" class="nav-link">ğŸ“Š æµç¨‹å›¾</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>ğŸš€ ä¸€ç«™å¼è§£è¯»æµç¨‹</h1>
            <p>ä»ä¸Šä¼ ä¹¦ç±åˆ°ç”Ÿæˆä¸ªæ€§åŒ–è§£è¯»ï¼Œä¸€æ°”å‘µæˆ</p>
        </div>

        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="steps-indicator">
            <div class="step-dot active" data-step="1">
                <span class="step-num">1</span>
                <span>ä¸Šä¼ æ–‡æ¡£</span>
            </div>
            <div class="step-dot" data-step="2">
                <span class="step-num">2</span>
                <span>è§£æç›®å½•</span>
            </div>
            <div class="step-dot" data-step="3">
                <span class="step-num">3</span>
                <span>æå–å†…å®¹</span>
            </div>
            <div class="step-dot" data-step="4">
                <span class="step-num">4</span>
                <span>å…¥åº“ä¿å­˜</span>
            </div>
            <div class="step-dot" data-step="5">
                <span class="step-num">5</span>
                <span>é€‰æ‹©ç« èŠ‚</span>
            </div>
            <div class="step-dot" data-step="6">
                <span class="step-num">6</span>
                <span>é…ç½®åå¥½</span>
            </div>
            <div class="step-dot" data-step="7">
                <span class="step-num">7</span>
                <span>ç”Ÿæˆè§£è¯»</span>
            </div>
        </div>

        <!-- æ­¥éª¤1: ä¸Šä¼ æ–‡æ¡£ -->
        <div class="step-panel active" id="step1">
            <h2>ğŸ“„ æ­¥éª¤1ï¼šä¸Šä¼ æ–‡æ¡£</h2>
            <p class="desc">é€‰æ‹©è¦è§£è¯»çš„ PDF æˆ– EPUB æ–‡ä»¶</p>
            
            <div class="form-group">
                <label>é€‰æ‹©æ–‡ä»¶</label>
                <input type="file" id="fileInput" accept=".pdf,.epub,application/pdf,application/epub+zip">
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="translateCheck" style="width: auto;">
                    <span>ç¿»è¯‘ä¸ºä¸­æ–‡ï¼ˆè‹±æ–‡ä¹¦ç±å»ºè®®å‹¾é€‰ï¼‰</span>
                </label>
            </div>

            <div class="status" id="status1"></div>
            
            <div class="btn-group">
                <button class="btn btn-primary" id="nextBtn1" disabled>
                    ä¸‹ä¸€æ­¥ï¼šè§£æç›®å½• â†’
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤2: è§£æç›®å½• -->
        <div class="step-panel" id="step2">
            <h2>ğŸ” æ­¥éª¤2ï¼šè§£æç›®å½•</h2>
            <p class="desc">ä½¿ç”¨ AI æ™ºèƒ½è¯†åˆ«å¹¶æ¸…æ´—æ–‡æ¡£ç›®å½•ç»“æ„</p>
            
            <div class="form-group">
                <label>å½“å‰æ–‡ä»¶</label>
                <input type="text" id="currentFileName" readonly>
            </div>

            <div class="status" id="status2"></div>
            <div class="progress-bar" id="progress2">
                <div class="progress-fill" style="width: 0%"></div>
            </div>

            <div class="result-box" id="tocResult" style="display: none;">
                <h4>ğŸ“‘ è¯†åˆ«åˆ°çš„ç« èŠ‚ç›®å½•</h4>
                <div class="chapter-list" id="tocList"></div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(1)">â† ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="parseTocBtn">
                    ğŸ” å¼€å§‹è§£æç›®å½•
                </button>
                <button class="btn btn-success" id="nextBtn2" disabled>
                    ä¸‹ä¸€æ­¥ï¼šæå–å†…å®¹ â†’
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤3: æå–å†…å®¹ -->
        <div class="step-panel" id="step3">
            <h2>ğŸ“‘ æ­¥éª¤3ï¼šæå–å†…å®¹</h2>
            <p class="desc">æ ¹æ®ç›®å½•ç»“æ„æå–å„ç« èŠ‚çš„å®Œæ•´å†…å®¹</p>
            
            <div class="status" id="status3"></div>
            <div class="progress-bar" id="progress3">
                <div class="progress-fill" style="width: 0%"></div>
            </div>

            <div class="result-box" id="contentResult" style="display: none;">
                <h4>ğŸ“Š æå–ç»“æœç»Ÿè®¡</h4>
                <div id="contentStats"></div>
                <div class="chapter-list" id="contentList"></div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(2)">â† ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="extractBtn">
                    ğŸ“‘ å¼€å§‹æå–å†…å®¹
                </button>
                <button class="btn btn-success" id="nextBtn3" disabled>
                    ä¸‹ä¸€æ­¥ï¼šå…¥åº“ä¿å­˜ â†’
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤4: å…¥åº“ä¿å­˜ -->
        <div class="step-panel" id="step4">
            <h2>ğŸ’¾ æ­¥éª¤4ï¼šå…¥åº“ä¿å­˜</h2>
            <p class="desc">å°†è§£æç»“æœä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨</p>
            
            <div class="status" id="status4"></div>
            <div class="progress-bar" id="progress4">
                <div class="progress-fill" style="width: 0%"></div>
            </div>

            <div class="result-box" id="ingestResult" style="display: none;">
                <h4>âœ… å…¥åº“å®Œæˆ</h4>
                <p id="ingestInfo"></p>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(3)">â† ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="ingestBtn">
                    ğŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“
                </button>
                <button class="btn btn-success" id="nextBtn4" disabled>
                    ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©ç« èŠ‚ â†’
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤5: é€‰æ‹©ç« èŠ‚ -->
        <div class="step-panel" id="step5">
            <h2>ğŸ“š æ­¥éª¤5ï¼šé€‰æ‹©ç« èŠ‚</h2>
            <p class="desc">é€‰æ‹©è¦ç”Ÿæˆè§£è¯»çš„ç« èŠ‚ï¼ˆå¯ä»å·²å…¥åº“çš„ä¹¦ç±ä¸­é€‰æ‹©ï¼‰</p>
            
            <div class="form-group">
                <label>é€‰æ‹©ä¹¦ç±</label>
                <select id="bookSelect">
                    <option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>
                </select>
            </div>

            <div class="form-group">
                <label>é€‰æ‹©ç« èŠ‚</label>
                <select id="chapterSelect" disabled>
                    <option value="">è¯·å…ˆé€‰æ‹©ä¹¦ç±</option>
                </select>
            </div>

            <div class="result-box" id="chapterPreview" style="display: none;">
                <h4>ğŸ“– ç« èŠ‚é¢„è§ˆ</h4>
                <p><strong>æ ‡é¢˜ï¼š</strong><span id="previewTitle"></span></p>
                <p><strong>å­—æ•°ï¼š</strong><span id="previewWords"></span></p>
                <p><strong>æ‘˜è¦ï¼š</strong><span id="previewSummary"></span></p>
            </div>

            <div class="status" id="status5"></div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(4)">â† ä¸Šä¸€æ­¥</button>
                <button class="btn btn-success" id="nextBtn5" disabled>
                    ä¸‹ä¸€æ­¥ï¼šé…ç½®åå¥½ â†’
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤6: é…ç½®åå¥½ -->
        <div class="step-panel" id="step6">
            <h2>ğŸ‘¤ æ­¥éª¤6ï¼šé…ç½®åå¥½</h2>
            <p class="desc">é€‰æ‹©ç”¨æˆ·ç”»åƒå’Œè§£è¯»å¯†åº¦ï¼Œå®šåˆ¶ä¸ªæ€§åŒ–è§£è¯»é£æ ¼</p>
            
            <div class="form-group">
                <label>é€‰æ‹©ç”¨æˆ·ç”»åƒ</label>
                <div class="preference-grid">
                    <div class="pref-card" data-pref="A">
                        <h4>ğŸ¢ A. åˆ›ä¸šCEO</h4>
                        <p>ç¢ç‰‡åŒ–é˜…è¯»ï¼Œå…³æ³¨å†³ç­–æ æ†å’Œå•†ä¸šæ´å¯Ÿï¼Œè¿½æ±‚å¿«é€ŸæŠ“ä½æ ¸å¿ƒè¦ç‚¹</p>
                    </div>
                    <div class="pref-card" data-pref="B">
                        <h4>ğŸ’¡ B. äº§å“ç»ç†</h4>
                        <p>æ·±åº¦é˜…è¯»ï¼Œå…³æ³¨ç”¨æˆ·å¿ƒç†å’Œäº§å“é€»è¾‘ï¼Œè¿½æ±‚ç³»ç»Ÿæ€§æ€ç»´æå‡</p>
                    </div>
                    <div class="pref-card" data-pref="C">
                        <h4>ğŸ“š C. çŸ¥è¯†å·¥ä½œè€…</h4>
                        <p>æ²‰æµ¸å¼é˜…è¯»ï¼Œå…³æ³¨çŸ¥è¯†ä½“ç³»å’Œè·¨é¢†åŸŸæ€è€ƒï¼Œè¿½æ±‚è®¤çŸ¥æ·±åº¦</p>
                    </div>
                    <div class="pref-card" data-pref="D">
                        <h4>âš¡ D. èŒåœºäººå£«</h4>
                        <p>å¿«é€Ÿé˜…è¯»ï¼Œå…³æ³¨æ ¸å¿ƒè§‚ç‚¹å’Œè¡ŒåŠ¨æ¸…å•ï¼Œè¿½æ±‚å³å­¦å³ç”¨</p>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>é€‰æ‹©è§£è¯»å¯†åº¦</label>
                <div class="density-options">
                    <button class="density-btn" data-density="20% ä¸»å¹²">
                        <strong>20% ä¸»å¹²</strong>
                        <span>åªä¿ç•™æ ¸å¿ƒç»“è®ºï¼Œ3-4ä¸ªè¦ç‚¹</span>
                    </button>
                    <button class="density-btn selected" data-density="50% æ ¸å¿ƒ">
                        <strong>50% æ ¸å¿ƒ</strong>
                        <span>è¡¥å……å…³é”®ä¾‹è¯ï¼Œ5-7ä¸ªè¦ç‚¹</span>
                    </button>
                    <button class="density-btn" data-density="70% æ·±åº¦">
                        <strong>70% æ·±åº¦</strong>
                        <span>è¦†ç›–é‡è¦åˆ†æ”¯ï¼Œ8-12ä¸ªè¦ç‚¹</span>
                    </button>
                </div>
            </div>

            <div class="status" id="status6"></div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(5)">â† ä¸Šä¸€æ­¥</button>
                <button class="btn btn-success" id="nextBtn6" disabled>
                    ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆè§£è¯» â†’
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤7: ç”Ÿæˆè§£è¯» -->
        <div class="step-panel" id="step7">
            <h2>ğŸ§  æ­¥éª¤7ï¼šç”Ÿæˆè§£è¯»</h2>
            <p class="desc">ä½¿ç”¨è±†åŒ…æ·±åº¦æ€è€ƒæ¨¡å‹ç”Ÿæˆä¸ªæ€§åŒ–è§£è¯»å†…å®¹</p>
            
            <div class="result-box" id="configSummary">
                <h4>ğŸ“‹ é…ç½®æ‘˜è¦</h4>
                <p><strong>ä¹¦ç±ï¼š</strong><span id="summaryBook"></span></p>
                <p><strong>ç« èŠ‚ï¼š</strong><span id="summaryChapter"></span></p>
                <p><strong>ç”¨æˆ·ç”»åƒï¼š</strong><span id="summaryPref"></span></p>
                <p><strong>è§£è¯»å¯†åº¦ï¼š</strong><span id="summaryDensity"></span></p>
            </div>

            <div class="status" id="status7"></div>
            <div class="progress-bar" id="progress7">
                <div class="progress-fill" style="width: 0%"></div>
            </div>

            <div class="thinking-box" id="thinkingBox" style="display: none;">
                <h5>ğŸ§  AI æ€è€ƒè¿‡ç¨‹</h5>
                <pre id="thinkingContent"></pre>
            </div>

            <div class="result-box" id="interpretationResult" style="display: none;">
                <h4>ğŸ“– è§£è¯»ç»“æœ</h4>
                <div class="markdown-content" id="interpretationContent"></div>
            </div>

            <div class="audio-player" id="audioPlayer" style="display: none;">
                <h4>ğŸ™ï¸ æ’­å®¢éŸ³é¢‘</h4>
                <audio id="podcastAudio" controls></audio>
                <button class="btn btn-secondary" id="downloadAudioBtn" style="margin-top: 12px;">ä¸‹è½½éŸ³é¢‘</button>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(6)">â† ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="generateBtn">
                    ğŸ§  å¼€å§‹ç”Ÿæˆè§£è¯»
                </button>
                <button class="btn btn-success" id="podcastBtn" style="display: none;">
                    ğŸ™ï¸ ç”Ÿæˆæ’­å®¢
                </button>
                <button class="btn btn-primary" onclick="goToStep(1)">
                    ğŸ”„ é‡æ–°å¼€å§‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€çŠ¶æ€ ==========
        let currentStep = 1;
        let uploadedFile = null;
        let cleanedToc = [];
        let extractedEntries = [];
        let currentBookId = null;
        let selectedBook = null;
        let selectedChapter = null;
        let selectedPreference = null;
        let selectedDensity = "50% æ ¸å¿ƒ";
        let chapters = [];

        // ç”¨æˆ·åå¥½é…ç½®
        const preferenceConfigs = {
            A: {
                name: "åˆ›ä¸šCEO",
                userProfession: "åˆ›ä¸šå…¬å¸CEO",
                readingGoal: "æå‡æˆ˜ç•¥å†³ç­–èƒ½åŠ›ã€å›¢é˜Ÿç®¡ç†å’Œå•†ä¸šæ´å¯ŸåŠ›",
                focus: "å•†ä¸šæ´å¯Ÿã€ç»„ç»‡æ æ†å’Œè½åœ°æŠ“æ‰‹",
                preferredTitle: "ææ€»",
                summary: "éœ€è¦åœ¨æœ‰é™æ—¶é—´å†…å¿«é€ŸæŠ“ä½å•†ä¸šæ æ†ç‚¹çš„åˆ›ä¸šæŒèˆµäºº"
            },
            B: {
                name: "äº§å“ç»ç†",
                userProfession: "äº§å“ç»ç†",
                readingGoal: "æ·±å…¥ç†è§£ç”¨æˆ·å¿ƒç†ã€äº§å“è®¾è®¡åŸç†å’Œå•†ä¸šé€»è¾‘",
                focus: "æ¨¡å‹æ¨ç†ã€æ¡†æ¶æ‹†è§£å’Œå¯¹æ¯”æ¡ˆä¾‹",
                preferredTitle: "å°ç‹",
                summary: "è¿½æ±‚æ·±åº¦ç†è§£ç”¨æˆ·å¿ƒç†å’Œäº§å“é€»è¾‘çš„äº§å“ç»ç†"
            },
            C: {
                name: "çŸ¥è¯†å·¥ä½œè€…",
                userProfession: "çŸ¥è¯†å·¥ä½œè€…",
                readingGoal: "ç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ï¼Œæ¢ç´¢è·¨é¢†åŸŸæ€ç»´",
                focus: "æ¦‚å¿µæ˜ å°„ã€ç»“æ„åŒ–æ€»ç»“ä¸å»¶å±•æ€è€ƒ",
                preferredTitle: "è€å¸ˆ",
                summary: "ç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ã€è¿½æ±‚æ·±åº¦ç†è§£çš„çŸ¥è¯†å·¥ä½œè€…"
            },
            D: {
                name: "èŒåœºäººå£«",
                userProfession: "å¿™ç¢Œçš„èŒåœºäººå£«",
                readingGoal: "å¿«é€Ÿè·å–æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®æ´å¯Ÿ",
                focus: "æµ“ç¼©ç»“è®ºã€è¡ŒåŠ¨æ¸…å•å’Œå®è·µæ·å¾„",
                preferredTitle: "å°é™ˆ",
                summary: "æ—¶é—´æœ‰é™ã€è¿½æ±‚å¿«é€Ÿè·å–å¯è½åœ°æ ¸å¿ƒè§‚ç‚¹çš„èŒåœºå®å¹²æ´¾"
            }
        };

        // ========== å·¥å…·å‡½æ•° ==========
        function showStatus(stepNum, message, type = 'info') {
            const el = document.getElementById(`status${stepNum}`);
            if (el) {
                el.textContent = message;
                el.className = `status show ${type}`;
            }
        }

        function hideStatus(stepNum) {
            const el = document.getElementById(`status${stepNum}`);
            if (el) el.className = 'status';
        }

        function showProgress(stepNum, percent) {
            const bar = document.getElementById(`progress${stepNum}`);
            if (bar) {
                bar.className = 'progress-bar show';
                bar.querySelector('.progress-fill').style.width = `${percent}%`;
            }
        }

        function hideProgress(stepNum) {
            const bar = document.getElementById(`progress${stepNum}`);
            if (bar) bar.className = 'progress-bar';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== æ­¥éª¤å¯¼èˆª ==========
        function goToStep(step) {
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.querySelectorAll('.step-dot').forEach((dot, idx) => {
                dot.classList.remove('active');
                if (idx + 1 < step) dot.classList.add('completed');
                else dot.classList.remove('completed');
                if (idx + 1 === step) dot.classList.add('active');
            });

            // åˆ‡æ¢é¢æ¿
            document.querySelectorAll('.step-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;

            // ç‰¹æ®Šå¤„ç†
            if (step === 5) loadBooks();
            if (step === 7) updateConfigSummary();
        }

        // ç‚¹å‡»æ­¥éª¤æŒ‡ç¤ºå™¨è·³è½¬
        document.querySelectorAll('.step-dot').forEach(dot => {
            dot.addEventListener('click', () => {
                const step = parseInt(dot.dataset.step);
                if (dot.classList.contains('completed') || dot.classList.contains('active')) {
                    goToStep(step);
                }
            });
        });

        // ========== æ­¥éª¤1: ä¸Šä¼ æ–‡æ¡£ ==========
        const fileInput = document.getElementById('fileInput');
        const nextBtn1 = document.getElementById('nextBtn1');

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                uploadedFile = fileInput.files[0];
                showStatus(1, `å·²é€‰æ‹©æ–‡ä»¶: ${uploadedFile.name}`, 'success');
                nextBtn1.disabled = false;
            } else {
                uploadedFile = null;
                nextBtn1.disabled = true;
            }
        });

        nextBtn1.addEventListener('click', () => {
            document.getElementById('currentFileName').value = uploadedFile.name;
            goToStep(2);
        });

        // ========== æ­¥éª¤2: è§£æç›®å½• ==========
        const parseTocBtn = document.getElementById('parseTocBtn');
        const nextBtn2 = document.getElementById('nextBtn2');

        parseTocBtn.addEventListener('click', async () => {
            if (!uploadedFile) {
                showStatus(2, 'è¯·å…ˆä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }

            parseTocBtn.disabled = true;
            parseTocBtn.innerHTML = '<span class="loading"></span> è§£æä¸­...';
            showStatus(2, 'æ­£åœ¨è§£æç›®å½•ï¼Œè¯·ç¨å€™...', 'info');
            showProgress(2, 30);

            try {
                const formData = new FormData();
                formData.append('file', uploadedFile);

                const response = await fetch('/api/parse/clean_toc', {
                    method: 'POST',
                    body: formData
                });

                showProgress(2, 70);

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'è§£æå¤±è´¥');
                }

                const data = await response.json();
                cleanedToc = data.cleaned_toc || [];

                showProgress(2, 100);

                // æ˜¾ç¤ºç»“æœ
                const tocList = document.getElementById('tocList');
                tocList.innerHTML = cleanedToc.map((item, idx) => `
                    <div class="chapter-item">
                        <span class="chapter-title">${idx + 1}. ${escapeHtml(item.title)}</span>
                        <span class="chapter-words">é¡µç : ${item.page || '-'}</span>
                    </div>
                `).join('');

                document.getElementById('tocResult').style.display = 'block';
                showStatus(2, `æˆåŠŸè¯†åˆ« ${cleanedToc.length} ä¸ªç« èŠ‚`, 'success');
                nextBtn2.disabled = false;

            } catch (error) {
                showStatus(2, `è§£æå¤±è´¥: ${error.message}`, 'error');
            } finally {
                parseTocBtn.disabled = false;
                parseTocBtn.innerHTML = 'ğŸ” å¼€å§‹è§£æç›®å½•';
                hideProgress(2);
            }
        });

        nextBtn2.addEventListener('click', () => goToStep(3));

        // ========== æ­¥éª¤3: æå–å†…å®¹ ==========
        const extractBtn = document.getElementById('extractBtn');
        const nextBtn3 = document.getElementById('nextBtn3');

        extractBtn.addEventListener('click', async () => {
            if (!uploadedFile || cleanedToc.length === 0) {
                showStatus(3, 'è¯·å…ˆå®Œæˆç›®å½•è§£æ', 'error');
                return;
            }

            extractBtn.disabled = true;
            extractBtn.innerHTML = '<span class="loading"></span> æå–ä¸­...';
            showStatus(3, 'æ­£åœ¨æå–ç« èŠ‚å†…å®¹ï¼Œè¯·ç¨å€™...', 'info');
            showProgress(3, 20);

            try {
                const formData = new FormData();
                formData.append('file', uploadedFile);
                formData.append('cleaned_toc', JSON.stringify(cleanedToc));
                if (document.getElementById('translateCheck').checked) {
                    formData.append('translate', 'true');
                }

                const response = await fetch('/api/parse/extract', {
                    method: 'POST',
                    body: formData
                });

                showProgress(3, 80);

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'æå–å¤±è´¥');
                }

                const data = await response.json();
                extractedEntries = data.entries || [];

                showProgress(3, 100);

                // ç»Ÿè®¡
                const totalWords = extractedEntries.reduce((sum, e) => sum + (e.word_count || 0), 0);
                document.getElementById('contentStats').innerHTML = `
                    <p>å…±æå– <strong>${extractedEntries.length}</strong> ä¸ªç« èŠ‚ï¼Œæ€»è®¡ <strong>${totalWords.toLocaleString()}</strong> å­—</p>
                `;

                // åˆ—è¡¨
                const contentList = document.getElementById('contentList');
                contentList.innerHTML = extractedEntries.map((item, idx) => `
                    <div class="chapter-item">
                        <span class="chapter-title">${idx + 1}. ${escapeHtml(item.title_zh || item.title)}</span>
                        <span class="chapter-words">${(item.word_count || 0).toLocaleString()} å­—</span>
                    </div>
                `).join('');

                document.getElementById('contentResult').style.display = 'block';
                showStatus(3, 'å†…å®¹æå–å®Œæˆ', 'success');
                nextBtn3.disabled = false;

            } catch (error) {
                showStatus(3, `æå–å¤±è´¥: ${error.message}`, 'error');
            } finally {
                extractBtn.disabled = false;
                extractBtn.innerHTML = 'ğŸ“‘ å¼€å§‹æå–å†…å®¹';
                hideProgress(3);
            }
        });

        nextBtn3.addEventListener('click', () => goToStep(4));

        // ========== æ­¥éª¤4: å…¥åº“ä¿å­˜ ==========
        const ingestBtn = document.getElementById('ingestBtn');
        const nextBtn4 = document.getElementById('nextBtn4');

        ingestBtn.addEventListener('click', async () => {
            if (extractedEntries.length === 0) {
                showStatus(4, 'è¯·å…ˆå®Œæˆå†…å®¹æå–', 'error');
                return;
            }

            ingestBtn.disabled = true;
            ingestBtn.innerHTML = '<span class="loading"></span> ä¿å­˜ä¸­...';
            showStatus(4, 'æ­£åœ¨ä¿å­˜åˆ°æ•°æ®åº“...', 'info');
            showProgress(4, 10);

            try {
                // 1. åˆ›å»ºä¹¦ç±è®°å½•
                const startRes = await fetch('/api/parse/ingest/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: uploadedFile.name })
                });

                if (!startRes.ok) throw new Error('åˆ›å»ºä¹¦ç±è®°å½•å¤±è´¥');
                const startData = await startRes.json();
                currentBookId = startData.book_id;

                // 2. é€ç« å…¥åº“
                for (let i = 0; i < extractedEntries.length; i++) {
                    const entry = extractedEntries[i];
                    const progress = 10 + (i / extractedEntries.length) * 85;
                    showProgress(4, progress);
                    showStatus(4, `æ­£åœ¨ä¿å­˜ç¬¬ ${i + 1}/${extractedEntries.length} ç« ...`, 'info');

                    await fetch('/api/parse/ingest/chapter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            book_id: currentBookId,
                            chapter_index: i,
                            title: entry.title,
                            title_zh: entry.title_zh || entry.title,
                            content: entry.content,
                            content_zh: entry.content_zh || entry.content,
                            summary: entry.summary || '',
                            word_count: entry.word_count || 0
                        })
                    });
                }

                showProgress(4, 100);
                document.getElementById('ingestInfo').textContent = 
                    `ä¹¦ç± "${uploadedFile.name}" å·²æˆåŠŸå…¥åº“ï¼Œå…± ${extractedEntries.length} ç« `;
                document.getElementById('ingestResult').style.display = 'block';
                showStatus(4, 'å…¥åº“å®Œæˆï¼', 'success');
                nextBtn4.disabled = false;

            } catch (error) {
                showStatus(4, `å…¥åº“å¤±è´¥: ${error.message}`, 'error');
            } finally {
                ingestBtn.disabled = false;
                ingestBtn.innerHTML = 'ğŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“';
                hideProgress(4);
            }
        });

        nextBtn4.addEventListener('click', () => goToStep(5));

        // ========== æ­¥éª¤5: é€‰æ‹©ç« èŠ‚ ==========
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const nextBtn5 = document.getElementById('nextBtn5');

        async function loadBooks() {
            try {
                const response = await fetch('/api/admin/books?page=1&per_page=100');
                const data = await response.json();
                
                bookSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>';
                (data.books || []).forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = `${book.filename} (${book.chapter_count}ç« )`;
                    // å¦‚æœæ˜¯åˆšå…¥åº“çš„ä¹¦ç±ï¼Œè‡ªåŠ¨é€‰ä¸­
                    if (book.id === currentBookId) option.selected = true;
                    bookSelect.appendChild(option);
                });

                // å¦‚æœæœ‰åˆšå…¥åº“çš„ä¹¦ç±ï¼Œè‡ªåŠ¨åŠ è½½ç« èŠ‚
                if (currentBookId) {
                    loadChapters(currentBookId);
                }
            } catch (error) {
                showStatus(5, `åŠ è½½ä¹¦ç±å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function loadChapters(bookId) {
            chapterSelect.disabled = true;
            chapterSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

            try {
                const response = await fetch(`/api/admin/books/${bookId}`);
                const data = await response.json();

                selectedBook = data.book;
                chapters = data.chapters || [];

                chapterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç« èŠ‚...</option>';
                chapters.forEach((ch, idx) => {
                    const option = document.createElement('option');
                    option.value = ch.id;
                    option.textContent = `${idx + 1}. ${ch.title_zh || ch.title}`;
                    chapterSelect.appendChild(option);
                });

                chapterSelect.disabled = false;
            } catch (error) {
                chapterSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                showStatus(5, `åŠ è½½ç« èŠ‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        bookSelect.addEventListener('change', () => {
            const bookId = bookSelect.value;
            if (bookId) {
                loadChapters(parseInt(bookId));
            } else {
                chapterSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©ä¹¦ç±</option>';
                chapterSelect.disabled = true;
                selectedBook = null;
                selectedChapter = null;
                nextBtn5.disabled = true;
            }
        });

        chapterSelect.addEventListener('change', () => {
            const chapterId = chapterSelect.value;
            if (chapterId) {
                selectedChapter = chapters.find(ch => ch.id === parseInt(chapterId));
                if (selectedChapter) {
                    document.getElementById('previewTitle').textContent = selectedChapter.title_zh || selectedChapter.title;
                    document.getElementById('previewWords').textContent = `${(selectedChapter.word_count || 0).toLocaleString()} å­—`;
                    document.getElementById('previewSummary').textContent = selectedChapter.summary || 'æš‚æ— æ‘˜è¦';
                    document.getElementById('chapterPreview').style.display = 'block';
                    nextBtn5.disabled = false;
                }
            } else {
                selectedChapter = null;
                document.getElementById('chapterPreview').style.display = 'none';
                nextBtn5.disabled = true;
            }
        });

        nextBtn5.addEventListener('click', () => goToStep(6));

        // ========== æ­¥éª¤6: é…ç½®åå¥½ ==========
        const nextBtn6 = document.getElementById('nextBtn6');

        // ç”¨æˆ·åå¥½é€‰æ‹©
        document.querySelectorAll('.pref-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.pref-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedPreference = card.dataset.pref;
                updateNextBtn6();
            });
        });

        // å¯†åº¦é€‰æ‹©
        document.querySelectorAll('.density-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.density-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedDensity = btn.dataset.density;
            });
        });

        function updateNextBtn6() {
            nextBtn6.disabled = !selectedPreference;
        }

        nextBtn6.addEventListener('click', () => goToStep(7));

        // ========== æ­¥éª¤7: ç”Ÿæˆè§£è¯» ==========
        const generateBtn = document.getElementById('generateBtn');
        const podcastBtn = document.getElementById('podcastBtn');

        function updateConfigSummary() {
            document.getElementById('summaryBook').textContent = selectedBook?.filename || '-';
            document.getElementById('summaryChapter').textContent = selectedChapter?.title_zh || selectedChapter?.title || '-';
            document.getElementById('summaryPref').textContent = preferenceConfigs[selectedPreference]?.name || '-';
            document.getElementById('summaryDensity').textContent = selectedDensity;
        }

        generateBtn.addEventListener('click', async () => {
            if (!selectedChapter || !selectedPreference) {
                showStatus(7, 'è¯·å®Œæˆæ‰€æœ‰é…ç½®', 'error');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            showStatus(7, 'æ­£åœ¨è°ƒç”¨ AI ç”Ÿæˆè§£è¯»ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ˆçº¦1-3åˆ†é’Ÿï¼‰...', 'info');
            showProgress(7, 20);

            const prefConfig = preferenceConfigs[selectedPreference];

            try {
                const payload = {
                    chapterTitle: selectedChapter.title_zh || selectedChapter.title,
                    chapterText: selectedChapter.content_zh || selectedChapter.content,
                    chapterSummary: selectedChapter.summary || selectedChapter.title_zh || selectedChapter.title,
                    userProfession: prefConfig.userProfession,
                    readingGoal: prefConfig.readingGoal,
                    focus: prefConfig.focus,
                    density: selectedDensity,
                    userPreferredTitle: prefConfig.preferredTitle,
                    userSummary: prefConfig.summary
                };

                showProgress(7, 40);

                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(600000) // 10åˆ†é’Ÿè¶…æ—¶
                });

                showProgress(7, 80);

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'ç”Ÿæˆå¤±è´¥');
                }

                const data = await response.json();
                const result = data.result;

                showProgress(7, 100);

                // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
                if (result._thinking_process) {
                    document.getElementById('thinkingContent').textContent = result._thinking_process;
                    document.getElementById('thinkingBox').style.display = 'block';
                }

                // æ¸²æŸ“è§£è¯»ç»“æœ
                let markdown = '';
                if (result.personalized_intro) {
                    markdown += `## ğŸ“– ä¸ªæ€§åŒ–å¯¼è¯»\n\n${result.personalized_intro}\n\n`;
                }
                if (result.interpretation) {
                    markdown += `## ğŸ“ æ­£å¼è§£è¯»\n\n${result.interpretation}\n\n`;
                }
                if (result.summary_and_application) {
                    markdown += `## ğŸ’¡ æ€»ç»“ä¸åº”ç”¨\n\n${result.summary_and_application}\n\n`;
                }
                if (result.powerful_questions) {
                    markdown += `## ğŸ¤” æ€è€ƒé—®é¢˜\n\n`;
                    if (Array.isArray(result.powerful_questions)) {
                        result.powerful_questions.forEach(q => markdown += `- ${q}\n`);
                    } else {
                        markdown += result.powerful_questions;
                    }
                    markdown += '\n\n';
                }
                if (result.quiz && Array.isArray(result.quiz)) {
                    markdown += `## â“ ç« èŠ‚æµ‹éªŒ\n\n`;
                    result.quiz.forEach((item, idx) => {
                        markdown += `### é¢˜ç›® ${idx + 1}\n\n**${item.question}**\n\n`;
                        if (item.options) {
                            item.options.forEach((opt, i) => markdown += `${String.fromCharCode(65 + i)}. ${opt}\n`);
                        }
                        markdown += `\n**ç­”æ¡ˆï¼š** ${item.answer}\n\n`;
                        if (item.explanation) markdown += `**è§£æï¼š** ${item.explanation}\n\n`;
                    });
                }

                document.getElementById('interpretationContent').innerHTML = marked.parse(markdown);
                document.getElementById('interpretationResult').style.display = 'block';

                showStatus(7, 'è§£è¯»ç”Ÿæˆå®Œæˆï¼', 'success');
                podcastBtn.style.display = 'inline-flex';

                // ä¿å­˜ç»“æœç”¨äºæ’­å®¢ç”Ÿæˆ
                window.currentInterpretation = result;

            } catch (error) {
                let msg = error.message;
                if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                    msg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•';
                }
                showStatus(7, `ç”Ÿæˆå¤±è´¥: ${msg}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'ğŸ§  å¼€å§‹ç”Ÿæˆè§£è¯»';
                hideProgress(7);
            }
        });

        // ç”Ÿæˆæ’­å®¢
        podcastBtn.addEventListener('click', async () => {
            if (!window.currentInterpretation) {
                showStatus(7, 'è¯·å…ˆç”Ÿæˆè§£è¯»', 'error');
                return;
            }

            podcastBtn.disabled = true;
            podcastBtn.innerHTML = '<span class="loading"></span> ç”Ÿæˆæ’­å®¢...';
            showStatus(7, 'æ­£åœ¨ç”Ÿæˆæ’­å®¢éŸ³é¢‘...', 'info');

            try {
                // ç»„åˆè§£è¯»å†…å®¹
                const result = window.currentInterpretation;
                let text = '';
                if (result.personalized_intro) text += result.personalized_intro + '\n\n';
                if (result.interpretation) text += result.interpretation + '\n\n';
                if (result.summary_and_application) text += result.summary_and_application;

                const response = await fetch('/api/podcast/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text.substring(0, 5000), // é™åˆ¶é•¿åº¦
                        voice_type: 'BV700_streaming'
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'æ’­å®¢ç”Ÿæˆå¤±è´¥');
                }

                const data = await response.json();
                if (data.audio_base64) {
                    const audio = document.getElementById('podcastAudio');
                    audio.src = `data:audio/mp3;base64,${data.audio_base64}`;
                    document.getElementById('audioPlayer').style.display = 'block';
                    showStatus(7, 'æ’­å®¢ç”Ÿæˆå®Œæˆï¼', 'success');
                }

            } catch (error) {
                showStatus(7, `æ’­å®¢ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            } finally {
                podcastBtn.disabled = false;
                podcastBtn.innerHTML = 'ğŸ™ï¸ ç”Ÿæˆæ’­å®¢';
            }
        });

        // ä¸‹è½½éŸ³é¢‘
        document.getElementById('downloadAudioBtn').addEventListener('click', () => {
            const audio = document.getElementById('podcastAudio');
            if (audio.src) {
                const a = document.createElement('a');
                a.href = audio.src;
                a.download = `podcast_${Date.now()}.mp3`;
                a.click();
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // é»˜è®¤é€‰ä¸­50%å¯†åº¦
            document.querySelector('[data-density="50% æ ¸å¿ƒ"]').classList.add('selected');
        });
    </script>
</body>
</html>
