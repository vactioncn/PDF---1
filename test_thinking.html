<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±åº¦æ€è€ƒæ¨¡å‹æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .result-section {
            display: none;
        }

        .result-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .result-panel h3 {
            color: #1e40af;
            margin-bottom: 12px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-panel h3::before {
            content: "ğŸ§ ";
            font-size: 20px;
        }

        .result-panel.answer h3::before {
            content: "ğŸ’¬";
        }

        .result-content {
            background: white;
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            font-size: 14px;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        .debug-info {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .debug-info h4 {
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .debug-info-item {
            margin-bottom: 6px;
            color: #475569;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  æ·±åº¦æ€è€ƒæ¨¡å‹æµ‹è¯•é¡µé¢</h1>
            <p>æµ‹è¯•è±†åŒ…æ·±åº¦æ€è€ƒæ¨¡å‹çš„ reasoning_content æå–å’Œæ˜¾ç¤º</p>
        </div>

        <div class="content">
            <div class="input-section">
                <label for="testPrompt">æµ‹è¯•æç¤ºè¯ï¼š</label>
                <textarea id="testPrompt" placeholder="è¯·è¾“å…¥ä½ çš„æµ‹è¯•æç¤ºè¯...">æˆ‘è¦ç ”ç©¶æ·±åº¦æ€è€ƒæ¨¡å‹ä¸éæ·±åº¦æ€è€ƒæ¨¡å‹åŒºåˆ«çš„è¯¾é¢˜ï¼Œæ€ä¹ˆä½“ç°æˆ‘çš„ä¸“ä¸šæ€§</textarea>
            </div>

            <div class="input-section">
                <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="margin-bottom: 12px; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">âš™ï¸ å‚æ•°é…ç½®</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label for="temperature" style="display: block; margin-bottom: 6px; font-weight: 500; color: #475569; font-size: 13px;">Temperature:</label>
                            <input type="number" id="temperature" value="0.3" min="0" max="2" step="0.1" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label for="maxTokens" style="display: block; margin-bottom: 6px; font-weight: 500; color: #475569; font-size: 13px;">Max Tokens:</label>
                            <input type="number" id="maxTokens" value="16000" min="1" max="16000" step="1000" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label for="thinking" style="display: block; margin-bottom: 6px; font-weight: 500; color: #475569; font-size: 13px;">Thinking:</label>
                            <select id="thinking" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                                <option value="auto" selected>auto (æ¨¡å‹è‡ªåŠ¨è§¦å‘)</option>
                                <option value="enabled">enabled (æ˜¾å¼å¯ç”¨)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="testButton" onclick="testThinking()">ğŸš€ å¼€å§‹æµ‹è¯•</button>
                <button class="btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            </div>

            <div class="status" id="status"></div>

            <div class="result-section" id="resultSection">
                <div class="debug-info" id="debugInfo" style="display: none;">
                    <h4>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h4>
                    <div id="debugInfoContent"></div>
                </div>

                <div class="result-panel">
                    <h3>æ·±åº¦æ€è€ƒè¿‡ç¨‹ (reasoning_content)</h3>
                    <div class="result-content" id="thinkingContent">ç­‰å¾…æµ‹è¯•ç»“æœ...</div>
                </div>

                <div class="result-panel answer">
                    <h3>æœ€ç»ˆå›ç­” (content)</h3>
                    <div class="result-content" id="answerContent">ç­‰å¾…æµ‹è¯•ç»“æœ...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin; // ä½¿ç”¨å½“å‰é¡µé¢çš„åŸŸåå’Œç«¯å£

        async function testThinking() {
            const testButton = document.getElementById('testButton');
            const status = document.getElementById('status');
            const resultSection = document.getElementById('resultSection');
            const thinkingContent = document.getElementById('thinkingContent');
            const answerContent = document.getElementById('answerContent');
            const debugInfo = document.getElementById('debugInfo');
            const debugInfoContent = document.getElementById('debugInfoContent');

            const prompt = document.getElementById('testPrompt').value.trim();
            if (!prompt) {
                showStatus('è¯·è¾“å…¥æµ‹è¯•æç¤ºè¯', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            testButton.disabled = true;
            testButton.innerHTML = '<span class="loading"></span>æµ‹è¯•ä¸­...';
            showStatus('æ­£åœ¨è°ƒç”¨æ·±åº¦æ€è€ƒæ¨¡å‹ï¼Œè¯·ç¨å€™...', 'info');
            resultSection.style.display = 'none';

            try {
                // è¯»å–å‚æ•°é…ç½®
                const temperature = parseFloat(document.getElementById('temperature').value) || 0.3;
                const max_tokens = parseInt(document.getElementById('maxTokens').value) || 16000;
                const thinking = document.getElementById('thinking').value || 'auto';
                
                // è°ƒç”¨åç«¯çš„è§£è¯»ç”Ÿæˆæ¥å£
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chapterTitle: 'æµ‹è¯•ç« èŠ‚',
                        chapterText: prompt,
                        chapterSummary: 'è¿™æ˜¯æµ‹è¯•ç« èŠ‚çš„æ‘˜è¦',
                        userProfession: 'æµ‹è¯•ç”¨æˆ·',
                        readingGoal: 'æµ‹è¯•ç›®æ ‡',
                        focus: 'æµ‹è¯•åå¥½',
                        density: '50% æ ¸å¿ƒ',
                        // å‚æ•°é…ç½®
                        temperature: temperature,
                        max_tokens: max_tokens,
                        thinking: thinking,
                        // ä½¿ç”¨é»˜è®¤çš„æç¤ºè¯éƒ¨åˆ†
                        intro_prompt: 'è¯·ç”Ÿæˆä¸ªæ€§åŒ–å¯¼è¯»',
                        body_prompt: `è¯·è¯¦ç»†è§£è¯»ä»¥ä¸‹å†…å®¹ï¼š\n{chapter_fulltext}`,
                        quiz_prompt: 'è¯·ç”Ÿæˆé€‰æ‹©é¢˜',
                        question_prompt: 'è¯·ç”Ÿæˆæ€è€ƒé—®é¢˜'
                    }),
                });

                // è¯»å–å“åº”
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ${responseText.substring(0, 200)}`);
                }

                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                // æ˜¾ç¤ºç»“æœ
                showStatus('âœ… æµ‹è¯•å®Œæˆï¼', 'success');

                // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                if (data.result && data.result._debug_info) {
                    const info = data.result._debug_info;
                    debugInfoContent.innerHTML = `
                        <div class="debug-info-item"><strong>æ¨¡å‹åç§°:</strong> ${info.model || 'N/A'}</div>
                        <div class="debug-info-item"><strong>è°ƒç”¨æ–¹å¼:</strong> ${info.method || 'N/A'}</div>
                        <div class="debug-info-item"><strong>Base URL:</strong> ${info.base_url || 'N/A'}</div>
                        <div class="debug-info-item"><strong>Temperature:</strong> ${info.temperature || 0.3}</div>
                        <div class="debug-info-item"><strong>Max Tokens:</strong> ${info.max_tokens || 16000}</div>
                        <div class="debug-info-item"><strong>Thinking:</strong> ${typeof info.thinking === 'object' ? JSON.stringify(info.thinking) : info.thinking || 'N/A'}</div>
                    `;
                    debugInfo.style.display = 'block';
                } else {
                    debugInfo.style.display = 'none';
                }

                // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
                if (data.result && data.result._thinking_process) {
                    thinkingContent.textContent = data.result._thinking_process;
                    console.log('âœ… æ‰¾åˆ°æ€è€ƒè¿‡ç¨‹ï¼Œé•¿åº¦:', data.result._thinking_process.length);
                } else {
                    thinkingContent.textContent = 'âŒ æœªæ‰¾åˆ°æ€è€ƒè¿‡ç¨‹ (_thinking_process å­—æ®µä¸å­˜åœ¨)';
                    console.log('âŒ æœªæ‰¾åˆ°æ€è€ƒè¿‡ç¨‹');
                    console.log('ç»“æœå¯¹è±¡çš„æ‰€æœ‰é”®:', data.result ? Object.keys(data.result) : 'N/A');
                }

                // æ˜¾ç¤ºæœ€ç»ˆå›ç­”ï¼ˆä»JSONä¸­æå–ï¼‰
                if (data.result) {
                    const result = data.result;
                    let answerText = '';
                    
                    if (result.interpretation) {
                        answerText += `ã€æ­£æ–‡è§£è¯»ã€‘\n${result.interpretation}\n\n`;
                    }
                    if (result.personalized_intro) {
                        answerText += `ã€ä¸ªæ€§åŒ–å¯¼è¯»ã€‘\n${result.personalized_intro}\n\n`;
                    }
                    if (result.quiz) {
                        answerText += `ã€é€‰æ‹©é¢˜ã€‘\n${result.quiz}\n\n`;
                    }
                    if (result.question) {
                        answerText += `ã€æ€è€ƒé—®é¢˜ã€‘\n${result.question}\n\n`;
                    }
                    
                    if (answerText) {
                        answerContent.textContent = answerText.trim();
                    } else {
                        answerContent.textContent = 'æœªæ‰¾åˆ°è§£è¯»å†…å®¹ï¼ŒåŸå§‹ç»“æœ: ' + JSON.stringify(result, null, 2);
                    }
                } else {
                    answerContent.textContent = 'æœªæ”¶åˆ°ç»“æœæ•°æ®';
                }

                resultSection.style.display = 'block';

            } catch (error) {
                console.error('æµ‹è¯•å¤±è´¥:', error);
                showStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                thinkingContent.textContent = `é”™è¯¯: ${error.message}`;
                answerContent.textContent = '';
                resultSection.style.display = 'block';
            } finally {
                testButton.disabled = false;
                testButton.innerHTML = 'ğŸš€ å¼€å§‹æµ‹è¯•';
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function clearResults() {
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            document.getElementById('thinkingContent').textContent = 'ç­‰å¾…æµ‹è¯•ç»“æœ...';
            document.getElementById('answerContent').textContent = 'ç­‰å¾…æµ‹è¯•ç»“æœ...';
        }
    </script>
</body>
</html>

