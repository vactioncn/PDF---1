<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æµ‹è¯•æ–‡ç« åˆ†å‰²å‡½æ•°</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    #output {
      margin-top: 20px;
      max-height: 600px;
      overflow-y: auto;
      background: white;
      padding: 15px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª æµ‹è¯• splitArticleIntoSegments å‡½æ•°</h1>
  <div id="status">æ­£åœ¨åŠ è½½å‡½æ•°...</div>
  <div id="output"></div>

  <script>
    // ä» parser_test_page.html å¤åˆ¶æ ¸å¿ƒå‡½æ•°
    async function splitArticleIntoSegments(content, maxWordCount, title = "æœªå‘½åæ–‡ç« ") {
      // å‚æ•°éªŒè¯
      if (!content || !content.trim()) {
        throw new Error("æ–‡ç« å†…å®¹ä¸èƒ½ä¸ºç©º");
      }
      
      const actualMaxWordCount = parseInt(maxWordCount) || 10000;
      if (actualMaxWordCount <= 0) {
        throw new Error("å­—æ•°è¦æ±‚å¿…é¡»å¤§äº0");
      }
      
      // è®¡ç®—åŸå§‹å­—æ•°
      const calculateWordCount = (text) => {
        if (!text) return 0;
        return text.replace(/\s+/g, "").length;
      };
      
      const originalWordCount = calculateWordCount(content);
      if (originalWordCount === 0) {
        throw new Error("æ–‡ç« å†…å®¹ä¸ºç©º");
      }
      
      // åˆ›å»º AbortController ç”¨äºè¶…æ—¶æ§åˆ¶
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†é’Ÿè¶…æ—¶
      
      try {
        const response = await fetch("/api/restructure/split-chapter", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({
            title: title || "æœªå‘½åæ–‡ç« ",
            content: content.trim(),
            max_word_count: actualMaxWordCount,
            word_count: originalWordCount
          }),
          signal: controller.signal,
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          let errorMessage = `åˆ†å‰²å¤±è´¥ (çŠ¶æ€ç : ${response.status})`;
          try {
            const errorText = await response.text();
            try {
              const errorData = JSON.parse(errorText);
              errorMessage = errorData.error || errorMessage;
            } catch (e) {
              errorMessage = errorText || errorMessage;
            }
          } catch (e) {
            // å¦‚æœæ— æ³•è¯»å–å“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯æ¶ˆæ¯
          }
          throw new Error(errorMessage);
        }
        
        let splitResult;
        try {
          splitResult = await response.json();
        } catch (jsonError) {
          throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ${jsonError.message}`);
        }
        
        const segments = splitResult.segments || [];
        
        if (segments.length === 0) {
          throw new Error("åˆ†å‰²å¤±è´¥ï¼Œæœªç”Ÿæˆä»»ä½•ç‰‡æ®µ");
        }
        
        // æ ¼å¼åŒ–è¿”å›ç»“æœï¼Œç¡®ä¿æ¯ä¸ªæ®µè½éƒ½æœ‰æ­£ç¡®çš„å­—æ•°
        return segments.map((segment, index) => ({
          title: segment.title || `ç¬¬${index + 1}éƒ¨åˆ†`,
          content: segment.content || "",
          word_count: segment.word_count || calculateWordCount(segment.content || "")
        }));
        
      } catch (fetchError) {
        clearTimeout(timeoutId);
        if (fetchError.name === "AbortError") {
          throw new Error("è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡10åˆ†é’Ÿï¼‰ï¼Œè¯·ç¨åé‡è¯•æˆ–å‡å°‘æ–‡ç« é•¿åº¦");
        }
        // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        const errorMsg = fetchError.message || String(fetchError);
        if (errorMsg.includes("Failed to fetch") || errorMsg.includes("NetworkError")) {
          throw new Error("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š\n1. æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼ˆç«¯å£5001ï¼‰\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ›´å¤šé”™è¯¯ä¿¡æ¯");
        }
        throw fetchError;
      }
    }

    const output = document.getElementById('output');
    const status = document.getElementById('status');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.textContent = message;
      output.appendChild(div);
      console.log(message);
    }

    async function runTests() {
      status.textContent = 'æ­£åœ¨è¿è¡Œæµ‹è¯•...';
      output.innerHTML = '';

      // æµ‹è¯•æ•°æ®
      const testContent = `äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼ŒAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äºåˆ›å»ºèƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½çš„ä»»åŠ¡çš„ç³»ç»Ÿã€‚

æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ã€‚å®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿåœ¨æ²¡æœ‰æ˜ç¡®ç¼–ç¨‹çš„æƒ…å†µä¸‹å­¦ä¹ å’Œæ”¹è¿›ã€‚æœºå™¨å­¦ä¹ ç®—æ³•é€šè¿‡åˆ†æå¤§é‡æ•°æ®æ¥è¯†åˆ«æ¨¡å¼å¹¶åšå‡ºé¢„æµ‹æˆ–å†³ç­–ã€‚

æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªå­é›†ï¼Œå®ƒä½¿ç”¨äººå·¥ç¥ç»ç½‘ç»œæ¥æ¨¡æ‹Ÿäººè„‘çš„å·¥ä½œæ–¹å¼ã€‚æ·±åº¦ç¥ç»ç½‘ç»œç”±å¤šä¸ªå±‚ç»„æˆï¼Œæ¯ä¸€å±‚éƒ½èƒ½å¤Ÿä»è¾“å…¥æ•°æ®ä¸­æå–æ›´å¤æ‚çš„ç‰¹å¾ã€‚

è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æ˜¯äººå·¥æ™ºèƒ½çš„å¦ä¸€ä¸ªé‡è¦é¢†åŸŸã€‚å®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿç†è§£ã€è§£é‡Šå’Œç”Ÿæˆäººç±»è¯­è¨€ã€‚ä»ç®€å•çš„æ–‡æœ¬åˆ†ç±»åˆ°å¤æ‚çš„å¯¹è¯ç³»ç»Ÿï¼ŒNLPæŠ€æœ¯åœ¨å„ä¸ªé¢†åŸŸéƒ½æœ‰å¹¿æ³›çš„åº”ç”¨ã€‚

è®¡ç®—æœºè§†è§‰ä½¿æœºå™¨èƒ½å¤Ÿç†è§£å’Œè§£é‡Šè§†è§‰ä¿¡æ¯ã€‚é€šè¿‡å›¾åƒè¯†åˆ«ã€ç‰©ä½“æ£€æµ‹å’Œå›¾åƒåˆ†å‰²ç­‰æŠ€æœ¯ï¼Œè®¡ç®—æœºè§†è§‰ç³»ç»Ÿå¯ä»¥"çœ‹åˆ°"å¹¶ç†è§£å‘¨å›´çš„ä¸–ç•Œã€‚`.trim();

      // æµ‹è¯• 1: åŸºæœ¬åŠŸèƒ½
      log('ğŸ“ æµ‹è¯•1: åŸºæœ¬åˆ†å‰²åŠŸèƒ½ï¼ˆ5000å­—é™åˆ¶ï¼‰', 'info');
      try {
        const segments1 = await splitArticleIntoSegments(testContent, 5000, 'AIæ¦‚è¿°');
        log(`âœ… æˆåŠŸï¼åˆ†å‰²ä¸º ${segments1.length} æ®µ`, 'success');
        segments1.forEach((seg, idx) => {
          log(`   æ®µ ${idx + 1}: ${seg.title} (${seg.word_count} å­—)`, 'info');
          if (seg.word_count > 5000) {
            log(`   âš ï¸ è­¦å‘Š: æ®µ ${idx + 1} å­—æ•°è¶…è¿‡é™åˆ¶`, 'error');
          }
        });
      } catch (error) {
        log(`âŒ å¤±è´¥: ${error.message}`, 'error');
      }

      // æµ‹è¯• 2: é”™è¯¯å¤„ç† - ç©ºå†…å®¹
      log('\nğŸ“ æµ‹è¯•2: é”™è¯¯å¤„ç† - ç©ºå†…å®¹', 'info');
      try {
        await splitArticleIntoSegments("", 10000);
        log('âŒ åº”è¯¥æŠ›å‡ºé”™è¯¯ï¼Œä½†æ²¡æœ‰æŠ›å‡º', 'error');
      } catch (error) {
        log(`âœ… æ­£ç¡®å¤„ç†: ${error.message}`, 'success');
      }

      // æµ‹è¯• 3: é”™è¯¯å¤„ç† - æ— æ•ˆå­—æ•°
      log('\nğŸ“ æµ‹è¯•3: é”™è¯¯å¤„ç† - æ— æ•ˆå­—æ•°é™åˆ¶', 'info');
      try {
        await splitArticleIntoSegments("æµ‹è¯•", 0);
        log('âŒ åº”è¯¥æŠ›å‡ºé”™è¯¯ï¼Œä½†æ²¡æœ‰æŠ›å‡º', 'error');
      } catch (error) {
        log(`âœ… æ­£ç¡®å¤„ç†: ${error.message}`, 'success');
      }

      // æµ‹è¯• 4: å°å­—æ•°é™åˆ¶
      log('\nğŸ“ æµ‹è¯•4: å°å­—æ•°é™åˆ¶ï¼ˆ1000å­—ï¼‰', 'info');
      try {
        const segments4 = await splitArticleIntoSegments(testContent, 1000, 'AIæ¦‚è¿°');
        log(`âœ… æˆåŠŸï¼åˆ†å‰²ä¸º ${segments4.length} æ®µ`, 'success');
        segments4.forEach((seg, idx) => {
          log(`   æ®µ ${idx + 1}: ${seg.title} (${seg.word_count} å­—)`, 'info');
        });
      } catch (error) {
        log(`âŒ å¤±è´¥: ${error.message}`, 'error');
      }

      status.textContent = 'âœ… æµ‹è¯•å®Œæˆï¼';
      log('\nğŸ“Š æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
    }

    // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
    window.addEventListener('load', () => {
      setTimeout(runTests, 500);
    });
  </script>
</body>
</html>

