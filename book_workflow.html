<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¹¦ç±å¤„ç†å·¥ä½œæµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
      color: #1a1a2e;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 24px; margin: 0 0 8px; }
    .desc { color: #666; font-size: 14px; margin-bottom: 20px; }
    
    /* æ­¥éª¤æ¡ */
    .steps {
      display: flex;
      background: #fff;
      border-radius: 10px;
      padding: 0;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .step {
      flex: 1;
      padding: 14px 10px;
      text-align: center;
      cursor: pointer;
      border-right: 1px solid #eee;
      transition: all 0.2s;
    }
    .step:last-child { border-right: none; }
    .step:hover { background: #f8f9fa; }
    .step.active { background: #6366f1; color: #fff; }
    .step.done { background: #10b981; color: #fff; }
    .step-num { font-size: 18px; font-weight: 700; }
    .step-name { font-size: 12px; margin-top: 4px; }
</style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š ä¸€ç«™å¼ä¹¦ç±å¤„ç†</h1>
    <p class="desc">å®Œæ•´æµç¨‹ï¼šä¸Šä¼  â†’ æ¸…æ´—ç›®å½• â†’ è§£æå…¥åº“ â†’ é‡æ„ â†’ ç”Ÿæˆæ–°ä¹¦ â†’ å…¥åº“</p>

    <!-- æ­¥éª¤æ¡ -->
    <div class="steps">
      <div class="step active" data-step="1"><div class="step-num">1</div><div class="step-name">ä¸Šä¼ æ–‡ä»¶</div></div>
      <div class="step" data-step="2"><div class="step-num">2</div><div class="step-name">ç›®å½•æ¸…æ´—</div></div>
      <div class="step" data-step="3"><div class="step-num">3</div><div class="step-name">è§£æå…¥åº“</div></div>
      <div class="step" data-step="4"><div class="step-num">4</div><div class="step-name">é‡æ„ç›®å½•</div></div>
      <div class="step" data-step="5"><div class="step-num">5</div><div class="step-name">ç”Ÿæˆæ–°ä¹¦</div></div>
      <div class="step" data-step="6"><div class="step-num">6</div><div class="step-name">æ–°ä¹¦å…¥åº“</div></div>
    </div>

    <!-- æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶ -->
    <div id="panel1" class="panel">
      <h2>ğŸ“„ æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶</h2>
      <div class="row">
        <input type="file" id="fileInput" accept=".pdf,.epub" />
        <label class="chk"><input type="checkbox" id="needTranslate" /> è‹±æ–‡ä¹¦éœ€ç¿»è¯‘</label>
        <button id="uploadBtn">ä¸Šä¼ å¹¶è§£æ</button>
        <span class="or">æˆ–</span>
        <button id="loadDbBtn" class="secondary">ä»æ•°æ®åº“åŠ è½½</button>
      </div>
      <div id="status1" class="status"></div>
    </div>

    <!-- æ­¥éª¤2: ç›®å½•æ¸…æ´— -->
    <div id="panel2" class="panel hide">
      <h2>ğŸ§¹ æ­¥éª¤2: ç›®å½•æ¸…æ´—</h2>
      <p class="hint">ä½¿ç”¨å¤§æ¨¡å‹è¿‡æ»¤å‰è¨€ã€é™„å½•ç­‰éæ­£æ–‡å†…å®¹</p>
      <div class="row">
        <button id="cleanBtn" disabled>å¼€å§‹æ¸…æ´—</button>
      </div>
      <div id="status2" class="status"></div>
      <div id="tocPreview" class="preview hide"></div>
    </div>

    <!-- æ­¥éª¤3: è§£æå…¥åº“ -->
    <div id="panel3" class="panel hide">
      <h2>ğŸ“Š æ­¥éª¤3: è§£æå†…å®¹ä¸å…¥åº“</h2>
      <div class="row">
        <button id="parseBtn" disabled>è§£æç« èŠ‚å†…å®¹</button>
        <button id="ingestBtn" class="success" disabled>åŸºæœ¬ä¿¡æ¯å…¥åº“</button>
      </div>
      <div id="status3" class="status"></div>
      <div id="chapterList" class="preview hide"></div>
    </div>

    <!-- æ­¥éª¤4: é‡æ„ç›®å½• -->
    <div id="panel4" class="panel hide">
      <h2>ğŸ”„ æ­¥éª¤4: é‡æ„ç›®å½•</h2>
      <div class="row">
        <label>åˆ†å‰²å­—æ•°ï¼š</label>
        <input type="number" id="maxWords" value="5000" min="1000" max="20000" step="500" style="width:100px" />
        <span class="hint">å­—/æ®µ</span>
      </div>
      <div style="margin: 12px 0;">
        <label>é‡æ„æç¤ºè¯ï¼š</label>
        <textarea id="promptText" rows="6"></textarea>
      </div>
      <div class="row">
        <button id="restructureBtn" disabled>å¼€å§‹é‡æ„</button>
      </div>
      <div id="status4" class="status"></div>
      <details id="thinkingBox" class="hide">
        <summary>ğŸ’­ æ€è€ƒè¿‡ç¨‹</summary>
        <div id="thinkingText" class="thinking"></div>
      </details>
      <div id="newTocPreview" class="preview hide"></div>
    </div>

    <!-- æ­¥éª¤5: ç”Ÿæˆæ–°ä¹¦ -->
    <div id="panel5" class="panel hide">
      <h2>ğŸ“– æ­¥éª¤5: ç”Ÿæˆæ–°ä¹¦</h2>
      <div class="row">
        <select id="partSelect"><option value="">é€‰æ‹©Partæµ‹è¯•...</option></select>
        <button id="testPartBtn" class="warning" disabled>æµ‹è¯•è¯¥Part</button>
        <button id="genBookBtn" class="success" disabled>ç”Ÿæˆæ•´æœ¬æ–°ä¹¦</button>
      </div>
      <div id="progress5" class="progress hide"><div id="progressBar"></div></div>
      <div id="status5" class="status"></div>
      <div id="bookPreview" class="preview hide">
        <div class="split-view">
          <div class="toc-side"><h3>ğŸ“‘ ç›®å½•</h3><div id="newBookToc"></div></div>
          <div class="content-side"><h3 id="contentTitle">ğŸ“„ å†…å®¹é¢„è§ˆ</h3><div id="newBookContent">ç‚¹å‡»å·¦ä¾§ç›®å½•æŸ¥çœ‹</div></div>
        </div>
      </div>
    </div>

    <!-- æ­¥éª¤6: æ–°ä¹¦å…¥åº“ -->
    <div id="panel6" class="panel hide">
      <h2>ğŸ’¾ æ­¥éª¤6: æ–°ä¹¦å…¥åº“</h2>
      <div class="row">
        <label>æ–°ä¹¦åç§°ï¼š</label>
        <input type="text" id="newBookName" style="flex:1" placeholder="è¾“å…¥æ–°ä¹¦åç§°..." />
        <button id="saveBtn" class="success" disabled>ä¿å­˜åˆ°æ•°æ®åº“</button>
      </div>
      <div id="status6" class="status"></div>
    </div>

    <!-- åŠ è½½ä¹¦ç±å¼¹çª— -->
    <dialog id="loadDialog">
      <div class="dialog-header">ğŸ“š é€‰æ‹©ä¹¦ç±</div>
      <div class="dialog-body">
        <input type="text" id="searchBook" placeholder="æœç´¢..." style="width:100%;margin-bottom:12px" />
        <div id="bookList"></div>
      </div>
      <div class="dialog-footer"><button id="closeDialog">å…³é—­</button></div>
    </dialog>
  </div>

  <style>
    .panel {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .panel h2 { margin: 0 0 12px; font-size: 16px; }
    .panel.hide { display: none; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .hint { color: #888; font-size: 13px; }
    .or { color: #999; font-size: 13px; }
    .chk { display: flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer; }
    .chk input { width: 16px; height: 16px; }
    
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #6366f1;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.secondary { background: #64748b; }
    button.success { background: #10b981; }
    button.warning { background: #f59e0b; }
    
    input[type="file"], input[type="text"], input[type="number"], select, textarea {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #6366f1; }
    textarea { width: 100%; resize: vertical; }
    
    .status { margin-top: 12px; padding: 10px 14px; border-radius: 6px; font-size: 14px; display: none; }
    .status.info { display: block; background: #eff6ff; color: #1e40af; border-left: 3px solid #3b82f6; }
    .status.success { display: block; background: #f0fdf4; color: #166534; border-left: 3px solid #22c55e; }
    .status.error { display: block; background: #fef2f2; color: #991b1b; border-left: 3px solid #ef4444; }
    
    .preview { margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 13px; line-height: 1.7; max-height: 300px; overflow-y: auto; }
    .preview.hide { display: none; }
    
    .progress { height: 6px; background: #e5e7eb; border-radius: 3px; margin-top: 12px; overflow: hidden; }
    .progress.hide { display: none; }
    #progressBar { height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); width: 0%; transition: width 0.3s; }
    
    .thinking { padding: 12px; background: #fffbeb; border-radius: 6px; font-size: 13px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; margin-top: 8px; }
    details summary { cursor: pointer; padding: 8px 12px; background: #fef3c7; border-radius: 6px; font-weight: 500; color: #92400e; }
    details.hide { display: none; }
    
    .split-view { display: grid; grid-template-columns: 250px 1fr; gap: 16px; }
    .toc-side, .content-side { background: #fff; border-radius: 6px; padding: 12px; }
    .toc-side h3, .content-side h3 { margin: 0 0 12px; font-size: 14px; color: #475569; }
    .toc-side { max-height: 400px; overflow-y: auto; }
    .content-side { max-height: 400px; overflow-y: auto; line-height: 1.8; }
    .toc-item { padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 13px; }
    .toc-item:hover { background: #f1f5f9; }
    .toc-part { font-weight: 600; color: #6366f1; margin: 10px 0 6px; font-size: 13px; }
    
    dialog { border: none; border-radius: 10px; padding: 0; width: 500px; max-width: 90vw; }
    dialog::backdrop { background: rgba(0,0,0,0.4); }
    .dialog-header { padding: 16px 20px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; font-weight: 600; }
    .dialog-body { padding: 20px; max-height: 400px; overflow-y: auto; }
    .dialog-footer { padding: 12px 20px; border-top: 1px solid #eee; text-align: right; }
    .book-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
    .book-item:hover { background: #f8fafc; border-color: #6366f1; }
    .book-name { font-weight: 500; }
    .book-info { font-size: 12px; color: #888; margin-top: 4px; }
    
    .loading::before {
      content: "";
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <script>
    // ===== çŠ¶æ€ =====
    const S = {
      step: 1,
      file: null,
      filename: '',
      rawToc: [],
      cleanedToc: [],
      chapters: [],
      bookId: null,
      newToc: null,
      parts: [],
      newBook: []
    };

    // ===== å·¥å…·å‡½æ•° =====
    const $ = id => document.getElementById(id);
    const show = (id, cls = '') => { const el = $(id); if(el) { el.classList.remove('hide'); if(cls) el.className = `status ${cls}`; } };
    const hide = id => { const el = $(id); if(el) el.classList.add('hide'); };
    const status = (id, msg, type) => { const el = $(id); if(el) { el.textContent = msg; el.className = `status ${type}`; } };
    const esc = t => { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; };

    // ===== æ­¥éª¤å¯¼èˆª =====
    function goStep(n) {
      document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.remove('active', 'done');
        if (i + 1 < n) s.classList.add('done');
        else if (i + 1 === n) s.classList.add('active');
      });
      for (let i = 1; i <= 6; i++) {
        const p = $(`panel${i}`);
        if (p) p.classList.toggle('hide', i > n);
      }
      S.step = n;
    }

    document.querySelectorAll('.step').forEach(s => {
      s.addEventListener('click', () => {
        const n = parseInt(s.dataset.step);
        if (n <= S.step) goStep(n);
      });
    });

    // ===== æ­¥éª¤1: ä¸Šä¼  =====
    $('fileInput').addEventListener('change', e => {
      S.file = e.target.files[0];
      if (S.file) S.filename = S.file.name;
    });

    $('uploadBtn').addEventListener('click', async () => {
      if (!S.file) { status('status1', 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error'); return; }
      const btn = $('uploadBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'ä¸Šä¼ ä¸­...';
      status('status1', 'æ­£åœ¨ä¸Šä¼ å¹¶æå–ç›®å½•...', 'info');

      try {
        const fd = new FormData();
        fd.append('file', S.file);
        const res = await fetch('/api/parse/debug_toc', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        S.rawToc = data.raw_toc || [];
        status('status1', `ä¸Šä¼ æˆåŠŸï¼Œæ£€æµ‹åˆ° ${S.rawToc.length} ä¸ªç›®å½•é¡¹`, 'success');
        $('cleanBtn').disabled = false;
        goStep(2);
      } catch (e) {
        status('status1', `å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'ä¸Šä¼ å¹¶è§£æ';
      }
    });

    // ä»æ•°æ®åº“åŠ è½½
    $('loadDbBtn').addEventListener('click', async () => {
      $('loadDialog').showModal();
      $('bookList').innerHTML = '<p style="text-align:center;color:#888">åŠ è½½ä¸­...</p>';
      try {
        const res = await fetch('/api/admin/books?page=1&per_page=100');
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        const books = data.books || [];
        if (!books.length) { $('bookList').innerHTML = '<p style="color:#888">æš‚æ— ä¹¦ç±</p>'; return; }
        $('bookList').innerHTML = books.map(b => `
          <div class="book-item" data-id="${b.id}">
            <div class="book-name">${esc(b.filename)}</div>
            <div class="book-info">${b.chapter_count} ç«  Â· ${(b.total_word_count||0).toLocaleString()} å­—</div>
          </div>
        `).join('');
        $('bookList').querySelectorAll('.book-item').forEach(item => {
          item.addEventListener('click', () => loadBook(item.dataset.id));
        });
      } catch (e) {
        $('bookList').innerHTML = `<p style="color:#ef4444">${e.message}</p>`;
      }
    });

    $('closeDialog').addEventListener('click', () => $('loadDialog').close());

    async function loadBook(id) {
      try {
        const res = await fetch(`/api/admin/books/${id}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        S.bookId = id;
        S.filename = data.book.filename;
        S.chapters = data.chapters || [];
        S.cleanedToc = S.chapters.map((c, i) => [1, c.title || c.title_zh, i + 1]);
        $('loadDialog').close();
        status('status1', `å·²åŠ è½½: ${S.filename} (${S.chapters.length} ç« )`, 'success');
        renderChapters();
        show('chapterList');
        $('restructureBtn').disabled = false;
        goStep(4);
      } catch (e) {
        status('status1', `åŠ è½½å¤±è´¥: ${e.message}`, 'error');
      }
    }

    // ===== æ­¥éª¤2: æ¸…æ´— =====
    $('cleanBtn').addEventListener('click', async () => {
      const btn = $('cleanBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'æ¸…æ´—ä¸­...';
      status('status2', 'æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹æ¸…æ´—ç›®å½•...', 'info');

      try {
        const fd = new FormData();
        fd.append('file', S.file);
        const res = await fetch('/api/parse/clean_toc', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        S.cleanedToc = data.cleaned_toc || [];
        // cleaned_toc æ ¼å¼æ˜¯ [{level, title, page}, ...]
        $('tocPreview').innerHTML = `<strong>æ¸…æ´—åç›®å½• (${S.cleanedToc.length}ç« ):</strong><br>` +
          S.cleanedToc.map((t, i) => `${i + 1}. ${esc(t.title || t[1] || '')}`).join('<br>');
        show('tocPreview');
        status('status2', `æ¸…æ´—å®Œæˆï¼Œä¿ç•™ ${S.cleanedToc.length} ç« `, 'success');
        $('parseBtn').disabled = false;
        goStep(3);
      } catch (e) {
        status('status2', `å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'å¼€å§‹æ¸…æ´—';
      }
    });

    // ===== æ­¥éª¤3: è§£æå…¥åº“ =====
    $('parseBtn').addEventListener('click', async () => {
      const btn = $('parseBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'è§£æä¸­...';
      status('status3', 'æ­£åœ¨è§£æç« èŠ‚å†…å®¹...', 'info');

      try {
        const fd = new FormData();
        fd.append('file', S.file);
        fd.append('cleaned_toc', JSON.stringify(S.cleanedToc));
        const res = await fetch('/api/parse/extract', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        S.chapters = data.entries || [];
        renderChapters();
        show('chapterList');
        status('status3', `è§£æå®Œæˆï¼Œå…± ${S.chapters.length} ç« `, 'success');
        $('ingestBtn').disabled = false;
      } catch (e) {
        status('status3', `å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'è§£æç« èŠ‚å†…å®¹';
      }
    });

    function renderChapters() {
      $('chapterList').innerHTML = '<table style="width:100%;font-size:13px;"><thead><tr><th>#</th><th>æ ‡é¢˜</th><th>å­—æ•°</th></tr></thead><tbody>' +
        S.chapters.map((c, i) => `<tr><td>${i + 1}</td><td>${esc(c.title_zh || c.title)}</td><td>${(c.word_count||0).toLocaleString()}</td></tr>`).join('') +
        '</tbody></table>';
    }

    $('ingestBtn').addEventListener('click', async () => {
      const btn = $('ingestBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'å…¥åº“ä¸­...';
      status('status3', 'æ­£åœ¨å…¥åº“...', 'info');

      try {
        const res = await fetch('/api/parse/ingest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: S.filename, entries: S.chapters })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        if (data.entries) S.chapters = data.entries;
        renderChapters();
        status('status3', 'å…¥åº“æˆåŠŸï¼', 'success');
        $('restructureBtn').disabled = false;
        goStep(4);
      } catch (e) {
        status('status3', `å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'åŸºæœ¬ä¿¡æ¯å…¥åº“';
      }
    });

    // ===== æ­¥éª¤4: é‡æ„ç›®å½• =====
    const DEFAULT_PROMPT = `ä½ æ˜¯ä¸€ä½è¶…å‰å®³çš„æ·±åº¦é˜…è¯»è¾¾äººï¼Œç‰¹åˆ«æ“…é•¿ç»“æ„åŒ–åˆ†æã€‚ç°åœ¨è¦æ ¹æ®å…¨ä¹¦çš„"ç« èŠ‚æ ‡é¢˜ + æ‘˜è¦"ï¼Œç»™è¿™æœ¬ä¹¦æ­å»ºä¸€ä¸ªè¶…æ¸…æ™°çš„é«˜å±‚è¯­ä¹‰ç»“æ„ã€‚

ä¸‹é¢æœ‰ä¸€ç»„ç« èŠ‚ä¿¡æ¯ï¼Œæ¯ä¸€é¡¹éƒ½åŒ…å«ç« èŠ‚ç¼–å·ã€ç« èŠ‚æ ‡é¢˜å’Œç« èŠ‚æ‘˜è¦ï¼š
<chapters>
{chapters}
</chapters>

ä½ çš„ä»»åŠ¡æ˜¯ï¼Œä¾æ®è¿™äº›æ ‡é¢˜å’Œæ‘˜è¦ï¼ŒæŠŠæ•´æœ¬ä¹¦é‡æ–°åˆ†æˆåˆé€‚æ•°é‡çš„é«˜å±‚ä¸»é¢˜ï¼ˆPartï¼‰ã€‚

å…·ä½“è¦æ±‚å¦‚ä¸‹ï¼š

1. å¥½å¥½åƒé€å…¨ä¹¦å†…å®¹ï¼š
   - è®¤çœŸè¯»å®Œæ‰€æœ‰ç« èŠ‚çš„æ ‡é¢˜å’Œæ‘˜è¦ã€‚
   - æ‰¾å‡ºå…¨ä¹¦çš„æ ¸å¿ƒæ€æƒ³ã€ä¸»è¦è¯é¢˜ï¼Œè¿˜æœ‰ä½œè€…æƒ³è¦è§£å†³çš„é—®é¢˜ã€‚

2. æŒ‰åŸä¹¦é¡ºåºåˆ’åˆ†"å¤§ä¸»é¢˜ / ç¯‡ç« ï¼ˆPartï¼‰"ï¼š
   - **å…³é”®çº¦æŸï¼šæ¯ä¸ª Part å¿…é¡»åŒ…å«è¿ç»­çš„ç« èŠ‚ï¼Œä¸¥ç¦è·³è·ƒå¼åˆ†ç»„ã€‚** æ¯”å¦‚å¯ä»¥æ˜¯"1ã€2ã€3ã€4"æˆ–"5ã€6ã€7"ï¼Œç»å¯¹ä¸èƒ½å‡ºç°"2ã€6ã€10ã€14"è¿™ç§ä¸è¿ç»­çš„æƒ…å†µã€‚
   - ä½ çš„ä»»åŠ¡æ˜¯æ‰¾åˆ°åˆé€‚çš„"åˆ‡åˆ†ç‚¹"ï¼ŒæŠŠå…¨ä¹¦æŒ‰é¡ºåºåˆ‡æˆå‡ ä¸ªå¤§å—ã€‚
   - æ ¹æ®å†…å®¹å®é™…æƒ…å†µå†³å®š Part æ•°é‡ï¼Œå¯èƒ½æ˜¯ 2 ä¸ªã€3 ä¸ªã€5 ä¸ªç”šè‡³æ›´å¤šã€‚
   - æ¯ä¸ªä¸»é¢˜é‡Œé¢çš„å†…å®¹å¾—ç´§å¯†ç›¸å…³ã€‚
   - ä¸»é¢˜åç§°è¦é€šä¿—æ˜“æ‡‚ï¼Œç”ŸåŠ¨æœ‰è¶£ï¼Œè®©äººçœ‹äº†å°±æƒ³è¯»ï¼Œåˆ«æé‚£ç§å¾ˆå­¦æœ¯çš„é£æ ¼ã€‚

3. åˆ—å‡ºæ¯ä¸ªä¸»é¢˜åŒ…å«çš„ç« èŠ‚ç¼–å·ï¼ˆå¿…é¡»è¿ç»­ä¸”æŒ‰é¡ºåºï¼‰ï¼Œå†ç»™æ¯ä¸ªä¸»é¢˜å†™ä¸€ä¸ªæ–°çš„æ‘˜è¦ã€‚

è¾“å‡ºæ ¼å¼å¿…é¡»æ˜¯ä¸‹é¢è¿™æ ·ï¼ˆPart æ•°é‡æ ¹æ®å®é™…å†…å®¹å†³å®šï¼‰ï¼š

Part 1ï¼š{ä¸»é¢˜åç§°}
    è¦†ç›–ç« èŠ‚ï¼š{è¿ç»­çš„ç« èŠ‚ç¼–å·åˆ—è¡¨ï¼Œå¦‚ 1ã€2ã€3ã€4}
    æ‘˜è¦ï¼š{å¯¹è¯¥ä¸»é¢˜å†…å®¹çš„ç®€è¦æ¦‚æ‹¬}

Part 2ï¼š{ä¸»é¢˜åç§°}
    è¦†ç›–ç« èŠ‚ï¼š{è¿ç»­çš„ç« èŠ‚ç¼–å·åˆ—è¡¨ï¼Œå¦‚ 5ã€6ã€7ã€8}
    æ‘˜è¦ï¼š{å¯¹è¯¥ä¸»é¢˜å†…å®¹çš„ç®€è¦æ¦‚æ‹¬}

...ï¼ˆæ ¹æ®å®é™…å†…å®¹ç»§ç»­ï¼Œä¸é™åˆ¶ Part æ•°é‡ï¼‰

åˆ«åšå¤šä½™è§£é‡Šï¼Œä¹Ÿåˆ«é‡å¤ç»™æ‘˜è¦ï¼Œåªè¦ç»™å‡º"ä¸»é¢˜åç§° + åŒ…å«ç« èŠ‚ + ä¸»é¢˜æ‘˜è¦"å°±è¡Œã€‚`;

    $('promptText').value = DEFAULT_PROMPT;

    $('restructureBtn').addEventListener('click', async () => {
      const btn = $('restructureBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'é‡æ„ä¸­...';
      status('status4', 'æ­£åœ¨ç”Ÿæˆç›®å½•æ‘˜è¦...', 'info');

      try {
        // ç”Ÿæˆç« èŠ‚æ‘˜è¦æ–‡æœ¬
        const tocText = S.chapters.map((c, i) => {
          const title = c.title_zh || c.title || `ç¬¬${i + 1}ç« `;
          const summary = c.summary || '';
          return `${i + 1}. ${title}\n${summary}`;
        }).join('\n\n');

        const prompt = $('promptText').value.replace(/{chapters}/g, tocText);
        status('status4', 'æ­£åœ¨è°ƒç”¨æ·±åº¦æ€è€ƒæ¨¡å‹...', 'info');

        const res = await fetch('/api/test/doubao-thinking', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, temperature: 0.3, max_tokens: 16000, model: 'doubao-seed-1-6-251015' })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        S.newToc = data.content;
        if (data.reasoning_content) {
          $('thinkingText').textContent = data.reasoning_content;
          show('thinkingBox');
        }
        $('newTocPreview').innerHTML = `<strong>é‡æ„åç›®å½•ï¼š</strong><pre style="white-space:pre-wrap;margin:8px 0 0">${esc(data.content)}</pre>`;
        show('newTocPreview');

        // è§£æPart
        S.parts = parseParts(data.content);
        updatePartSelect();

        status('status4', 'é‡æ„å®Œæˆï¼', 'success');
        $('testPartBtn').disabled = false;
        $('genBookBtn').disabled = false;
        goStep(5);
      } catch (e) {
        status('status4', `å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'å¼€å§‹é‡æ„';
      }
    });

    function parseParts(text) {
      if (!text) return [];
      const parts = [];
      let cur = null;
      for (const line of text.split('\n')) {
        const t = line.trim();
        if (!t) continue;
        const m = t.match(/^(?:Part|PART)?\s*(\d+)[ï¼š:]\s*(.+)$/i);
        if (m) {
          if (cur) parts.push(cur);
          cur = { num: parseInt(m[1]), title: m[2].trim(), chapters: [], summary: '' };
          continue;
        }
        if (cur) {
          const cm = t.match(/è¦†ç›–ç« èŠ‚[ï¼š:]\s*(.+)$/);
          if (cm) {
            cur.chapters = cm[1].split(/[ï¼Œ,ã€\s]+/).map(n => parseInt(n.replace(/\D/g, ''))).filter(n => n > 0);
            continue;
          }
          const sm = t.match(/æ‘˜è¦[ï¼š:]\s*(.+)$/);
          if (sm) cur.summary = sm[1].trim();
        }
      }
      if (cur) parts.push(cur);
      return parts.sort((a, b) => a.num - b.num);
    }

    function updatePartSelect() {
      const sel = $('partSelect');
      sel.innerHTML = '<option value="">é€‰æ‹©Partæµ‹è¯•...</option>' +
        S.parts.map(p => `<option value="${p.num}">Part ${p.num}: ${esc(p.title)}</option>`).join('');
    }

    // ===== æ­¥éª¤5: ç”Ÿæˆæ–°ä¹¦ =====
    $('testPartBtn').addEventListener('click', async () => {
      const num = $('partSelect').value;
      if (!num) { status('status5', 'è¯·é€‰æ‹©Part', 'error'); return; }
      const part = S.parts.find(p => p.num === parseInt(num));
      if (!part) return;

      const btn = $('testPartBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      status('status5', `æ­£åœ¨åˆ†å‰² Part ${num}...`, 'info');

      try {
        const content = part.chapters.map(n => S.chapters[n - 1]?.content_zh || S.chapters[n - 1]?.content || '').join('\n\n');
        const maxWords = parseInt($('maxWords').value) || 5000;

        const res = await fetch('/api/restructure/split-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: `Part ${num}: ${part.title}`, content, max_word_count: maxWords })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        status('status5', `Part ${num} åˆ†å‰²å®Œæˆï¼Œå…± ${data.segments?.length || 0} æ®µ`, 'success');
      } catch (e) {
        status('status5', `å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
      }
    });

    $('genBookBtn').addEventListener('click', async () => {
      const btn = $('genBookBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'ç”Ÿæˆä¸­...';
      show('progress5');

      const maxWords = parseInt($('maxWords').value) || 5000;
      S.newBook = [];
      let done = 0;

      try {
        for (const part of S.parts) {
          done++;
          $('progressBar').style.width = `${Math.round(done / S.parts.length * 100)}%`;
          status('status5', `å¤„ç† Part ${part.num}/${S.parts.length}...`, 'info');

          const content = part.chapters.map(n => S.chapters[n - 1]?.content_zh || S.chapters[n - 1]?.content || '').join('\n\n');
          const res = await fetch('/api/restructure/split-article', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: `Part ${part.num}: ${part.title}`, content, max_word_count: maxWords })
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          S.newBook.push({ part, segments: data.segments || [] });
        }

        renderNewBook();
        show('bookPreview');
        hide('progress5');
        status('status5', 'æ–°ä¹¦ç”Ÿæˆå®Œæˆï¼', 'success');
        $('newBookName').value = S.filename.replace(/\.(pdf|epub)$/i, '') + '_é‡æ„ç‰ˆ';
        $('saveBtn').disabled = false;
        goStep(6);
      } catch (e) {
        status('status5', `å¤±è´¥: ${e.message}`, 'error');
        hide('progress5');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'ç”Ÿæˆæ•´æœ¬æ–°ä¹¦';
      }
    });

    function renderNewBook() {
      let html = '';
      let idx = 0;
      S.newBook.forEach(item => {
        html += `<div class="toc-part">Part ${item.part.num}: ${esc(item.part.title)}</div>`;
        item.segments.forEach((seg, i) => {
          html += `<div class="toc-item" data-idx="${idx}">${i + 1}. ${esc(seg.title)} <span style="color:#888">(${seg.word_count}å­—)</span></div>`;
          idx++;
        });
      });
      $('newBookToc').innerHTML = html;
      $('newBookToc').querySelectorAll('.toc-item').forEach(item => {
        item.addEventListener('click', () => {
          const i = parseInt(item.dataset.idx);
          let cnt = 0;
          for (const p of S.newBook) {
            for (const seg of p.segments) {
              if (cnt === i) {
                $('contentTitle').textContent = `ğŸ“„ ${seg.title}`;
                $('newBookContent').textContent = seg.content;
                return;
              }
              cnt++;
            }
          }
        });
      });
    }

    // ===== æ­¥éª¤6: å…¥åº“ =====
    $('saveBtn').addEventListener('click', async () => {
      const name = $('newBookName').value.trim();
      if (!name) { status('status6', 'è¯·è¾“å…¥ä¹¦å', 'error'); return; }

      const btn = $('saveBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'ä¿å­˜ä¸­...';

      try {
        const entries = [];
        S.newBook.forEach(item => {
          item.segments.forEach(seg => {
            entries.push({ title: seg.title, content: seg.content, word_count: seg.word_count });
          });
        });

        const res = await fetch('/api/parse/ingest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: name, entries })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        status('status6', `ğŸ‰ ä¿å­˜æˆåŠŸï¼å…± ${entries.length} ç« `, 'success');
      } catch (e) {
        status('status6', `å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'ä¿å­˜åˆ°æ•°æ®åº“';
      }
    });

    // åˆå§‹åŒ–
    goStep(1);
  </script>
</body>
</html>