<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ä¸ªæ€§åŒ–è§£è¯»ç”Ÿæˆæµ‹è¯•å°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      :root {
        color-scheme: light;
        font-family: "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        background-color: #f8fafc;
        color: #0f172a;
      }

      body {
        margin: 0;
        padding: 24px;
        max-width: 1600px;
        margin: 0 auto;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 32px;
        font-weight: 600;
        color: #0f172a;
      }

      .subtitle {
        color: #64748b;
        font-size: 14px;
        margin-bottom: 32px;
      }

      .panel {
        background: #ffffff;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 24px;
        border: 1px solid #e2e8f0;
      }

      .panel h2 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      label {
        font-weight: 600;
        font-size: 14px;
        color: #475569;
      }

      select,
      input[type="text"],
      textarea {
        padding: 10px 14px;
        border: 1.5px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: #ffffff;
      }

      select:focus,
      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      .user-preference-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 12px;
      }

      @media (max-width: 768px) {
        .user-preference-group {
          grid-template-columns: 1fr;
        }
      }

      .preference-card {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #ffffff;
      }

      .preference-card:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
      }

      .preference-card.selected {
        border-color: #2563eb;
        background: #eff6ff;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .preference-label {
        font-weight: 600;
        font-size: 16px;
        color: #1e293b;
        margin-bottom: 8px;
      }

      .preference-desc {
        font-size: 13px;
        color: #64748b;
        line-height: 1.8;
      }

      .preference-dimension {
        margin-bottom: 8px;
        padding: 6px 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .preference-dimension:nth-child(6) {
        border-bottom: none;
      }

      .preference-summary {
        margin-top: 12px;
        padding: 12px;
        background: #eff6ff;
        border-radius: 6px;
        border-left: 3px solid #2563eb;
        color: #1e40af;
        font-weight: 500;
      }

      .density-selection {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px dashed #e2e8f0;
      }

      .density-options {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .density-option {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 12px 18px;
        background: #ffffff;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 160px;
        text-align: left;
      }

      .density-option strong {
        display: block;
        font-size: 14px;
        color: #1e293b;
        margin-bottom: 4px;
      }

      .density-option span {
        font-size: 12px;
        color: #64748b;
      }

      .density-option.active {
        border-color: #2563eb;
        background: #eff6ff;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      }

      .prompt-tab {
        padding: 10px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: #ffffff;
        color: #64748b;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .prompt-tab:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
      }

      .prompt-tab.active {
        border-color: #2563eb;
        background: #eff6ff;
        color: #2563eb;
      }

      .prompt-tab-panel {
        animation: fadeIn 0.2s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      button {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        background: #2563eb;
        color: white;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      button:disabled {
        background: #cbd5e1;
        color: #94a3b8;
        cursor: not-allowed;
        transform: none;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }

      .status {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        background: #f1f5f9;
        border-left: 4px solid #cbd5e1;
      }

      .status.info {
        background: #eff6ff;
        border-left-color: #3b82f6;
        color: #1e40af;
      }

      .status.success {
        background: #f0fdf4;
        border-left-color: #10b981;
        color: #065f46;
      }

      .status.error {
        background: #fef2f2;
        border-left-color: #ef4444;
        color: #991b1b;
      }

      .loading {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .output-panel {
        background: #ffffff;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        margin-top: 24px;
      }

      .markdown-output {
        padding: 24px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        line-height: 1.8;
        color: #1e293b;
        max-height: 80vh;
        overflow-y: auto;
      }

      .markdown-output h1,
      .markdown-output h2,
      .markdown-output h3 {
        color: #1e293b;
        margin-top: 24px;
        margin-bottom: 12px;
      }

      .markdown-output h1 {
        font-size: 24px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 8px;
      }

      .markdown-output h2 {
        font-size: 20px;
      }

      .markdown-output h3 {
        font-size: 18px;
      }

      .markdown-output p {
        margin-bottom: 12px;
      }

      .markdown-output ul,
      .markdown-output ol {
        margin-bottom: 12px;
        padding-left: 24px;
      }

      .markdown-output li {
        margin-bottom: 6px;
      }

      .markdown-output code {
        background: #f1f5f9;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 13px;
        font-family: "Monaco", "Menlo", monospace;
      }

      .markdown-output pre {
        background: #1e293b;
        color: #f1f5f9;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin-bottom: 12px;
      }

      .markdown-output pre code {
        background: transparent;
        padding: 0;
        color: inherit;
      }

      .markdown-output blockquote {
        border-left: 4px solid #2563eb;
        padding-left: 16px;
        margin-left: 0;
        color: #475569;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ“– ä¸ªæ€§åŒ–è§£è¯»ç”Ÿæˆæµ‹è¯•å°</h1>
    <p class="subtitle">é€‰æ‹©ä¹¦ç±å’Œç« èŠ‚ï¼Œé…ç½®è§£è¯»æç¤ºè¯å’Œç”¨æˆ·åå¥½ï¼Œç”Ÿæˆä¸ªæ€§åŒ–è§£è¯»å†…å®¹</p>

    <section class="panel">
      <h2>ğŸ“š é€‰æ‹©ä¹¦ç±å’Œç« èŠ‚</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="bookSelect">é€‰æ‹©ä¹¦ç±</label>
          <select id="bookSelect">
            <option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="chapterSelect">é€‰æ‹©ç« èŠ‚</label>
          <select id="chapterSelect" disabled>
            <option value="">è¯·å…ˆé€‰æ‹©ä¹¦ç±</option>
          </select>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>âœï¸ è§£è¯»æç¤ºè¯è°ƒé€‚</h2>
      <p style="color: #64748b; font-size: 14px; margin-bottom: 16px;">åˆ†åˆ«ä¼˜åŒ–å„ä¸ªéƒ¨åˆ†çš„æç¤ºè¯ï¼Œä»¥è·å¾—æ›´å¥½çš„è§£è¯»æ•ˆæœ</p>
      
      <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px;">
        <button class="prompt-tab" data-tab="intro" onclick="switchPromptTab('intro')">ğŸ“– å¯¼è¯»éƒ¨åˆ†</button>
        <button class="prompt-tab" data-tab="body" onclick="switchPromptTab('body')">ğŸ“ æ­£æ–‡éƒ¨åˆ†</button>
        <button class="prompt-tab" data-tab="quiz" onclick="switchPromptTab('quiz')">â“ äº’åŠ¨é—®ç­”</button>
        <button class="prompt-tab" data-tab="question" onclick="switchPromptTab('question')">ğŸ’¡ ä¸€å¥è¯é—®é¢˜</button>
      </div>
      
      <div id="promptTabContent">
        <div class="prompt-tab-panel" id="promptTabIntro" style="display: block;">
          <div class="form-group full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label for="introPrompt" style="margin: 0;">å¯¼è¯»éƒ¨åˆ†æç¤ºè¯ï¼ˆåŸºäºç« èŠ‚æ‘˜è¦ç”Ÿæˆï¼‰</label>
              <button class="secondary" onclick="generateSinglePart('intro')" id="generateIntroBtn" style="padding: 8px 16px; font-size: 14px;">ğŸš€ å•ç‹¬ç”Ÿæˆå¯¼è¯»</button>
            </div>
            <textarea id="introPrompt" rows="12" placeholder="è¾“å…¥å¯¼è¯»éƒ¨åˆ†çš„æç¤ºè¯..."></textarea>
            <div id="introResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
          </div>
        </div>
        <div class="prompt-tab-panel" id="promptTabBody" style="display: none;">
          <div class="form-group full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label for="bodyPrompt" style="margin: 0;">æ­£æ–‡éƒ¨åˆ†æç¤ºè¯ï¼ˆåŸºäºç« èŠ‚æ­£æ–‡å†…å®¹ç”Ÿæˆï¼‰</label>
              <button class="secondary" onclick="generateSinglePart('body')" id="generateBodyBtn" style="padding: 8px 16px; font-size: 14px;">ğŸš€ å•ç‹¬ç”Ÿæˆæ­£æ–‡</button>
            </div>
            <textarea id="bodyPrompt" rows="20" placeholder="è¾“å…¥æ­£æ–‡éƒ¨åˆ†çš„æç¤ºè¯..."></textarea>
            <div id="bodyResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
          </div>
        </div>
        <div class="prompt-tab-panel" id="promptTabQuiz" style="display: none;">
          <div class="form-group full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label for="quizPrompt" style="margin: 0;">äº’åŠ¨é—®ç­”æç¤ºè¯</label>
              <button class="secondary" onclick="generateSinglePart('quiz')" id="generateQuizBtn" style="padding: 8px 16px; font-size: 14px;">ğŸš€ å•ç‹¬ç”Ÿæˆé—®ç­”</button>
            </div>
            <textarea id="quizPrompt" rows="12" placeholder="è¾“å…¥äº’åŠ¨é—®ç­”éƒ¨åˆ†çš„æç¤ºè¯..."></textarea>
            <div id="quizResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
          </div>
        </div>
        <div class="prompt-tab-panel" id="promptTabQuestion" style="display: none;">
          <div class="form-group full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label for="questionPrompt" style="margin: 0;">ä¸€å¥è¯é—®é¢˜æç¤ºè¯</label>
              <button class="secondary" onclick="generateSinglePart('question')" id="generateQuestionBtn" style="padding: 8px 16px; font-size: 14px;">ğŸš€ å•ç‹¬ç”Ÿæˆé—®é¢˜</button>
            </div>
            <textarea id="questionPrompt" rows="12" placeholder="è¾“å…¥ä¸€å¥è¯é—®é¢˜éƒ¨åˆ†çš„æç¤ºè¯..."></textarea>
            <div id="questionResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
          </div>
        </div>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button class="secondary" onclick="loadPromptParts()">ğŸ“¥ åŠ è½½å·²ä¿å­˜</button>
        <button class="secondary" onclick="savePromptParts()">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
      </div>
      <div class="status" id="promptStatus" style="display: none;"></div>
    </section>

    <section class="panel">
      <h2>ğŸ‘¤ ç”¨æˆ·åå¥½è®¾ç½®</h2>
      <p style="color: #64748b; font-size: 14px; margin-bottom: 16px;">å…ˆé€‰æ‹©é˜…è¯»è§’è‰²ï¼Œå†é€‰æ‹©è§£è¯»å¯†åº¦ï¼Œä»¥æ¨¡æ‹Ÿä¸åŒè¯»è€…çš„éœ€æ±‚</p>
      <div class="user-preference-group">
        <div class="preference-card" data-preference="A" onclick="selectPreference('A')">
          <div class="preference-label">A. åˆ›ä¸šå…¬å¸ CEO</div>
          <div class="preference-desc" id="preferenceDescA">
            <div class="preference-dimension"><strong>1. å¹´é¾„ & èŒä¸šï¼š</strong>38å²ï¼Œåˆ›ä¸šå…¬å¸CEO</div>
            <div class="preference-dimension"><strong>2. é˜…è¯»ç›®çš„ï¼š</strong>æå‡æˆ˜ç•¥å†³ç­–èƒ½åŠ›ã€å›¢é˜Ÿç®¡ç†å’Œå•†ä¸šæ´å¯ŸåŠ›ï¼Œå¯»æ‰¾å¢é•¿æ æ†</div>
            <div class="preference-dimension"><strong>3. é˜…è¯»æ—¶é•¿ & èŠ‚å¥ï¼š</strong>å•æ¬¡30-45åˆ†é’Ÿï¼Œç¢ç‰‡åŒ–é˜…è¯»ï¼Œå¸¸åœ¨é€šå‹¤ã€åˆä¼‘æ—¶é˜…è¯»</div>
            <div class="preference-dimension"><strong>4. ç”Ÿæ´»è§’è‰²èº«ä»½ï¼š</strong>åˆ›ä¸šè€…ã€å›¢é˜Ÿç®¡ç†è€…ã€çˆ¶äº²</div>
            <div class="preference-dimension"><strong>5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘ï¼š</strong>å†³ç­–é€Ÿåº¦ä¸è´¨é‡ã€å›¢é˜Ÿæ¿€åŠ±ä¸èµ‹èƒ½ã€å•†ä¸šæ¨¡å¼åˆ›æ–°</div>
            <div class="preference-dimension"><strong>6. ç§°å‘¼åå¥½ï¼š</strong>ææ€»</div>
            <div class="preference-summary"><strong>ç”¨æˆ·ç‰¹å¾ï¼š</strong>ä¸€ä¸ªéœ€è¦åœ¨æœ‰é™æ—¶é—´å†…å¿«é€ŸæŠ“ä½å•†ä¸šæ æ†ç‚¹ã€ç”¨äºå®æˆ˜å†³ç­–çš„åˆ›ä¸šæŒèˆµäºº</div>
          </div>
        </div>
        <div class="preference-card" data-preference="B" onclick="selectPreference('B')">
          <div class="preference-label">B. äº§å“ç»ç†</div>
          <div class="preference-desc" id="preferenceDescB">
            <div class="preference-dimension"><strong>1. å¹´é¾„ & èŒä¸šï¼š</strong>30å²ï¼Œäº§å“ç»ç†</div>
            <div class="preference-dimension"><strong>2. é˜…è¯»ç›®çš„ï¼š</strong>æ·±å…¥ç†è§£ç”¨æˆ·å¿ƒç†ã€äº§å“è®¾è®¡åŸç†å’Œå•†ä¸šé€»è¾‘ï¼Œæå‡äº§å“æ€ç»´</div>
            <div class="preference-dimension"><strong>3. é˜…è¯»æ—¶é•¿ & èŠ‚å¥ï¼š</strong>å•æ¬¡1-1.5å°æ—¶ï¼Œåå¥½æ·±åº¦é˜…è¯»ï¼Œé€šå¸¸åœ¨æ™šä¸Šæˆ–å‘¨æœ«</div>
            <div class="preference-dimension"><strong>4. ç”Ÿæ´»è§’è‰²èº«ä»½ï¼š</strong>èŒåœºä¸“ä¸šäººå£«ã€äº§å“è´Ÿè´£äºº</div>
            <div class="preference-dimension"><strong>5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘ï¼š</strong>ç”¨æˆ·æ´å¯Ÿèƒ½åŠ›ã€äº§å“è®¾è®¡æ€ç»´ã€æ•°æ®åˆ†æèƒ½åŠ›</div>
            <div class="preference-dimension"><strong>6. ç§°å‘¼åå¥½ï¼š</strong>å°ç‹</div>
            <div class="preference-summary"><strong>ç”¨æˆ·ç‰¹å¾ï¼š</strong>ä¸€ä¸ªè¿½æ±‚æ·±åº¦ç†è§£ç”¨æˆ·å¿ƒç†å’Œäº§å“é€»è¾‘ï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿæ€§æ€ç»´æå‡äº§å“å†³ç­–èƒ½åŠ›çš„äº§å“ç»ç†</div>
          </div>
        </div>
        <div class="preference-card" data-preference="C" onclick="selectPreference('C')">
          <div class="preference-label">C. çŸ¥è¯†å·¥ä½œè€…</div>
          <div class="preference-desc" id="preferenceDescC">
            <div class="preference-dimension"><strong>1. å¹´é¾„ & èŒä¸šï¼š</strong>33å²ï¼ŒçŸ¥è¯†å·¥ä½œè€…ï¼ˆå’¨è¯¢é¡¾é—®/åŸ¹è®­å¸ˆ/ç ”ç©¶å‘˜ï¼‰</div>
            <div class="preference-dimension"><strong>2. é˜…è¯»ç›®çš„ï¼š</strong>ç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ï¼Œæ¢ç´¢è·¨é¢†åŸŸæ€ç»´ï¼Œæå‡ä¸“ä¸šæ·±åº¦å’Œå¹¿åº¦</div>
            <div class="preference-dimension"><strong>3. é˜…è¯»æ—¶é•¿ & èŠ‚å¥ï¼š</strong>å•æ¬¡2-3å°æ—¶ï¼Œæ²‰æµ¸å¼æ·±åº¦é˜…è¯»ï¼Œä¸»è¦åœ¨å‘¨æœ«æˆ–å‡æœŸ</div>
            <div class="preference-dimension"><strong>4. ç”Ÿæ´»è§’è‰²èº«ä»½ï¼š</strong>ç‹¬ç«‹ä¸“ä¸šäººå£«ã€çŸ¥è¯†ä¼ æ’­è€…ã€æ€è€ƒè€…</div>
            <div class="preference-dimension"><strong>5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘ï¼š</strong>è·¨å­¦ç§‘æ€ç»´èƒ½åŠ›ã€çŸ¥è¯†æ•´åˆã€è®¤çŸ¥æ·±åº¦</div>
            <div class="preference-dimension"><strong>6. ç§°å‘¼åå¥½ï¼š</strong>è€å¸ˆ</div>
            <div class="preference-summary"><strong>ç”¨æˆ·ç‰¹å¾ï¼š</strong>ä¸€ä¸ªç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ã€è¿½æ±‚æ·±åº¦ç†è§£å’Œè·¨é¢†åŸŸæ€è€ƒçš„çŸ¥è¯†å·¥ä½œè€…</div>
          </div>
        </div>
        <div class="preference-card" data-preference="D" onclick="selectPreference('D')">
          <div class="preference-label">D. å¿™ç¢Œçš„èŒåœºäººå£«</div>
          <div class="preference-desc" id="preferenceDescD">
            <div class="preference-dimension"><strong>1. å¹´é¾„ & èŒä¸šï¼š</strong>28å²ï¼Œå…¬å¸ä¸­å±‚ç®¡ç†è€…æˆ–é«˜çº§æ‰§è¡Œè€…</div>
            <div class="preference-dimension"><strong>2. é˜…è¯»ç›®çš„ï¼š</strong>å¿«é€Ÿè·å–æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®æ´å¯Ÿï¼Œæé«˜å·¥ä½œæ•ˆç‡å’Œå†³ç­–èƒ½åŠ›</div>
            <div class="preference-dimension"><strong>3. é˜…è¯»æ—¶é•¿ & èŠ‚å¥ï¼š</strong>å•æ¬¡15-30åˆ†é’Ÿï¼Œç¢ç‰‡åŒ–é˜…è¯»ï¼Œä¸»è¦åœ¨é€šå‹¤æˆ–çŸ­æš‚ä¼‘æ¯æ—¶é—´</div>
            <div class="preference-dimension"><strong>4. ç”Ÿæ´»è§’è‰²èº«ä»½ï¼š</strong>èŒåœºå¥‹æ–—è€…ã€å¯èƒ½ä¹Ÿæ˜¯çˆ¶æ¯ã€å®¶åº­è´£ä»»æ‰¿æ‹…è€…</div>
            <div class="preference-dimension"><strong>5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘ï¼š</strong>æ—¶é—´ç®¡ç†ã€å†³ç­–æ•ˆç‡ã€å¿«é€Ÿå­¦ä¹ èƒ½åŠ›</div>
            <div class="preference-dimension"><strong>6. ç§°å‘¼åå¥½ï¼š</strong>å°é™ˆ</div>
            <div class="preference-summary"><strong>ç”¨æˆ·ç‰¹å¾ï¼š</strong>ä¸€ä¸ªæ—¶é—´æœ‰é™ã€è¿½æ±‚å¿«é€Ÿè·å–å¯è½åœ°æ ¸å¿ƒè§‚ç‚¹å¹¶ç«‹å³åº”ç”¨çš„èŒåœºå®å¹²æ´¾</div>
          </div>
        </div>
      </div>

      <div class="density-selection">
        <label style="font-weight: 600; color: #475569;">è§£è¯»å¯†åº¦</label>
        <div class="density-options">
          <button type="button" class="density-option" data-density="20% ä¸»å¹²" onclick="selectDensity('20% ä¸»å¹²')">
            <strong>20% ä¸»å¹²</strong>
            <span>åªä¿ç•™ä¸»çº¿ç»“è®º + æ ¸å¿ƒæ¨ç†ï¼Œçº¦ 3-4 ä¸ªè¦ç‚¹</span>
          </button>
          <button type="button" class="density-option" data-density="50% æ ¸å¿ƒ" onclick="selectDensity('50% æ ¸å¿ƒ')">
            <strong>50% æ ¸å¿ƒ</strong>
            <span>åœ¨ä¸»å¹²ä¸Šè¡¥å……å…³é”®ä¾‹è¯å’Œç»†èŠ‚ï¼Œçº¦ 5-7 ä¸ªè¦ç‚¹</span>
          </button>
          <button type="button" class="density-option" data-density="70% æ·±åº¦" onclick="selectDensity('70% æ·±åº¦')">
            <strong>70% æ·±åº¦</strong>
            <span>è¦†ç›–é‡è¦åˆ†æ”¯ä¸ç›²ç‚¹æé†’ï¼Œçº¦ 8-12 ä¸ªè¦ç‚¹</span>
          </button>
        </div>
      </div>

      <input type="hidden" id="selectedPreference" value="" />
    </section>

    <section class="panel">
      <h2>ğŸ™ï¸ æ’­å®¢é…ç½®</h2>
      <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="enablePodcast" checked /> ç”Ÿæˆæ’­å®¢éŸ³é¢‘
        </label>
        <div id="podcastConfig" style="display: flex; align-items: center; gap: 8px;">
          <label for="voiceType" style="margin: 0; white-space: nowrap;">éŸ³è‰²ï¼š</label>
          <select id="voiceType" style="min-width: 120px;">
            <option value="BV700_streaming">æ ‡å‡†å¥³å£°</option>
            <option value="BV701_streaming">æ¸©æŸ”å¥³å£°</option>
            <option value="BV702_streaming">çŸ¥æ€§å¥³å£°</option>
            <option value="BV703_streaming">æ´»æ³¼å¥³å£°</option>
            <option value="BV001_streaming">æ ‡å‡†ç”·å£°</option>
            <option value="BV002_streaming">ç£æ€§ç”·å£°</option>
            <option value="BV003_streaming">æ²‰ç¨³ç”·å£°</option>
          </select>
        </div>
      </div>
    </section>

    <section class="panel">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <h2 style="margin: 0;">ğŸš€ ç”Ÿæˆè§£è¯»</h2>
        <button id="generateButton" disabled>ç”Ÿæˆè§£è¯»</button>
      </div>
      <div class="status" id="generationStatus" style="display: none;"></div>
    </section>

    <!-- è°ƒè¯•ä¿¡æ¯å’Œæ€è€ƒè¿‡ç¨‹åŒºåŸŸ - å§‹ç»ˆæ˜¾ç¤º -->
    <section class="panel" style="margin-top: 24px;">
      <!-- è°ƒè¯•ä¿¡æ¯åŒºåŸŸ -->
      <div id="debugInfoSection" style="display: block; margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h3 style="margin-top: 0; color: #475569; font-size: 16px; margin-bottom: 12px;">ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
        <div id="debugInfoContent" style="font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #64748b; line-height: 1.6;">
          <div style="color: #94a3b8; font-style: italic;">ç­‰å¾…ç”Ÿæˆç»“æœ...</div>
        </div>
      </div>
      
      <!-- æ·±åº¦æ€è€ƒè¿‡ç¨‹åŒºåŸŸ -->
      <div id="thinkingProcessSection" style="display: block; margin-bottom: 24px; padding: 20px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #3b82f6;">
        <h3 style="margin-top: 0; color: #1e40af; font-size: 18px; margin-bottom: 12px;">ğŸ§  æ·±åº¦æ€è€ƒè¿‡ç¨‹</h3>
        <div id="thinkingProcessContent" style="color: #1e293b; line-height: 1.8; white-space: pre-wrap; max-height: 400px; overflow-y: auto; padding: 12px; background: #ffffff; border-radius: 8px; border: 1px solid #bfdbfe;">
          <div style="color: #94a3b8; font-style: italic;">ç­‰å¾…ç”Ÿæˆç»“æœ...</div>
        </div>
      </div>
    </section>

    <section class="output-panel" id="outputSection" style="display: none;">
      <h2>ğŸ“„ è§£è¯»ç»“æœ</h2>
      <div class="markdown-output" id="markdownOutput"></div>
      <div id="podcastSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
        <h3 style="margin-top: 0;">ğŸ™ï¸ æ’­å®¢éŸ³é¢‘</h3>
        <div id="podcastButtonContainer" style="margin-bottom: 16px;">
          <button id="generatePodcastButton" class="secondary" onclick="generatePodcastFromResult()">ğŸ™ï¸ ç”Ÿæˆæ’­å®¢</button>
        </div>
        <div id="podcastAudioContainer" style="display: none;">
          <audio id="podcastAudio" controls style="width: 100%; margin-bottom: 12px;"></audio>
          <div style="display: flex; gap: 12px;">
            <button id="downloadPodcast" class="secondary">ä¸‹è½½éŸ³é¢‘</button>
            <span id="podcastStatus" style="color: #64748b; font-size: 14px;"></span>
          </div>
        </div>
      </div>
    </section>

    <script>
      const bookSelect = document.getElementById("bookSelect");
      const chapterSelect = document.getElementById("chapterSelect");
      const promptStatus = document.getElementById("promptStatus");
      const selectedPreference = document.getElementById("selectedPreference");
      const generateButton = document.getElementById("generateButton");
      const generationStatus = document.getElementById("generationStatus");
      const outputSection = document.getElementById("outputSection");
      const markdownOutput = document.getElementById("markdownOutput");
      
      // æç¤ºè¯ç›¸å…³å…ƒç´ 
      const introPrompt = document.getElementById("introPrompt");
      const bodyPrompt = document.getElementById("bodyPrompt");
      const quizPrompt = document.getElementById("quizPrompt");
      const questionPrompt = document.getElementById("questionPrompt");
      
      // æ’­å®¢ç›¸å…³å…ƒç´ 
      const enablePodcast = document.getElementById("enablePodcast");
      const podcastConfig = document.getElementById("podcastConfig");
      const voiceType = document.getElementById("voiceType");
      const podcastSection = document.getElementById("podcastSection");
      const podcastAudio = document.getElementById("podcastAudio");
      const downloadPodcast = document.getElementById("downloadPodcast");
      const podcastStatus = document.getElementById("podcastStatus");
      
      let currentAudioBlob = null;

      let books = [];
      let chapters = [];
      let selectedBook = null;
      let selectedChapter = null;
      let currentInterpretationResult = null; // å­˜å‚¨å½“å‰çš„è§£è¯»ç»“æœ

      // ç”¨æˆ·åå¥½é…ç½® - åŸºäº6ä¸ªç»´åº¦å®Œæ•´åˆ»ç”»ç”¨æˆ·ç”»åƒ
      const preferenceConfigs = {
        A: {
          // 1. å¹´é¾„ & èŒä¸š
          age: "38å²",
          profession: "åˆ›ä¸šå…¬å¸CEO",
          // 2. é˜…è¯»ç›®çš„
          readingGoal: "æå‡æˆ˜ç•¥å†³ç­–èƒ½åŠ›ã€å›¢é˜Ÿç®¡ç†å’Œå•†ä¸šæ´å¯ŸåŠ›ï¼Œå¯»æ‰¾å¢é•¿æ æ†",
          // 3. é˜…è¯»æ—¶é•¿ & ä¼‘æ¯èŠ‚å¥
          readingDuration: "å•æ¬¡30-45åˆ†é’Ÿ",
          readingRhythm: "ç¢ç‰‡åŒ–é˜…è¯»ï¼Œå¸¸åœ¨é€šå‹¤ã€åˆä¼‘æ—¶é˜…è¯»",
          // 4. ç”Ÿæ´»è§’è‰²èº«ä»½
          lifeRole: "åˆ›ä¸šè€…ã€å›¢é˜Ÿç®¡ç†è€…ã€çˆ¶äº²",
          // 5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘
          currentFocus: "å†³ç­–é€Ÿåº¦ä¸è´¨é‡ã€å›¢é˜Ÿæ¿€åŠ±ä¸èµ‹èƒ½ã€å•†ä¸šæ¨¡å¼åˆ›æ–°",
          // 6. ç§°å‘¼åå¥½
          preferredTitle: "ææ€»",
          // ä¸€å¥è¯æè¿°ç”¨æˆ·ç‰¹å¾å’Œåå¥½
          summary: "ä¸€ä¸ªéœ€è¦åœ¨æœ‰é™æ—¶é—´å†…å¿«é€ŸæŠ“ä½å•†ä¸šæ æ†ç‚¹ã€ç”¨äºå®æˆ˜å†³ç­–çš„åˆ›ä¸šæŒèˆµäºº",
          // ç”¨äºç”Ÿæˆè§£è¯»çš„å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
          userProfession: "åˆ›ä¸šå…¬å¸CEO",
          focus: "å•†ä¸šæ´å¯Ÿã€ç»„ç»‡æ æ†å’Œè½åœ°æŠ“æ‰‹",
        },
        B: {
          age: "30å²",
          profession: "äº§å“ç»ç†",
          readingGoal: "æ·±å…¥ç†è§£ç”¨æˆ·å¿ƒç†ã€äº§å“è®¾è®¡åŸç†å’Œå•†ä¸šé€»è¾‘ï¼Œæå‡äº§å“æ€ç»´",
          readingDuration: "å•æ¬¡1-1.5å°æ—¶",
          readingRhythm: "åå¥½æ·±åº¦é˜…è¯»ï¼Œé€šå¸¸åœ¨æ™šä¸Šæˆ–å‘¨æœ«",
          lifeRole: "èŒåœºä¸“ä¸šäººå£«ã€äº§å“è´Ÿè´£äºº",
          currentFocus: "ç”¨æˆ·æ´å¯Ÿèƒ½åŠ›ã€äº§å“è®¾è®¡æ€ç»´ã€æ•°æ®åˆ†æèƒ½åŠ›",
          preferredTitle: "å°ç‹",
          summary: "ä¸€ä¸ªè¿½æ±‚æ·±åº¦ç†è§£ç”¨æˆ·å¿ƒç†å’Œäº§å“é€»è¾‘ï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿæ€§æ€ç»´æå‡äº§å“å†³ç­–èƒ½åŠ›çš„äº§å“ç»ç†",
          userProfession: "äº§å“ç»ç†",
          focus: "æ¨¡å‹æ¨ç†ã€æ¡†æ¶æ‹†è§£å’Œå¯¹æ¯”æ¡ˆä¾‹",
        },
        C: {
          age: "33å²",
          profession: "çŸ¥è¯†å·¥ä½œè€…ï¼ˆå’¨è¯¢é¡¾é—®/åŸ¹è®­å¸ˆ/ç ”ç©¶å‘˜ï¼‰",
          readingGoal: "ç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ï¼Œæ¢ç´¢è·¨é¢†åŸŸæ€ç»´ï¼Œæå‡ä¸“ä¸šæ·±åº¦å’Œå¹¿åº¦",
          readingDuration: "å•æ¬¡2-3å°æ—¶",
          readingRhythm: "æ²‰æµ¸å¼æ·±åº¦é˜…è¯»ï¼Œä¸»è¦åœ¨å‘¨æœ«æˆ–å‡æœŸ",
          lifeRole: "ç‹¬ç«‹ä¸“ä¸šäººå£«ã€çŸ¥è¯†ä¼ æ’­è€…ã€æ€è€ƒè€…",
          currentFocus: "è·¨å­¦ç§‘æ€ç»´èƒ½åŠ›ã€çŸ¥è¯†æ•´åˆã€è®¤çŸ¥æ·±åº¦",
          preferredTitle: "è€å¸ˆ",
          summary: "ä¸€ä¸ªç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ã€è¿½æ±‚æ·±åº¦ç†è§£å’Œè·¨é¢†åŸŸæ€è€ƒçš„çŸ¥è¯†å·¥ä½œè€…",
          userProfession: "çŸ¥è¯†å·¥ä½œè€…",
          focus: "æ¦‚å¿µæ˜ å°„ã€ç»“æ„åŒ–æ€»ç»“ä¸å»¶å±•æ€è€ƒ",
        },
        D: {
          age: "28å²",
          profession: "å…¬å¸ä¸­å±‚ç®¡ç†è€…æˆ–é«˜çº§æ‰§è¡Œè€…",
          readingGoal: "å¿«é€Ÿè·å–æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®æ´å¯Ÿï¼Œæé«˜å·¥ä½œæ•ˆç‡å’Œå†³ç­–èƒ½åŠ›",
          readingDuration: "å•æ¬¡15-30åˆ†é’Ÿ",
          readingRhythm: "ç¢ç‰‡åŒ–é˜…è¯»ï¼Œä¸»è¦åœ¨é€šå‹¤æˆ–çŸ­æš‚ä¼‘æ¯æ—¶é—´",
          lifeRole: "èŒåœºå¥‹æ–—è€…ã€å¯èƒ½ä¹Ÿæ˜¯çˆ¶æ¯ã€å®¶åº­è´£ä»»æ‰¿æ‹…è€…",
          currentFocus: "æ—¶é—´ç®¡ç†ã€å†³ç­–æ•ˆç‡ã€å¿«é€Ÿå­¦ä¹ èƒ½åŠ›",
          preferredTitle: "å°é™ˆ",
          summary: "ä¸€ä¸ªæ—¶é—´æœ‰é™ã€è¿½æ±‚å¿«é€Ÿè·å–å¯è½åœ°æ ¸å¿ƒè§‚ç‚¹å¹¶ç«‹å³åº”ç”¨çš„èŒåœºå®å¹²æ´¾",
          userProfession: "å¿™ç¢Œçš„èŒåœºäººå£«",
          focus: "æµ“ç¼©ç»“è®ºã€è¡ŒåŠ¨æ¸…å•å’Œå®è·µæ·å¾„",
        },
      };

      let selectedDensity = "50% æ ¸å¿ƒ";

      function renderStatus(el, message, type = "info") {
        el.style.display = "block";
        el.className = `status ${type}`;
        el.textContent = message;
      }

      function hideStatus(el) {
        el.style.display = "none";
      }

      // åˆ‡æ¢æç¤ºè¯æ ‡ç­¾é¡µ
      function switchPromptTab(tabName) {
        // éšè—æ‰€æœ‰é¢æ¿
        document.querySelectorAll(".prompt-tab-panel").forEach(panel => {
          panel.style.display = "none";
        });
        // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
        document.querySelectorAll(".prompt-tab").forEach(tab => {
          tab.classList.remove("active");
        });
        // æ˜¾ç¤ºé€‰ä¸­çš„é¢æ¿
        const panel = document.getElementById(`promptTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
        if (panel) {
          panel.style.display = "block";
        }
        // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
        const tab = document.querySelector(`[data-tab="${tabName}"]`);
        if (tab) {
          tab.classList.add("active");
        }
      }

      // åŠ è½½æç¤ºè¯å„éƒ¨åˆ†
      async function loadPromptParts() {
        try {
          const response = await fetch("/api/settings/prompt_parts");
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }
          if (data.intro_prompt) introPrompt.value = data.intro_prompt;
          if (data.body_prompt) bodyPrompt.value = data.body_prompt;
          if (data.quiz_prompt) quizPrompt.value = data.quiz_prompt;
          if (data.question_prompt) questionPrompt.value = data.question_prompt;
          renderStatus(promptStatus, "æç¤ºè¯å·²åŠ è½½", "success");
        } catch (error) {
          console.error(error);
          renderStatus(promptStatus, `åŠ è½½å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ä¿å­˜æç¤ºè¯å„éƒ¨åˆ†
      async function savePromptParts() {
        try {
          const payload = {
            intro_prompt: introPrompt.value.trim(),
            body_prompt: bodyPrompt.value.trim(),
            quiz_prompt: quizPrompt.value.trim(),
            question_prompt: questionPrompt.value.trim(),
          };
          const response = await fetch("/api/settings/prompt_parts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }
          renderStatus(promptStatus, "æç¤ºè¯å·²ä¿å­˜", "success");
        } catch (error) {
          console.error(error);
          renderStatus(promptStatus, `ä¿å­˜å¤±è´¥: ${error.message}`, "error");
        }
      }

      // å•ç‹¬ç”ŸæˆæŸä¸ªéƒ¨åˆ†
      async function generateSinglePart(part) {
        if (!selectedBook || !selectedChapter || !selectedPreference.value) {
          renderStatus(promptStatus, "è¯·å…ˆé€‰æ‹©ä¹¦ç±ã€ç« èŠ‚å’Œç”¨æˆ·åå¥½", "error");
          return;
        }

        const prefConfig = preferenceConfigs[selectedPreference.value];
        if (!prefConfig) {
          renderStatus(promptStatus, "ç”¨æˆ·åå¥½é…ç½®é”™è¯¯", "error");
          return;
        }

        // è·å–å¯¹åº”éƒ¨åˆ†çš„æç¤ºè¯
        let partPrompt = "";
        let resultElement = null;
        let buttonElement = null;
        
        if (part === "intro") {
          partPrompt = introPrompt.value.trim();
          resultElement = document.getElementById("introResult");
          buttonElement = document.getElementById("generateIntroBtn");
        } else if (part === "body") {
          partPrompt = bodyPrompt.value.trim();
          resultElement = document.getElementById("bodyResult");
          buttonElement = document.getElementById("generateBodyBtn");
        } else if (part === "quiz") {
          partPrompt = quizPrompt.value.trim();
          resultElement = document.getElementById("quizResult");
          buttonElement = document.getElementById("generateQuizBtn");
        } else if (part === "question") {
          partPrompt = questionPrompt.value.trim();
          resultElement = document.getElementById("questionResult");
          buttonElement = document.getElementById("generateQuestionBtn");
        }

        if (!partPrompt) {
          renderStatus(promptStatus, `è¯·å…ˆè¾“å…¥${part}éƒ¨åˆ†çš„æç¤ºè¯`, "error");
          return;
        }

        // ç¦ç”¨æŒ‰é’®
        if (buttonElement) {
          buttonElement.disabled = true;
          buttonElement.textContent = "ç”Ÿæˆä¸­...";
        }

        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        if (resultElement) {
          resultElement.style.display = "block";
          resultElement.innerHTML = "<p style='color: #64748b;'>æ­£åœ¨ç”Ÿæˆ...</p>";
        }

        const payload = {
          part: part,
          chapterTitle: selectedChapter.title_zh || selectedChapter.title,
          chapterText: selectedChapter.content_zh || selectedChapter.content,
          chapterSummary: selectedChapter.summary || selectedChapter.title_zh || selectedChapter.title,
          // å‘åå…¼å®¹å­—æ®µ
          userProfession: prefConfig.userProfession,
          readingGoal: prefConfig.readingGoal,
          focus: prefConfig.focus,
          density: selectedDensity,
          // æ–°çš„6ä¸ªç»´åº¦å­—æ®µ
          userAge: prefConfig.age,
          userProfessionDetail: prefConfig.profession,
          userReadingGoal: prefConfig.readingGoal,
          userReadingDuration: prefConfig.readingDuration,
          userReadingRhythm: prefConfig.readingRhythm,
          userLifeRole: prefConfig.lifeRole,
          userCurrentFocus: prefConfig.currentFocus,
          userPreferredTitle: prefConfig.preferredTitle,
          userSummary: prefConfig.summary,
          intro_prompt: introPrompt.value.trim(),
          body_prompt: bodyPrompt.value.trim(),
          quiz_prompt: quizPrompt.value.trim(),
          question_prompt: questionPrompt.value.trim(),
        };

        try {
          const response = await fetch("/api/generate/part", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            signal: AbortSignal.timeout(300000), // 5åˆ†é’Ÿè¶…æ—¶
          });

          if (!response.ok) {
            let errorMessage = "ç”Ÿæˆå¤±è´¥";
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();
          
          // æ˜¾ç¤ºç»“æœ
          if (resultElement) {
            let resultHtml = "";
            if (part === "quiz" && Array.isArray(data.result)) {
              // é—®ç­”éƒ¨åˆ†ï¼šæ˜¾ç¤ºä¸ºåˆ—è¡¨
              resultHtml = "<h4 style='margin-top: 0; color: #1e293b;'>ç”Ÿæˆçš„é—®ç­”ï¼š</h4>";
              data.result.forEach((item, index) => {
                resultHtml += `<div style="margin-bottom: 16px; padding: 12px; background: #ffffff; border-radius: 6px; border-left: 3px solid #2563eb;">`;
                resultHtml += `<p><strong>é¢˜ç›® ${index + 1}ï¼š</strong> ${item.question || ""}</p>`;
                if (item.options && Array.isArray(item.options)) {
                  resultHtml += `<ul style="margin: 8px 0; padding-left: 20px;">`;
                  item.options.forEach((opt, idx) => {
                    resultHtml += `<li>${String.fromCharCode(65 + idx)}. ${opt}</li>`;
                  });
                  resultHtml += `</ul>`;
                }
                resultHtml += `<p><strong>ç­”æ¡ˆï¼š</strong> ${item.answer || "?"}</p>`;
                if (item.explanation) {
                  resultHtml += `<p><strong>è§£æï¼š</strong> ${item.explanation}</p>`;
                }
                resultHtml += `</div>`;
              });
            } else {
              // å…¶ä»–éƒ¨åˆ†ï¼šç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
              resultHtml = `<h4 style='margin-top: 0; color: #1e293b;'>ç”Ÿæˆç»“æœï¼š</h4>`;
              resultHtml += `<div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b;">${data.result || "æ— ç»“æœ"}</div>`;
            }
            resultElement.innerHTML = resultHtml;
          }

          renderStatus(promptStatus, `${part}éƒ¨åˆ†ç”Ÿæˆå®Œæˆï¼`, "success");
        } catch (error) {
          console.error("ç”Ÿæˆå¤±è´¥:", error);
          let errorMessage = "ç”Ÿæˆå¤±è´¥";
          if (error.name === "AbortError" || error.name === "TimeoutError") {
            errorMessage = "è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•";
          } else if (error.message) {
            errorMessage = error.message;
          } else if (error instanceof TypeError && error.message.includes("fetch")) {
            errorMessage = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ";
          }
          
          if (resultElement) {
            resultElement.innerHTML = `<p style='color: #ef4444;'>${errorMessage}</p>`;
          }
          renderStatus(promptStatus, errorMessage, "error");
        } finally {
          // æ¢å¤æŒ‰é’®
          if (buttonElement) {
            buttonElement.disabled = false;
            if (part === "intro") {
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆå¯¼è¯»";
            } else if (part === "body") {
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆæ­£æ–‡";
            } else if (part === "quiz") {
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆé—®ç­”";
            } else if (part === "question") {
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆé—®é¢˜";
            }
          }
        }
      }

      // åŠ è½½ä¹¦ç±åˆ—è¡¨
      async function loadBooks() {
        try {
          const response = await fetch("/api/admin/books?page=1&per_page=100");
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }

          books = data.books || [];
          bookSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>';
          books.forEach((book) => {
            const option = document.createElement("option");
            option.value = book.id;
            option.textContent = `${book.filename} (${book.chapter_count}ç« )`;
            bookSelect.appendChild(option);
          });
        } catch (error) {
          console.error(error);
          renderStatus(promptStatus, `åŠ è½½ä¹¦ç±å¤±è´¥: ${error.message}`, "error");
        }
      }

      // åŠ è½½ç« èŠ‚åˆ—è¡¨
      async function loadChapters(bookId) {
        chapterSelect.disabled = true;
        chapterSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        try {
          const response = await fetch(`/api/admin/books/${bookId}`);
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }

          selectedBook = data.book;
          chapters = data.chapters || [];

          chapterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç« èŠ‚...</option>';
          chapters.forEach((chapter, index) => {
            const option = document.createElement("option");
            option.value = chapter.id;
            const displayTitle = chapter.title_zh || chapter.title;
            option.textContent = `${index + 1}. ${displayTitle}`;
            chapterSelect.appendChild(option);
          });

          chapterSelect.disabled = false;
          updateGenerateButton();
        } catch (error) {
          console.error(error);
          chapterSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
          renderStatus(promptStatus, `åŠ è½½ç« èŠ‚å¤±è´¥: ${error.message}`, "error");
        }
      }

      // é€‰æ‹©ç”¨æˆ·åå¥½
      function selectPreference(pref) {
        selectedPreference.value = pref;
        document.querySelectorAll(".preference-card").forEach((card) => {
          card.classList.remove("selected");
        });
        document.querySelector(`[data-preference="${pref}"]`).classList.add("selected");
        updateGenerateButton();
      }

      function selectDensity(value) {
        selectedDensity = value;
        document.querySelectorAll(".density-option").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.density === value);
        });
      }

      // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
      function updateGenerateButton() {
        const hasBook = bookSelect.value && selectedBook;
        const hasChapter = chapterSelect.value && selectedChapter;
        const hasPreference = selectedPreference.value;
        generateButton.disabled = !(hasBook && hasChapter && hasPreference);
      }

      // ç”Ÿæˆè§£è¯»
      async function generateInterpretation() {
        if (!selectedBook || !selectedChapter || !selectedPreference.value) {
          renderStatus(generationStatus, "è¯·å®Œæˆæ‰€æœ‰å¿…å¡«é¡¹", "error");
          return;
        }

        const prefConfig = preferenceConfigs[selectedPreference.value];
        if (!prefConfig) {
          renderStatus(generationStatus, "ç”¨æˆ·åå¥½é…ç½®é”™è¯¯", "error");
          return;
        }

        generateButton.disabled = true;
        renderStatus(generationStatus, "æ­£åœ¨ç”Ÿæˆè§£è¯»ï¼Œè¯·ç¨å€™...", "info");
        outputSection.style.display = "none";

        const payload = {
          chapterTitle: selectedChapter.title_zh || selectedChapter.title,
          chapterText: selectedChapter.content_zh || selectedChapter.content,
          chapterSummary: selectedChapter.summary || selectedChapter.title_zh || selectedChapter.title,
          // å‘åå…¼å®¹å­—æ®µ
          userProfession: prefConfig.userProfession,
          readingGoal: prefConfig.readingGoal,
          focus: prefConfig.focus,
          density: selectedDensity,
          // æ–°çš„6ä¸ªç»´åº¦å­—æ®µ
          userAge: prefConfig.age,
          userProfessionDetail: prefConfig.profession,
          userReadingGoal: prefConfig.readingGoal,
          userReadingDuration: prefConfig.readingDuration,
          userReadingRhythm: prefConfig.readingRhythm,
          userLifeRole: prefConfig.lifeRole,
          userCurrentFocus: prefConfig.currentFocus,
          userPreferredTitle: prefConfig.preferredTitle,
          userSummary: prefConfig.summary,
        };

        // ä½¿ç”¨åˆ†è§£çš„æç¤ºè¯
        payload.intro_prompt = introPrompt.value.trim();
        payload.body_prompt = bodyPrompt.value.trim();
        payload.quiz_prompt = quizPrompt.value.trim();
        payload.question_prompt = questionPrompt.value.trim();

        try {
          const response = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            signal: AbortSignal.timeout(600000), // 10åˆ†é’Ÿè¶…æ—¶
          });

          if (!response.ok) {
            let errorMessage = "ç”Ÿæˆå¤±è´¥";
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();
          console.log("âœ… æ”¶åˆ°æœåŠ¡å™¨å“åº”:", data);
          console.log("ğŸ“Š data.result:", data.result);
          console.log("ğŸ”§ data.result._debug_info:", data.result?._debug_info);
          console.log("ğŸ§  data.result._thinking_process:", data.result?._thinking_process ? "å­˜åœ¨ï¼ˆé•¿åº¦: " + data.result._thinking_process.length + " å­—ç¬¦ï¼‰" : "ä¸å­˜åœ¨");
          
          renderStatus(generationStatus, "è§£è¯»ç”Ÿæˆå®Œæˆï¼", "success");
          currentInterpretationResult = data.result; // ä¿å­˜è§£è¯»ç»“æœ
          
          // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿä¼šæ˜¾ç¤ºæç¤ºï¼‰
          displayDebugInfo(data.result);
          
          // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿä¼šæ˜¾ç¤ºæç¤ºï¼‰
          displayThinkingProcess(data.result);
          
          // æ˜¾ç¤ºè§£è¯»ç»“æœ
          displayMarkdownResult(data.result);
          
          // å¦‚æœå¯ç”¨äº†æ’­å®¢ï¼Œæ˜¾ç¤ºç”Ÿæˆæ’­å®¢æŒ‰é’®
          if (enablePodcast.checked && data.result) {
            showPodcastButton();
          } else {
            hidePodcastButton();
          }
        } catch (error) {
          console.error("ç”Ÿæˆè§£è¯»å¤±è´¥:", error);
          let errorMessage = "ç”Ÿæˆå¤±è´¥";
          if (error.name === "AbortError" || error.name === "TimeoutError") {
            errorMessage = "è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•";
          } else if (error.message) {
            errorMessage = error.message;
          } else if (error instanceof TypeError && error.message.includes("fetch")) {
            errorMessage = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ";
          }
          renderStatus(generationStatus, errorMessage, "error");
        } finally {
          generateButton.disabled = false;
        }
      }

      // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
      function displayDebugInfo(result) {
        const debugInfoSection = document.getElementById("debugInfoSection");
        const debugInfoContent = document.getElementById("debugInfoContent");
        
        if (!debugInfoSection || !debugInfoContent) {
          console.error("âŒ æ‰¾ä¸åˆ°è°ƒè¯•ä¿¡æ¯åŒºåŸŸçš„DOMå…ƒç´ ï¼");
          return;
        }
        
        console.log("ğŸ”§ displayDebugInfo called with result:", result);
        console.log("ğŸ”§ _debug_info:", result?._debug_info);
        
        // å§‹ç»ˆæ˜¾ç¤ºåŒºåŸŸ
        debugInfoSection.style.display = "block";
        
        if (!result) {
          debugInfoContent.innerHTML = `<div style="color: #f59e0b;">âš ï¸ æœªæ”¶åˆ°ç»“æœæ•°æ®</div>`;
          return;
        }
        
        // å³ä½¿æ²¡æœ‰ _debug_infoï¼Œä¹Ÿæ˜¾ç¤ºä¸€ä¸ªé»˜è®¤çš„è°ƒè¯•ä¿¡æ¯åŒºåŸŸ
        if (!result._debug_info) {
          console.log("âš ï¸ No _debug_info found, showing default debug info");
          const keys = Object.keys(result);
          debugInfoContent.innerHTML = `
            <div style="margin-bottom: 8px; color: #f59e0b;"><strong>âš ï¸ è°ƒè¯•ä¿¡æ¯:</strong> æœªä»æœåŠ¡å™¨è·å–åˆ°è°ƒè¯•ä¿¡æ¯ï¼Œå¯èƒ½åç«¯æœªè¿”å› _debug_info å­—æ®µ</div>
            <div style="margin-bottom: 8px;"><strong>ç»“æœå¯¹è±¡é”®:</strong> ${keys.join(', ')}</div>
            <div style="margin-top: 12px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 12px;">
              <strong>æç¤º:</strong> è¯·æ£€æŸ¥åç«¯ä»£ç ä¸­ call_llm å‡½æ•°æ˜¯å¦æ­£ç¡®æ·»åŠ äº† _debug_info å­—æ®µ
            </div>
          `;
          return;
        }
        
        const info = result._debug_info;
        
        // æ„å»ºå®Œæ•´çš„å‚æ•°æ˜¾ç¤º
        let thinkingDisplay = 'âŒ æœªå¯ç”¨';
        if (info.thinking) {
          if (info.thinking.type === 'enabled') {
            thinkingDisplay = '<span style="color: #059669;">âœ… å·²å¯ç”¨ (type: enabled)</span>';
          } else if (info.thinking.type === 'disabled') {
            thinkingDisplay = '<span style="color: #dc2626;">âŒ å·²ç¦ç”¨ (type: disabled)</span>';
          } else if (info.thinking.type === 'auto') {
            thinkingDisplay = '<span style="color: #f59e0b;">ğŸ”„ è‡ªåŠ¨ (type: auto)</span>';
          } else {
            thinkingDisplay = `<span style="color: #64748b;">${JSON.stringify(info.thinking)}</span>`;
          }
        } else if (info.thinking_mode !== undefined) {
          thinkingDisplay = info.thinking_mode ? '<span style="color: #059669;">âœ… å·²å¯ç”¨</span>' : '<span style="color: #dc2626;">âŒ æœªå¯ç”¨</span>';
        }
        
        debugInfoContent.innerHTML = `
          <div style="margin-bottom: 12px; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">æ¨¡å‹åç§°:</strong> <span style="color: #1e40af; font-weight: 600; font-size: 15px;">${info.model || 'N/A'}</span></div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">è°ƒç”¨æ–¹å¼:</strong> <span style="color: #64748b;">${info.method || 'N/A'}</span></div>
            ${info.base_url ? `<div style="margin-bottom: 8px;"><strong style="color: #475569;">Base URL:</strong> <span style="color: #64748b; font-size: 12px; word-break: break-all;">${info.base_url}</span></div>` : ''}
            ${info.endpoint ? `<div style="margin-bottom: 8px;"><strong style="color: #475569;">APIç«¯ç‚¹:</strong> <span style="color: #64748b; font-size: 12px; word-break: break-all;">${info.endpoint}</span></div>` : ''}
          </div>
          
          <div style="margin-top: 16px; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="margin-bottom: 10px; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">å‚æ•°é…ç½®</div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">Temperature:</strong> <span style="color: #059669; font-weight: 600;">${info.temperature !== undefined ? info.temperature : 0.3}</span></div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">Max Tokens:</strong> <span style="color: #059669; font-weight: 600;">${info.max_tokens !== undefined ? info.max_tokens : 16000}</span></div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">æ·±åº¦æ€è€ƒ (Thinking):</strong> ${thinkingDisplay}</div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">Stream:</strong> ${info.stream ? '<span style="color: #059669;">âœ… å·²å¯ç”¨</span>' : '<span style="color: #dc2626;">âŒ æœªå¯ç”¨</span>'}</div>
          </div>
          
          ${info.thinking ? `<div style="margin-top: 12px; padding: 8px; background: #f0f9ff; border-radius: 4px; font-size: 12px; color: #1e40af;">
            <strong>Thinking å‚æ•°è¯¦æƒ…:</strong> <code style="background: #ffffff; padding: 2px 6px; border-radius: 3px;">${JSON.stringify(info.thinking, null, 2)}</code>
          </div>` : ''}
        `;
      }
      
      // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
      function displayThinkingProcess(result) {
        const thinkingSection = document.getElementById("thinkingProcessSection");
        const thinkingContent = document.getElementById("thinkingProcessContent");
        
        if (!thinkingSection || !thinkingContent) {
          console.error("âŒ æ‰¾ä¸åˆ°æ€è€ƒè¿‡ç¨‹åŒºåŸŸçš„DOMå…ƒç´ ï¼");
          return;
        }
        
        console.log("ğŸ§  displayThinkingProcess called with result:", result);
        console.log("ğŸ§  _thinking_process:", result?._thinking_process ? "å­˜åœ¨ï¼ˆé•¿åº¦: " + result._thinking_process.length + " å­—ç¬¦ï¼‰" : "ä¸å­˜åœ¨");
        
        // å§‹ç»ˆæ˜¾ç¤ºåŒºåŸŸ
        thinkingSection.style.display = "block";
        
        if (!result) {
          thinkingContent.innerHTML = `<div style="color: #f59e0b;">âš ï¸ æœªæ”¶åˆ°ç»“æœæ•°æ®</div>`;
          return;
        }
        
        if (!result._thinking_process) {
          console.log("âš ï¸ No _thinking_process found");
          thinkingContent.innerHTML = `
            <div style="color: #f59e0b; padding: 12px; background: #fef3c7; border-radius: 4px;">
              <strong>âš ï¸ æœªæ£€æµ‹åˆ°æ€è€ƒè¿‡ç¨‹</strong><br>
              <div style="margin-top: 8px; font-size: 13px;">
                å¯èƒ½çš„åŸå› ï¼š<br>
                1. æ¨¡å‹æœªè¿”å›æ€è€ƒè¿‡ç¨‹<br>
                2. æ€è€ƒè¿‡ç¨‹æ ¼å¼æœªè¢«è¯†åˆ«<br>
                3. åç«¯æœªæ­£ç¡®æå–æ€è€ƒè¿‡ç¨‹<br><br>
                ç»“æœå¯¹è±¡é”®: ${Object.keys(result).join(', ')}
              </div>
            </div>
          `;
          return;
        }
        
        thinkingContent.textContent = result._thinking_process;
      }
      
      // æ˜¾ç¤ºMarkdownæ ¼å¼çš„ç»“æœ
      function displayMarkdownResult(result) {
        if (!markdownOutput || !outputSection) {
          console.error("âŒ æ‰¾ä¸åˆ°markdownè¾“å‡ºåŒºåŸŸçš„DOMå…ƒç´ ï¼");
          return;
        }
        
        if (!result) {
          markdownOutput.innerHTML = "<p>æš‚æ— ç»“æœ</p>";
          outputSection.style.display = "block";
          return;
        }

        let markdown = "";
        
        // æ€è€ƒè¿‡ç¨‹å·²ç»åœ¨ç‹¬ç«‹åŒºåŸŸæ˜¾ç¤ºï¼Œè¿™é‡Œä¸å†é‡å¤æ˜¾ç¤º

        if (result.personalized_intro) {
          markdown += `## 1. ä¸ªæ€§åŒ–å¯¼è¯»\n\n${result.personalized_intro}\n\n`;
        }

        if (result.interpretation) {
          markdown += `## 2. æ­£å¼è§£è¯»å†…å®¹\n\n${result.interpretation}\n\n`;
        }

        if (result.summary_and_application) {
          markdown += `## 3. ç« èŠ‚æ€»ç»“ä¸åº”ç”¨\n\n${result.summary_and_application}\n\n`;
        }

        if (result.powerful_questions) {
          markdown += `## 4. å¼ºæœ‰åŠ›çš„æ€è€ƒé—®é¢˜\n\n`;
          if (typeof result.powerful_questions === "string") {
            markdown += `${result.powerful_questions}\n\n`;
          } else if (Array.isArray(result.powerful_questions)) {
            result.powerful_questions.forEach((q) => {
              markdown += `- ${q}\n`;
            });
            markdown += `\n`;
          }
        }

        if (result.quiz && Array.isArray(result.quiz)) {
          markdown += `## 5. ç« èŠ‚è€ƒè¯•\n\n`;
          result.quiz.forEach((item, index) => {
            markdown += `### é¢˜ç›® ${index + 1}\n\n`;
            markdown += `**${item.question || ""}**\n\n`;
            if (item.options && Array.isArray(item.options)) {
              item.options.forEach((opt, idx) => {
                markdown += `${String.fromCharCode(65 + idx)}. ${opt}\n`;
              });
            }
            markdown += `\n**ç­”æ¡ˆï¼š** ${item.answer || "?"}\n\n`;
            if (item.explanation) {
              markdown += `**è§£æï¼š** ${item.explanation}\n\n`;
            }
            markdown += `---\n\n`;
          });
        }

        // ä½¿ç”¨ marked åº“æ¸²æŸ“ Markdown
        if (typeof marked !== "undefined") {
          markdownOutput.innerHTML = marked.parse(markdown);
        } else {
          // é™çº§æ–¹æ¡ˆï¼šç›´æ¥æ˜¾ç¤ºåŸå§‹ Markdown
          markdownOutput.textContent = markdown;
        }

        outputSection.style.display = "block";
        markdownOutput.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // äº‹ä»¶ç›‘å¬
      bookSelect.addEventListener("change", (e) => {
        const bookId = e.target.value;
        if (bookId) {
          loadChapters(bookId);
        } else {
          chapterSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©ä¹¦ç±</option>';
          chapterSelect.disabled = true;
          selectedBook = null;
          selectedChapter = null;
          updateGenerateButton();
        }
      });

      chapterSelect.addEventListener("change", (e) => {
        const chapterId = e.target.value;
        if (chapterId && chapters.length > 0) {
          selectedChapter = chapters.find((ch) => ch.id === parseInt(chapterId));
        } else {
          selectedChapter = null;
        }
        updateGenerateButton();
      });

      // æ˜¾ç¤ºæ’­å®¢æŒ‰é’®
      function showPodcastButton() {
        podcastSection.style.display = "block";
        document.getElementById("podcastButtonContainer").style.display = "block";
        document.getElementById("podcastAudioContainer").style.display = "none";
      }

      // éšè—æ’­å®¢æŒ‰é’®
      function hidePodcastButton() {
        podcastSection.style.display = "none";
      }

      // ä»ç»“æœç”Ÿæˆæ’­å®¢ï¼ˆç‚¹å‡»æŒ‰é’®æ—¶è°ƒç”¨ï¼‰
      async function generatePodcastFromResult() {
        if (!currentInterpretationResult) {
          podcastStatus.textContent = "æ²¡æœ‰å¯ç”¨çš„è§£è¯»ç»“æœ";
          return;
        }
        await generatePodcast(currentInterpretationResult);
      }

      // ç”Ÿæˆæ’­å®¢éŸ³é¢‘
      async function generatePodcast(interpretationResult) {
        if (!interpretationResult) {
          return;
        }
        
        // ç»„åˆè§£è¯»æ–‡æœ¬
        let podcastText = "";
        if (interpretationResult.personalized_intro) {
          podcastText += interpretationResult.personalized_intro + "\n\n";
        }
        if (interpretationResult.interpretation) {
          podcastText += interpretationResult.interpretation + "\n\n";
        }
        if (interpretationResult.summary_and_application) {
          podcastText += interpretationResult.summary_and_application + "\n\n";
        }
        
        if (!podcastText.trim()) {
          podcastStatus.textContent = "æ²¡æœ‰å¯ç”¨çš„æ–‡æœ¬å†…å®¹ç”Ÿæˆæ’­å®¢";
          return;
        }
        
        // éšè—æŒ‰é’®ï¼Œæ˜¾ç¤ºéŸ³é¢‘å®¹å™¨
        document.getElementById("podcastButtonContainer").style.display = "none";
        document.getElementById("podcastAudioContainer").style.display = "block";
        podcastStatus.textContent = "æ­£åœ¨ç”Ÿæˆæ’­å®¢éŸ³é¢‘...";
        podcastAudio.src = "";
        currentAudioBlob = null;
        
        try {
          const podcastPayload = {
            text: podcastText,
            voice_type: voiceType.value,
            language: "zh",
            speed_ratio: 1.0,
            volume_ratio: 1.0,
            pitch_ratio: 1.0,
          };
          
          const response = await fetch("/api/podcast/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(podcastPayload),
            signal: AbortSignal.timeout(120000), // 2åˆ†é’Ÿè¶…æ—¶
          });
          
          if (!response.ok) {
            let errorMessage = "ç”Ÿæˆæ’­å®¢å¤±è´¥";
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }
          
          const data = await response.json();
          
          // å°†Base64éŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºBlob
          const audioBytes = Uint8Array.from(atob(data.audio_base64), c => c.charCodeAt(0));
          currentAudioBlob = new Blob([audioBytes], { type: "audio/mpeg" });
          const audioUrl = URL.createObjectURL(currentAudioBlob);
          
          podcastAudio.src = audioUrl;
          podcastStatus.textContent = `æ’­å®¢ç”ŸæˆæˆåŠŸï¼æ—¶é•¿ï¼š${data.duration || "æœªçŸ¥"}ç§’`;
        } catch (error) {
          console.error("ç”Ÿæˆæ’­å®¢å¤±è´¥:", error);
          podcastStatus.textContent = `ç”Ÿæˆæ’­å®¢å¤±è´¥: ${error.message}`;
          podcastStatus.style.color = "#b91c1c";
        }
      }
      
      // ä¸‹è½½æ’­å®¢éŸ³é¢‘
      downloadPodcast.addEventListener("click", () => {
        if (!currentAudioBlob) {
          alert("æ²¡æœ‰å¯ä¸‹è½½çš„éŸ³é¢‘");
          return;
        }
        
        const url = URL.createObjectURL(currentAudioBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `æ’­å®¢_${selectedChapter?.title_zh || selectedChapter?.title || "è§£è¯»"}_${new Date().getTime()}.mp3`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
      
      // æ’­å®¢é…ç½®æ˜¾ç¤º/éšè—
      enablePodcast.addEventListener("change", (e) => {
        podcastConfig.style.display = e.target.checked ? "flex" : "none";
      });
      
      // åˆå§‹åŒ–ï¼šåŠ è½½æç¤ºè¯å¹¶è®¾ç½®ç¬¬ä¸€ä¸ªæ ‡ç­¾ä¸ºæ¿€æ´»çŠ¶æ€
      document.addEventListener("DOMContentLoaded", () => {
        loadPromptParts();
        switchPromptTab("intro");
        selectDensity(selectedDensity);
      });

      generateButton.addEventListener("click", generateInterpretation);

      // åˆå§‹åŒ–
      loadBooks();
    </script>
  </body>
</html>
