<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ä¸ªæ€§åŒ–è§£è¯»ç”Ÿæˆæµ‹è¯•å°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      :root {
        color-scheme: light;
        font-family: "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        background-color: #f8fafc;
        color: #0f172a;
      }

      /* å¯¼èˆªæ æ ·å¼ */
      .top-navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 20px;
        margin: -24px -24px 24px -24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .nav-container {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        flex-wrap: wrap;
      }

      .nav-brand {
        color: white;
        font-weight: 600;
        font-size: 18px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-brand:hover {
        opacity: 0.9;
      }

      .nav-links {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .nav-link {
        color: white;
        text-decoration: none;
        padding: 8px 14px;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .nav-link.active {
        background: rgba(255, 255, 255, 0.25);
        font-weight: 500;
      }

      body {
        margin: 0;
        padding: 24px;
        max-width: 1600px;
        margin: 0 auto;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 32px;
        font-weight: 600;
        color: #0f172a;
      }

      .subtitle {
        color: #64748b;
        font-size: 14px;
        margin-bottom: 32px;
      }

      .panel {
        background: #ffffff;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 24px;
        border: 1px solid #e2e8f0;
      }

      .panel h2 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      label {
        font-weight: 600;
        font-size: 14px;
        color: #475569;
      }

      select,
      input[type="text"],
      textarea {
        padding: 10px 14px;
        border: 1.5px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: #ffffff;
      }

      select:focus,
      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      .user-preference-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 12px;
      }

      @media (max-width: 768px) {
        .user-preference-group {
          grid-template-columns: 1fr;
        }
      }

      .preference-card {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #ffffff;
      }

      .preference-card:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
      }

      .preference-card.selected {
        border-color: #2563eb;
        background: #eff6ff;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .preference-label {
        font-weight: 600;
        font-size: 16px;
        color: #1e293b;
        margin-bottom: 8px;
      }

      .preference-desc {
        font-size: 13px;
        color: #64748b;
        line-height: 1.8;
      }

      .preference-dimension {
        margin-bottom: 8px;
        padding: 6px 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .preference-dimension:nth-child(6) {
        border-bottom: none;
      }

      .preference-summary {
        margin-top: 12px;
        padding: 12px;
        background: #eff6ff;
        border-radius: 6px;
        border-left: 3px solid #2563eb;
        color: #1e40af;
        font-weight: 500;
      }

      .density-selection {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px dashed #e2e8f0;
      }

      .density-options {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .density-option {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 12px 18px;
        background: #ffffff;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 160px;
        text-align: left;
      }

      .density-option strong {
        display: block;
        font-size: 14px;
        color: #1e293b;
        margin-bottom: 4px;
      }

      .density-option span {
        font-size: 12px;
        color: #64748b;
      }

      .density-option.active {
        border-color: #2563eb;
        background: #eff6ff;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      }

      .prompt-tab {
        padding: 10px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: #ffffff;
        color: #64748b;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .prompt-tab:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
      }

      .prompt-tab.active {
        border-color: #2563eb;
        background: #eff6ff;
        color: #2563eb;
      }

      .prompt-tab-panel {
        animation: fadeIn 0.2s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      button {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        background: #2563eb;
        color: white;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      button:disabled {
        background: #cbd5e1;
        color: #94a3b8;
        cursor: not-allowed;
        transform: none;
      }
      
      #tocSummaryButton:disabled {
        background: #94a3b8 !important;
        color: white !important;
        opacity: 0.7;
        cursor: not-allowed;
      }
      
      #tocSummaryButton:not(:disabled):hover {
        background: #4f46e5 !important;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }

      .status {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        background: #f1f5f9;
        border-left: 4px solid #cbd5e1;
      }

      .status.info {
        background: #eff6ff;
        border-left-color: #3b82f6;
        color: #1e40af;
      }

      .status.success {
        background: #f0fdf4;
        border-left-color: #10b981;
        color: #065f46;
      }

      .status.error {
        background: #fef2f2;
        border-left-color: #ef4444;
        color: #991b1b;
      }

      .loading {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .output-panel {
        background: #ffffff;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        margin-top: 24px;
      }

      .markdown-output {
        padding: 24px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        line-height: 1.8;
        color: #1e293b;
        max-height: 80vh;
        overflow-y: auto;
      }

      .markdown-output h1,
      .markdown-output h2,
      .markdown-output h3 {
        color: #1e293b;
        margin-top: 24px;
        margin-bottom: 12px;
      }

      .markdown-output h1 {
        font-size: 24px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 8px;
      }

      .markdown-output h2 {
        font-size: 20px;
      }

      .markdown-output h3 {
        font-size: 18px;
      }

      .markdown-output p {
        margin-bottom: 12px;
      }

      .markdown-output ul,
      .markdown-output ol {
        margin-bottom: 12px;
        padding-left: 24px;
      }

      .markdown-output li {
        margin-bottom: 6px;
      }

      .markdown-output code {
        background: #f1f5f9;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 13px;
        font-family: "Monaco", "Menlo", monospace;
      }

      .markdown-output pre {
        background: #1e293b;
        color: #f1f5f9;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin-bottom: 12px;
      }

      .markdown-output pre code {
        background: transparent;
        padding: 0;
        color: inherit;
      }

      .markdown-output blockquote {
        border-left: 4px solid #2563eb;
        padding-left: 16px;
        margin-left: 0;
        color: #475569;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <!-- å¯¼èˆªæ  -->
    <nav class="top-navbar">
      <div class="nav-container">
        <a href="/" class="nav-brand">ğŸ“š PDFè§£è¯»ç³»ç»Ÿ</a>
        <div class="nav-links">
          <a href="/" class="nav-link">ğŸ  é¦–é¡µ</a>
          <a href="/aigen_test_page.html" class="nav-link">âœ¨ ä¸ªæ€§åŒ–è§£è¯»</a>
          <a href="/test_doubao_thinking.html" class="nav-link">ğŸ§  æ·±åº¦æ€è€ƒæµ‹è¯•</a>
          <a href="/test_thinking.html" class="nav-link">ğŸ”¬ æ€è€ƒæ¨¡å‹æµ‹è¯•</a>
          <a href="/parser_test_page.html" class="nav-link">ğŸ“„ æ–‡æ¡£è§£æ</a>
          <a href="/admin_books.html" class="nav-link">ğŸ“– ä¹¦ç±ç®¡ç†</a>
          <a href="/admin.html" class="nav-link">âš™ï¸ ç³»ç»Ÿç®¡ç†</a>
        </div>
      </div>
    </nav>

    <h1>ğŸ“– ä¸ªæ€§åŒ–è§£è¯»ç”Ÿæˆæµ‹è¯•å°</h1>
    <p class="subtitle">é€‰æ‹©ä¹¦ç±å’Œç« èŠ‚ï¼Œé…ç½®è§£è¯»æç¤ºè¯å’Œç”¨æˆ·åå¥½ï¼Œç”Ÿæˆä¸ªæ€§åŒ–è§£è¯»å†…å®¹</p>

    <!-- TAB åˆ‡æ¢æŒ‰é’® -->
    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px;">
      <button id="mainTabBtn" class="prompt-tab active" onclick="switchMainTab('main')" style="padding: 12px 24px; font-size: 16px; font-weight: 600;">âœ¨ ä¸ªæ€§åŒ–è§£è¯»</button>
      <button id="restructureTabBtn" class="prompt-tab" onclick="switchMainTab('restructure')" style="padding: 12px 24px; font-size: 16px; font-weight: 600;">ğŸ“š ä¹¦ç±é‡æ„</button>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸï¼šä¸ªæ€§åŒ–è§£è¯» -->
    <div id="mainTabContent">
    <section class="panel">
      <h2>ğŸ“š é€‰æ‹©ä¹¦ç±å’Œç« èŠ‚</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="bookSelect">é€‰æ‹©ä¹¦ç±</label>
          <select id="bookSelect">
            <option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="chapterSelect">é€‰æ‹©ç« èŠ‚</label>
          <select id="chapterSelect" disabled>
            <option value="">è¯·å…ˆé€‰æ‹©ä¹¦ç±</option>
          </select>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>âœï¸ è§£è¯»æç¤ºè¯è°ƒé€‚</h2>
      <p style="color: #64748b; font-size: 14px; margin-bottom: 16px;">åˆ†åˆ«ä¼˜åŒ–å„ä¸ªéƒ¨åˆ†çš„æç¤ºè¯ï¼Œä»¥è·å¾—æ›´å¥½çš„è§£è¯»æ•ˆæœ</p>
      
      <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px;">
        <button class="prompt-tab" data-tab="intro" onclick="switchPromptTab('intro')">ğŸ“– å¯¼è¯»éƒ¨åˆ†</button>
        <button class="prompt-tab" data-tab="body" onclick="switchPromptTab('body')">ğŸ“ æ­£æ–‡éƒ¨åˆ†</button>
        <button class="prompt-tab" data-tab="quiz" onclick="switchPromptTab('quiz')">â“ äº’åŠ¨é—®ç­”</button>
        <button class="prompt-tab" data-tab="question" onclick="switchPromptTab('question')">ğŸ’¡ ä¸€å¥è¯é—®é¢˜</button>
      </div>
      
      <div id="promptTabContent">
        <div class="prompt-tab-panel" id="promptTabIntro" style="display: block;">
          <div class="form-group full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label for="introPrompt" style="margin: 0;">å¯¼è¯»éƒ¨åˆ†æç¤ºè¯ï¼ˆåŸºäºç« èŠ‚æ‘˜è¦ç”Ÿæˆï¼‰</label>
              <button class="secondary" onclick="generateSinglePart('intro')" id="generateIntroBtn" style="padding: 8px 16px; font-size: 14px;">ğŸš€ å•ç‹¬ç”Ÿæˆå¯¼è¯»</button>
            </div>
            <textarea id="introPrompt" rows="12" placeholder="è¾“å…¥å¯¼è¯»éƒ¨åˆ†çš„æç¤ºè¯..."></textarea>
            <div id="introResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
          </div>
        </div>
        <div class="prompt-tab-panel" id="promptTabBody" style="display: none;">
          <div class="form-group full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label for="bodyPrompt" style="margin: 0;">æ­£æ–‡éƒ¨åˆ†æç¤ºè¯ï¼ˆåŸºäºç« èŠ‚æ­£æ–‡å†…å®¹ç”Ÿæˆï¼‰</label>
              <button class="secondary" onclick="generateSinglePart('body')" id="generateBodyBtn" style="padding: 8px 16px; font-size: 14px;">ğŸš€ å•ç‹¬ç”Ÿæˆæ­£æ–‡</button>
            </div>
            <textarea id="bodyPrompt" rows="20" placeholder="è¾“å…¥æ­£æ–‡éƒ¨åˆ†çš„æç¤ºè¯..."></textarea>
            <div id="bodyResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
          </div>
        </div>
        <div class="prompt-tab-panel" id="promptTabQuiz" style="display: none;">
          <div class="form-group full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label for="quizPrompt" style="margin: 0;">äº’åŠ¨é—®ç­”æç¤ºè¯</label>
              <button class="secondary" onclick="generateSinglePart('quiz')" id="generateQuizBtn" style="padding: 8px 16px; font-size: 14px;">ğŸš€ å•ç‹¬ç”Ÿæˆé—®ç­”</button>
            </div>
            <textarea id="quizPrompt" rows="12" placeholder="è¾“å…¥äº’åŠ¨é—®ç­”éƒ¨åˆ†çš„æç¤ºè¯..."></textarea>
            <div id="quizResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
          </div>
        </div>
        <div class="prompt-tab-panel" id="promptTabQuestion" style="display: none;">
          <div class="form-group full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label for="questionPrompt" style="margin: 0;">ä¸€å¥è¯é—®é¢˜æç¤ºè¯</label>
              <button class="secondary" onclick="generateSinglePart('question')" id="generateQuestionBtn" style="padding: 8px 16px; font-size: 14px;">ğŸš€ å•ç‹¬ç”Ÿæˆé—®é¢˜</button>
            </div>
            <textarea id="questionPrompt" rows="12" placeholder="è¾“å…¥ä¸€å¥è¯é—®é¢˜éƒ¨åˆ†çš„æç¤ºè¯..."></textarea>
            <div id="questionResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
          </div>
        </div>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button class="secondary" onclick="loadPromptParts()">ğŸ“¥ åŠ è½½å·²ä¿å­˜</button>
        <button class="secondary" onclick="savePromptParts()">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
      </div>
      <div class="status" id="promptStatus" style="display: none;"></div>
    </section>

    <section class="panel">
      <h2>ğŸ‘¤ ç”¨æˆ·åå¥½è®¾ç½®</h2>
      <p style="color: #64748b; font-size: 14px; margin-bottom: 16px;">å…ˆé€‰æ‹©é˜…è¯»è§’è‰²ï¼Œå†é€‰æ‹©è§£è¯»å¯†åº¦ï¼Œä»¥æ¨¡æ‹Ÿä¸åŒè¯»è€…çš„éœ€æ±‚</p>
      <div class="user-preference-group">
        <div class="preference-card" data-preference="A" onclick="selectPreference('A')">
          <div class="preference-label">A. åˆ›ä¸šå…¬å¸ CEO</div>
          <div class="preference-desc" id="preferenceDescA">
            <div class="preference-dimension"><strong>1. å¹´é¾„ & èŒä¸šï¼š</strong>38å²ï¼Œåˆ›ä¸šå…¬å¸CEO</div>
            <div class="preference-dimension"><strong>2. é˜…è¯»ç›®çš„ï¼š</strong>æå‡æˆ˜ç•¥å†³ç­–èƒ½åŠ›ã€å›¢é˜Ÿç®¡ç†å’Œå•†ä¸šæ´å¯ŸåŠ›ï¼Œå¯»æ‰¾å¢é•¿æ æ†</div>
            <div class="preference-dimension"><strong>3. é˜…è¯»æ—¶é•¿ & èŠ‚å¥ï¼š</strong>å•æ¬¡30-45åˆ†é’Ÿï¼Œç¢ç‰‡åŒ–é˜…è¯»ï¼Œå¸¸åœ¨é€šå‹¤ã€åˆä¼‘æ—¶é˜…è¯»</div>
            <div class="preference-dimension"><strong>4. ç”Ÿæ´»è§’è‰²èº«ä»½ï¼š</strong>åˆ›ä¸šè€…ã€å›¢é˜Ÿç®¡ç†è€…ã€çˆ¶äº²</div>
            <div class="preference-dimension"><strong>5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘ï¼š</strong>å†³ç­–é€Ÿåº¦ä¸è´¨é‡ã€å›¢é˜Ÿæ¿€åŠ±ä¸èµ‹èƒ½ã€å•†ä¸šæ¨¡å¼åˆ›æ–°</div>
            <div class="preference-dimension"><strong>6. ç§°å‘¼åå¥½ï¼š</strong>ææ€»</div>
            <div class="preference-summary"><strong>ç”¨æˆ·ç‰¹å¾ï¼š</strong>ä¸€ä¸ªéœ€è¦åœ¨æœ‰é™æ—¶é—´å†…å¿«é€ŸæŠ“ä½å•†ä¸šæ æ†ç‚¹ã€ç”¨äºå®æˆ˜å†³ç­–çš„åˆ›ä¸šæŒèˆµäºº</div>
          </div>
        </div>
        <div class="preference-card" data-preference="B" onclick="selectPreference('B')">
          <div class="preference-label">B. äº§å“ç»ç†</div>
          <div class="preference-desc" id="preferenceDescB">
            <div class="preference-dimension"><strong>1. å¹´é¾„ & èŒä¸šï¼š</strong>30å²ï¼Œäº§å“ç»ç†</div>
            <div class="preference-dimension"><strong>2. é˜…è¯»ç›®çš„ï¼š</strong>æ·±å…¥ç†è§£ç”¨æˆ·å¿ƒç†ã€äº§å“è®¾è®¡åŸç†å’Œå•†ä¸šé€»è¾‘ï¼Œæå‡äº§å“æ€ç»´</div>
            <div class="preference-dimension"><strong>3. é˜…è¯»æ—¶é•¿ & èŠ‚å¥ï¼š</strong>å•æ¬¡1-1.5å°æ—¶ï¼Œåå¥½æ·±åº¦é˜…è¯»ï¼Œé€šå¸¸åœ¨æ™šä¸Šæˆ–å‘¨æœ«</div>
            <div class="preference-dimension"><strong>4. ç”Ÿæ´»è§’è‰²èº«ä»½ï¼š</strong>èŒåœºä¸“ä¸šäººå£«ã€äº§å“è´Ÿè´£äºº</div>
            <div class="preference-dimension"><strong>5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘ï¼š</strong>ç”¨æˆ·æ´å¯Ÿèƒ½åŠ›ã€äº§å“è®¾è®¡æ€ç»´ã€æ•°æ®åˆ†æèƒ½åŠ›</div>
            <div class="preference-dimension"><strong>6. ç§°å‘¼åå¥½ï¼š</strong>å°ç‹</div>
            <div class="preference-summary"><strong>ç”¨æˆ·ç‰¹å¾ï¼š</strong>ä¸€ä¸ªè¿½æ±‚æ·±åº¦ç†è§£ç”¨æˆ·å¿ƒç†å’Œäº§å“é€»è¾‘ï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿæ€§æ€ç»´æå‡äº§å“å†³ç­–èƒ½åŠ›çš„äº§å“ç»ç†</div>
          </div>
        </div>
        <div class="preference-card" data-preference="C" onclick="selectPreference('C')">
          <div class="preference-label">C. çŸ¥è¯†å·¥ä½œè€…</div>
          <div class="preference-desc" id="preferenceDescC">
            <div class="preference-dimension"><strong>1. å¹´é¾„ & èŒä¸šï¼š</strong>33å²ï¼ŒçŸ¥è¯†å·¥ä½œè€…ï¼ˆå’¨è¯¢é¡¾é—®/åŸ¹è®­å¸ˆ/ç ”ç©¶å‘˜ï¼‰</div>
            <div class="preference-dimension"><strong>2. é˜…è¯»ç›®çš„ï¼š</strong>ç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ï¼Œæ¢ç´¢è·¨é¢†åŸŸæ€ç»´ï¼Œæå‡ä¸“ä¸šæ·±åº¦å’Œå¹¿åº¦</div>
            <div class="preference-dimension"><strong>3. é˜…è¯»æ—¶é•¿ & èŠ‚å¥ï¼š</strong>å•æ¬¡2-3å°æ—¶ï¼Œæ²‰æµ¸å¼æ·±åº¦é˜…è¯»ï¼Œä¸»è¦åœ¨å‘¨æœ«æˆ–å‡æœŸ</div>
            <div class="preference-dimension"><strong>4. ç”Ÿæ´»è§’è‰²èº«ä»½ï¼š</strong>ç‹¬ç«‹ä¸“ä¸šäººå£«ã€çŸ¥è¯†ä¼ æ’­è€…ã€æ€è€ƒè€…</div>
            <div class="preference-dimension"><strong>5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘ï¼š</strong>è·¨å­¦ç§‘æ€ç»´èƒ½åŠ›ã€çŸ¥è¯†æ•´åˆã€è®¤çŸ¥æ·±åº¦</div>
            <div class="preference-dimension"><strong>6. ç§°å‘¼åå¥½ï¼š</strong>è€å¸ˆ</div>
            <div class="preference-summary"><strong>ç”¨æˆ·ç‰¹å¾ï¼š</strong>ä¸€ä¸ªç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ã€è¿½æ±‚æ·±åº¦ç†è§£å’Œè·¨é¢†åŸŸæ€è€ƒçš„çŸ¥è¯†å·¥ä½œè€…</div>
          </div>
        </div>
        <div class="preference-card" data-preference="D" onclick="selectPreference('D')">
          <div class="preference-label">D. å¿™ç¢Œçš„èŒåœºäººå£«</div>
          <div class="preference-desc" id="preferenceDescD">
            <div class="preference-dimension"><strong>1. å¹´é¾„ & èŒä¸šï¼š</strong>28å²ï¼Œå…¬å¸ä¸­å±‚ç®¡ç†è€…æˆ–é«˜çº§æ‰§è¡Œè€…</div>
            <div class="preference-dimension"><strong>2. é˜…è¯»ç›®çš„ï¼š</strong>å¿«é€Ÿè·å–æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®æ´å¯Ÿï¼Œæé«˜å·¥ä½œæ•ˆç‡å’Œå†³ç­–èƒ½åŠ›</div>
            <div class="preference-dimension"><strong>3. é˜…è¯»æ—¶é•¿ & èŠ‚å¥ï¼š</strong>å•æ¬¡15-30åˆ†é’Ÿï¼Œç¢ç‰‡åŒ–é˜…è¯»ï¼Œä¸»è¦åœ¨é€šå‹¤æˆ–çŸ­æš‚ä¼‘æ¯æ—¶é—´</div>
            <div class="preference-dimension"><strong>4. ç”Ÿæ´»è§’è‰²èº«ä»½ï¼š</strong>èŒåœºå¥‹æ–—è€…ã€å¯èƒ½ä¹Ÿæ˜¯çˆ¶æ¯ã€å®¶åº­è´£ä»»æ‰¿æ‹…è€…</div>
            <div class="preference-dimension"><strong>5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘ï¼š</strong>æ—¶é—´ç®¡ç†ã€å†³ç­–æ•ˆç‡ã€å¿«é€Ÿå­¦ä¹ èƒ½åŠ›</div>
            <div class="preference-dimension"><strong>6. ç§°å‘¼åå¥½ï¼š</strong>å°é™ˆ</div>
            <div class="preference-summary"><strong>ç”¨æˆ·ç‰¹å¾ï¼š</strong>ä¸€ä¸ªæ—¶é—´æœ‰é™ã€è¿½æ±‚å¿«é€Ÿè·å–å¯è½åœ°æ ¸å¿ƒè§‚ç‚¹å¹¶ç«‹å³åº”ç”¨çš„èŒåœºå®å¹²æ´¾</div>
          </div>
        </div>
      </div>

      <div class="density-selection">
        <label style="font-weight: 600; color: #475569;">è§£è¯»å¯†åº¦</label>
        <div class="density-options">
          <button type="button" class="density-option" data-density="20% ä¸»å¹²" onclick="selectDensity('20% ä¸»å¹²')">
            <strong>20% ä¸»å¹²</strong>
            <span>åªä¿ç•™ä¸»çº¿ç»“è®º + æ ¸å¿ƒæ¨ç†ï¼Œçº¦ 3-4 ä¸ªè¦ç‚¹</span>
          </button>
          <button type="button" class="density-option" data-density="50% æ ¸å¿ƒ" onclick="selectDensity('50% æ ¸å¿ƒ')">
            <strong>50% æ ¸å¿ƒ</strong>
            <span>åœ¨ä¸»å¹²ä¸Šè¡¥å……å…³é”®ä¾‹è¯å’Œç»†èŠ‚ï¼Œçº¦ 5-7 ä¸ªè¦ç‚¹</span>
          </button>
          <button type="button" class="density-option" data-density="70% æ·±åº¦" onclick="selectDensity('70% æ·±åº¦')">
            <strong>70% æ·±åº¦</strong>
            <span>è¦†ç›–é‡è¦åˆ†æ”¯ä¸ç›²ç‚¹æé†’ï¼Œçº¦ 8-12 ä¸ªè¦ç‚¹</span>
          </button>
        </div>
      </div>

      <input type="hidden" id="selectedPreference" value="" />
    </section>

    <section class="panel">
      <h2>ğŸ™ï¸ æ’­å®¢é…ç½®</h2>
      <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="enablePodcast" checked /> ç”Ÿæˆæ’­å®¢éŸ³é¢‘
        </label>
        <div id="podcastConfig" style="display: flex; align-items: center; gap: 8px;">
          <label for="voiceType" style="margin: 0; white-space: nowrap;">éŸ³è‰²ï¼š</label>
          <select id="voiceType" style="min-width: 120px;">
            <option value="BV700_streaming">æ ‡å‡†å¥³å£°</option>
            <option value="BV701_streaming">æ¸©æŸ”å¥³å£°</option>
            <option value="BV702_streaming">çŸ¥æ€§å¥³å£°</option>
            <option value="BV703_streaming">æ´»æ³¼å¥³å£°</option>
            <option value="BV001_streaming">æ ‡å‡†ç”·å£°</option>
            <option value="BV002_streaming">ç£æ€§ç”·å£°</option>
            <option value="BV003_streaming">æ²‰ç¨³ç”·å£°</option>
          </select>
        </div>
      </div>
    </section>

    <section class="panel">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <h2 style="margin: 0;">ğŸš€ ç”Ÿæˆè§£è¯»</h2>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button id="tocSummaryButton" class="secondary" disabled style="padding: 10px 20px; font-size: 14px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; white-space: nowrap;">ğŸ“‹ ç›®å½•ä¸æ‘˜è¦è¯»å–</button>
          <button id="generateButton" disabled>ç”Ÿæˆè§£è¯»</button>
        </div>
      </div>
      <div class="status" id="generationStatus" style="display: none;"></div>
    </section>

    <!-- è°ƒè¯•ä¿¡æ¯å’Œæ€è€ƒè¿‡ç¨‹åŒºåŸŸ - å§‹ç»ˆæ˜¾ç¤º -->
    <section class="panel" style="margin-top: 24px;">
      <!-- è°ƒè¯•ä¿¡æ¯åŒºåŸŸ -->
      <div id="debugInfoSection" style="display: block; margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h3 style="margin-top: 0; color: #475569; font-size: 16px; margin-bottom: 12px;">ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
        <div id="debugInfoContent" style="font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #64748b; line-height: 1.6;">
          <div style="color: #94a3b8; font-style: italic;">ç­‰å¾…ç”Ÿæˆç»“æœ...</div>
        </div>
      </div>
      
      <!-- æ·±åº¦æ€è€ƒè¿‡ç¨‹åŒºåŸŸ -->
      <div id="thinkingProcessSection" style="display: block; margin-bottom: 24px; padding: 20px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #3b82f6;">
        <h3 style="margin-top: 0; color: #1e40af; font-size: 18px; margin-bottom: 12px;">ğŸ§  æ·±åº¦æ€è€ƒè¿‡ç¨‹</h3>
        <div id="thinkingProcessContent" style="color: #1e293b; line-height: 1.8; white-space: pre-wrap; max-height: 400px; overflow-y: auto; padding: 12px; background: #ffffff; border-radius: 8px; border: 1px solid #bfdbfe;">
          <div style="color: #94a3b8; font-style: italic;">ç­‰å¾…ç”Ÿæˆç»“æœ...</div>
        </div>
      </div>
    </section>

    <section class="output-panel" id="outputSection" style="display: none;">
      <h2>ğŸ“„ è§£è¯»ç»“æœ</h2>
      <div id="tocSummaryResult" style="display: none; margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0; color: #1e293b; font-size: 16px;">ğŸ“‹ ç›®å½•ä¸æ‘˜è¦</h3>
          <button id="copyTocSummaryButton" class="secondary" style="padding: 6px 12px; font-size: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ“‹ å¤åˆ¶æ–‡æœ¬</button>
        </div>
        <textarea id="tocSummaryText" readonly style="width: 100%; min-height: 300px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; line-height: 1.6; background: #ffffff; resize: vertical;"></textarea>
      </div>
      <div class="markdown-output" id="markdownOutput"></div>
      <div id="podcastSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
        <h3 style="margin-top: 0;">ğŸ™ï¸ æ’­å®¢éŸ³é¢‘</h3>
        <div id="podcastButtonContainer" style="margin-bottom: 16px;">
          <button id="generatePodcastButton" class="secondary" onclick="generatePodcastFromResult()">ğŸ™ï¸ ç”Ÿæˆæ’­å®¢</button>
        </div>
        <div id="podcastAudioContainer" style="display: none;">
          <audio id="podcastAudio" controls style="width: 100%; margin-bottom: 12px;"></audio>
          <div style="display: flex; gap: 12px;">
            <button id="downloadPodcast" class="secondary">ä¸‹è½½éŸ³é¢‘</button>
            <span id="podcastStatus" style="color: #64748b; font-size: 14px;"></span>
          </div>
        </div>
      </div>
    </section>
    </div>
    <!-- ä¸»å†…å®¹åŒºåŸŸç»“æŸ -->

    <!-- ä¹¦ç±é‡æ„ TAB å†…å®¹ -->
    <div id="restructureTabContent" style="display: none;">
      <section class="panel">
        <h2>ğŸ“š ä¹¦ç±é‡æ„</h2>
        <p style="color: #64748b; font-size: 14px; margin-bottom: 16px;">é€‰æ‹©ä¹¦ç±ï¼Œè¾“å…¥é‡æ„æç¤ºè¯ï¼Œä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å‹ç”Ÿæˆæ–°çš„ç›®å½•ç»“æ„</p>
        
        <div class="form-grid" style="margin-bottom: 16px;">
          <div class="form-group">
            <label for="restructureBookSelect">é€‰æ‹©ä¹¦ç±</label>
            <select id="restructureBookSelect">
              <option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="restructureMaxWords">åˆ†å‰²å­—æ•°ä¸Šé™ï¼ˆæ¯æ®µæœ€å¤§å­—æ•°ï¼‰</label>
            <input type="number" id="restructureMaxWords" value="5000" min="1000" max="20000" step="500" style="width: 100%; padding: 8px; border: 1.5px solid #cbd5e1; border-radius: 6px; font-size: 14px;" />
          </div>
        </div>

        <div class="form-group full-width" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label for="restructurePrompt" style="margin: 0;">é‡æ„æç¤ºè¯</label>
            <button id="restructureTocButton" class="secondary" disabled style="padding: 10px 20px; font-size: 14px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">ğŸ”„ é‡æ„ç›®å½•</button>
          </div>
          <textarea id="restructurePrompt" rows="10" placeholder="è¾“å…¥é‡æ„æç¤ºè¯ï¼Œä¾‹å¦‚ï¼šè¯·æ ¹æ®åŸä¹¦ç±çš„ç›®å½•å’Œæ‘˜è¦ï¼Œé‡æ–°è®¾è®¡ä¸€ä¸ªæ›´æ¸…æ™°çš„ç›®å½•ç»“æ„..."></textarea>
        </div>

        <div id="restructureResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; color: #1e293b; font-size: 16px;">ğŸ“‹ é‡æ„åçš„ç›®å½•</h3>
            <button id="generateNewBookButton" class="secondary" disabled style="padding: 8px 16px; font-size: 14px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">ğŸ“– æ–°ä¹¦ç”Ÿæˆ</button>
          </div>
          <div id="restructureResultContent" style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #e2e8f0; max-height: 500px; overflow-y: auto;"></div>
        </div>

        <div id="newBookResult" style="display: none; margin-top: 16px; padding: 16px; background: #f0fdf4; border-radius: 8px; border: 1px solid #86efac;">
          <h3 style="margin: 0 0 12px 0; color: #065f46; font-size: 16px;">âœ… æ–°ä¹¦ç”Ÿæˆå®Œæˆ</h3>
          <div id="newBookResultContent" style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #86efac; max-height: 600px; overflow-y: auto;"></div>
        </div>

        <div class="status" id="restructureStatus" style="display: none; margin-top: 16px;"></div>
      </section>
    </div>
    <!-- ä¹¦ç±é‡æ„ TAB å†…å®¹ç»“æŸ -->

    <script>
      const bookSelect = document.getElementById("bookSelect");
      const chapterSelect = document.getElementById("chapterSelect");
      const promptStatus = document.getElementById("promptStatus");
      const selectedPreference = document.getElementById("selectedPreference");
      const generateButton = document.getElementById("generateButton");
      const generationStatus = document.getElementById("generationStatus");
      const outputSection = document.getElementById("outputSection");
      const markdownOutput = document.getElementById("markdownOutput");
      
      // æç¤ºè¯ç›¸å…³å…ƒç´ 
      const introPrompt = document.getElementById("introPrompt");
      const bodyPrompt = document.getElementById("bodyPrompt");
      const quizPrompt = document.getElementById("quizPrompt");
      const questionPrompt = document.getElementById("questionPrompt");
      
      // æ’­å®¢ç›¸å…³å…ƒç´ 
      const enablePodcast = document.getElementById("enablePodcast");
      const podcastConfig = document.getElementById("podcastConfig");
      const voiceType = document.getElementById("voiceType");
      const podcastSection = document.getElementById("podcastSection");
      const podcastAudio = document.getElementById("podcastAudio");
      const downloadPodcast = document.getElementById("downloadPodcast");
      const podcastStatus = document.getElementById("podcastStatus");
      
      let currentAudioBlob = null;

      let books = [];
      let chapters = [];
      let selectedBook = null;
      let selectedChapter = null;
      let currentInterpretationResult = null; // å­˜å‚¨å½“å‰çš„è§£è¯»ç»“æœ

      /**
       * ä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å‹è¿›è¡Œå†…å®¹è§£è¯»
       * 
       * è¾“å‡ºä¸¤éƒ¨åˆ†ï¼š
       * 1. reasoning_content: æ€è€ƒè¿‡ç¨‹ - æ¨¡å‹çš„æ¨ç†å’Œæ€è€ƒè¿‡ç¨‹
       * 2. content: æœ€ç»ˆç»“æœ - æ€è€ƒåå¾—å‡ºçš„æœ€ç»ˆç­”æ¡ˆ
       * 
       * @param {string} content - è¦è§£è¯»çš„å†…å®¹ï¼ˆå¦‚ç« èŠ‚æ­£æ–‡ï¼‰
       * @param {string} prompt - è§£è¯»æç¤ºè¯ï¼ˆå¯åŒ…å«å ä½ç¬¦å¦‚ {chapter_fulltext}ï¼‰
       * @param {Object} options - å¯é€‰å‚æ•°
       * @param {string} options.model - æ¨¡å‹åç§°ï¼Œé»˜è®¤ 'doubao-seed-1-6-251015'
       * @param {number} options.temperature - æ¸©åº¦å‚æ•°ï¼Œé»˜è®¤ 0.3
       * @param {number} options.max_tokens - æœ€å¤§tokenæ•°ï¼Œé»˜è®¤ 16000
       * @param {number} options.timeout - è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 300000 (5åˆ†é’Ÿ)
       * @param {Object} options.replacements - å ä½ç¬¦æ›¿æ¢å¯¹è±¡ï¼Œå¦‚ {chapter_fulltext: '...', chapter_title: '...'}
       * @returns {Promise<Object>} è¿”å›å¯¹è±¡åŒ…å«ä¸¤éƒ¨åˆ†ï¼š
       *   - reasoning_content {string|null}: ç¬¬ä¸€éƒ¨åˆ† - æ€è€ƒè¿‡ç¨‹ï¼ˆæ¨¡å‹çš„æ¨ç†è¿‡ç¨‹ï¼‰
       *   - content {string|null}: ç¬¬äºŒéƒ¨åˆ† - æœ€ç»ˆç»“æœï¼ˆæ€è€ƒåå¾—å‡ºçš„ç­”æ¡ˆï¼‰
       *   - success {boolean}: æ˜¯å¦æˆåŠŸ
       * 
       * @example
       * const result = await interpretWithDeepThinking(
       *   'è¿™æ˜¯è¦è§£è¯»çš„ç« èŠ‚å†…å®¹...',
       *   'è¯·è¯¦ç»†è§£è¯»ä»¥ä¸‹å†…å®¹ï¼š\n{chapter_fulltext}',
       *   { replacements: { chapter_fulltext: 'è¿™æ˜¯è¦è§£è¯»çš„ç« èŠ‚å†…å®¹...' } }
       * );
       * // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€è€ƒè¿‡ç¨‹
       * console.log('æ€è€ƒè¿‡ç¨‹:', result.reasoning_content);
       * // ç¬¬äºŒéƒ¨åˆ†ï¼šæœ€ç»ˆç»“æœ
       * console.log('æœ€ç»ˆç»“æœ:', result.content);
       */
      async function interpretWithDeepThinking(content, prompt, options = {}) {
        const {
          model = 'doubao-seed-1-6-251015',
          temperature = 0.3,
          max_tokens = 16000,
          timeout = 300000,
          replacements = {}
        } = options;

        // æ„å»ºå®Œæ•´çš„ promptï¼šæ›¿æ¢å ä½ç¬¦
        let finalPrompt = prompt;
        
        // ç¡®ä¿ replacements æ˜¯ä¸€ä¸ªå¯¹è±¡
        const safeReplacements = (replacements && typeof replacements === 'object' && !Array.isArray(replacements)) ? replacements : {};
        
        // é»˜è®¤æ›¿æ¢ {chapter_fulltext} ä¸ºå†…å®¹
        if (content && !safeReplacements.chapter_fulltext) {
          safeReplacements.chapter_fulltext = content;
        }
        
        // æ‰§è¡Œæ‰€æœ‰å ä½ç¬¦æ›¿æ¢ - å‚è€ƒ parser_test_page.html çš„å®ç°æ–¹å¼
        if (safeReplacements && typeof safeReplacements === 'object' && !Array.isArray(safeReplacements)) {
          // ä½¿ç”¨ Object.keys ä»£æ›¿ Object.entriesï¼Œé¿å… forEach é—®é¢˜
          const keys = Object.keys(safeReplacements);
          for (let i = 0; i < keys.length; i++) {
            const placeholder = keys[i];
            const value = safeReplacements[placeholder];
            if (value !== undefined && value !== null) {
              const regex = new RegExp(`{${placeholder}}`, 'g');
              finalPrompt = finalPrompt.replace(regex, String(value));
            }
          }
        }

        try {
          // åˆ›å»º AbortController ç”¨äºè¶…æ—¶æ§åˆ¶ - å‚è€ƒ parser_test_page.html
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), timeout);
          
          // è°ƒç”¨æ·±åº¦æ€è€ƒæ¥å£
          let response;
          try {
            response = await fetch("/api/test/doubao-thinking", {
              method: "POST",
              headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
              },
              body: JSON.stringify({
                prompt: finalPrompt,
                temperature: temperature,
                max_tokens: max_tokens,
                model: model,
              }),
              signal: controller.signal,
            });
          } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === "AbortError") {
              throw new Error("è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰ï¼Œè¯·ç¨åé‡è¯•");
            }
            // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            const errorMsg = fetchError.message || String(fetchError);
            if (errorMsg.includes("Failed to fetch") || errorMsg.includes("NetworkError")) {
              throw new Error("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š\n1. æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼ˆç«¯å£5001ï¼‰\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ›´å¤šé”™è¯¯ä¿¡æ¯");
            }
            throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${errorMsg}`);
          }
          clearTimeout(timeoutId);

          if (!response.ok) {
            let errorMessage = "ç”Ÿæˆå¤±è´¥";
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          let data;
          try {
            data = await response.json();
          } catch (jsonError) {
            throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ${jsonError.message}`);
          }
          
          // ç¡®ä¿ data æ˜¯ä¸€ä¸ªå¯¹è±¡
          if (!data || typeof data !== 'object' || Array.isArray(data)) {
            throw new Error('åç«¯è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
          }
          
          // è¿”å›ç»“æ„åŒ–çš„ç»“æœï¼šç¬¬ä¸€éƒ¨åˆ† - æ€è€ƒè¿‡ç¨‹ï¼Œç¬¬äºŒéƒ¨åˆ† - æœ€ç»ˆç»“æœ
          return {
            reasoning_content: (data.reasoning_content && typeof data.reasoning_content === 'string') ? data.reasoning_content : null, // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€è€ƒè¿‡ç¨‹
            content: (data.content && typeof data.content === 'string') ? data.content : null,                     // ç¬¬äºŒéƒ¨åˆ†ï¼šæœ€ç»ˆç»“æœ
            success: true
          };

        } catch (error) {
          // ç»Ÿä¸€é”™è¯¯å¤„ç†
          let errorMessage = "è§£è¯»å¤±è´¥";
          if (error.name === "AbortError" || error.name === "TimeoutError") {
            errorMessage = "è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•";
          } else if (error.message) {
            errorMessage = error.message;
          } else if (error instanceof TypeError && error.message.includes("fetch")) {
            errorMessage = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ";
          }
          
          throw new Error(errorMessage);
        }
      }

      /**
       * æ¸²æŸ“æ·±åº¦æ€è€ƒç»“æœçš„ä¸¤éƒ¨åˆ†è¾“å‡º
       * 
       * ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€è€ƒè¿‡ç¨‹ (reasoning_content)
       * ç¬¬äºŒéƒ¨åˆ†ï¼šæœ€ç»ˆç»“æœ (content)
       * 
       * @param {HTMLElement} container - è¦æ¸²æŸ“åˆ°çš„å®¹å™¨å…ƒç´ 
       * @param {Object} result - æ·±åº¦æ€è€ƒç»“æœå¯¹è±¡
       * @param {string|null} result.reasoning_content - ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€è€ƒè¿‡ç¨‹
       * @param {string|null} result.content - ç¬¬äºŒéƒ¨åˆ†ï¼šæœ€ç»ˆç»“æœ
       */
      function renderDeepThinkingResult(container, result) {
        let resultHtml = `<h4 style='margin-top: 0; color: #1e293b;'>ç”Ÿæˆç»“æœï¼š</h4>`;
        
        // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
        if (result.reasoning_content) {
          resultHtml += `<div style="margin-bottom: 16px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">`;
          resultHtml += `<h5 style="margin-top: 0; margin-bottom: 12px; color: #1e40af; font-size: 15px; font-weight: 600;">ğŸ§  ç¬¬ä¸€éƒ¨åˆ†ï¼šæ·±åº¦æ€è€ƒè¿‡ç¨‹</h5>`;
          resultHtml += `<div style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; font-size: 14px; max-height: 400px; overflow-y: auto; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #bfdbfe;">${escapeHtml(result.reasoning_content)}</div>`;
          resultHtml += `</div>`;
        } else {
          resultHtml += `<div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b;">`;
          resultHtml += `<p style="color: #92400e; margin: 0;">âš ï¸ æœªè·å–åˆ°æ€è€ƒè¿‡ç¨‹</p>`;
          resultHtml += `</div>`;
        }
        
        // ç¬¬äºŒéƒ¨åˆ†ï¼šæ˜¾ç¤ºæœ€ç»ˆç»“æœ
        if (result.content) {
          resultHtml += `<div style="padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">`;
          resultHtml += `<h5 style="margin-top: 0; margin-bottom: 12px; color: #065f46; font-size: 15px; font-weight: 600;">âœ… ç¬¬äºŒéƒ¨åˆ†ï¼šæœ€ç»ˆç»“æœ</h5>`;
          resultHtml += `<div style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; font-size: 14px; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #86efac;">${escapeHtml(result.content)}</div>`;
          resultHtml += `</div>`;
        } else {
          resultHtml += `<div style="padding: 12px; background: #fee2e2; border-radius: 6px; border-left: 3px solid #ef4444;">`;
          resultHtml += `<p style="color: #991b1b; margin: 0;">âŒ æœªè·å–åˆ°æœ€ç»ˆç»“æœ</p>`;
          resultHtml += `</div>`;
        }
        
        container.innerHTML = resultHtml;
      }

      /**
       * HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
       * @param {string} text - è¦è½¬ä¹‰çš„æ–‡æœ¬
       * @returns {string} è½¬ä¹‰åçš„HTMLå®‰å…¨æ–‡æœ¬
       */
      function escapeHtml(text) {
        // ç¡®ä¿è¾“å…¥æ˜¯å­—ç¬¦ä¸²ç±»å‹
        if (text === null || text === undefined) {
          return '';
        }
        if (typeof text !== 'string') {
          text = String(text);
        }
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ç”¨æˆ·åå¥½é…ç½® - åŸºäº6ä¸ªç»´åº¦å®Œæ•´åˆ»ç”»ç”¨æˆ·ç”»åƒ
      const preferenceConfigs = {
        A: {
          // 1. å¹´é¾„ & èŒä¸š
          age: "38å²",
          profession: "åˆ›ä¸šå…¬å¸CEO",
          // 2. é˜…è¯»ç›®çš„
          readingGoal: "æå‡æˆ˜ç•¥å†³ç­–èƒ½åŠ›ã€å›¢é˜Ÿç®¡ç†å’Œå•†ä¸šæ´å¯ŸåŠ›ï¼Œå¯»æ‰¾å¢é•¿æ æ†",
          // 3. é˜…è¯»æ—¶é•¿ & ä¼‘æ¯èŠ‚å¥
          readingDuration: "å•æ¬¡30-45åˆ†é’Ÿ",
          readingRhythm: "ç¢ç‰‡åŒ–é˜…è¯»ï¼Œå¸¸åœ¨é€šå‹¤ã€åˆä¼‘æ—¶é˜…è¯»",
          // 4. ç”Ÿæ´»è§’è‰²èº«ä»½
          lifeRole: "åˆ›ä¸šè€…ã€å›¢é˜Ÿç®¡ç†è€…ã€çˆ¶äº²",
          // 5. æœ€è¿‘æƒ³æå‡çš„æ–¹å‘
          currentFocus: "å†³ç­–é€Ÿåº¦ä¸è´¨é‡ã€å›¢é˜Ÿæ¿€åŠ±ä¸èµ‹èƒ½ã€å•†ä¸šæ¨¡å¼åˆ›æ–°",
          // 6. ç§°å‘¼åå¥½
          preferredTitle: "ææ€»",
          // ä¸€å¥è¯æè¿°ç”¨æˆ·ç‰¹å¾å’Œåå¥½
          summary: "ä¸€ä¸ªéœ€è¦åœ¨æœ‰é™æ—¶é—´å†…å¿«é€ŸæŠ“ä½å•†ä¸šæ æ†ç‚¹ã€ç”¨äºå®æˆ˜å†³ç­–çš„åˆ›ä¸šæŒèˆµäºº",
          // ç”¨äºç”Ÿæˆè§£è¯»çš„å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
          userProfession: "åˆ›ä¸šå…¬å¸CEO",
          focus: "å•†ä¸šæ´å¯Ÿã€ç»„ç»‡æ æ†å’Œè½åœ°æŠ“æ‰‹",
        },
        B: {
          age: "30å²",
          profession: "äº§å“ç»ç†",
          readingGoal: "æ·±å…¥ç†è§£ç”¨æˆ·å¿ƒç†ã€äº§å“è®¾è®¡åŸç†å’Œå•†ä¸šé€»è¾‘ï¼Œæå‡äº§å“æ€ç»´",
          readingDuration: "å•æ¬¡1-1.5å°æ—¶",
          readingRhythm: "åå¥½æ·±åº¦é˜…è¯»ï¼Œé€šå¸¸åœ¨æ™šä¸Šæˆ–å‘¨æœ«",
          lifeRole: "èŒåœºä¸“ä¸šäººå£«ã€äº§å“è´Ÿè´£äºº",
          currentFocus: "ç”¨æˆ·æ´å¯Ÿèƒ½åŠ›ã€äº§å“è®¾è®¡æ€ç»´ã€æ•°æ®åˆ†æèƒ½åŠ›",
          preferredTitle: "å°ç‹",
          summary: "ä¸€ä¸ªè¿½æ±‚æ·±åº¦ç†è§£ç”¨æˆ·å¿ƒç†å’Œäº§å“é€»è¾‘ï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿæ€§æ€ç»´æå‡äº§å“å†³ç­–èƒ½åŠ›çš„äº§å“ç»ç†",
          userProfession: "äº§å“ç»ç†",
          focus: "æ¨¡å‹æ¨ç†ã€æ¡†æ¶æ‹†è§£å’Œå¯¹æ¯”æ¡ˆä¾‹",
        },
        C: {
          age: "33å²",
          profession: "çŸ¥è¯†å·¥ä½œè€…ï¼ˆå’¨è¯¢é¡¾é—®/åŸ¹è®­å¸ˆ/ç ”ç©¶å‘˜ï¼‰",
          readingGoal: "ç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ï¼Œæ¢ç´¢è·¨é¢†åŸŸæ€ç»´ï¼Œæå‡ä¸“ä¸šæ·±åº¦å’Œå¹¿åº¦",
          readingDuration: "å•æ¬¡2-3å°æ—¶",
          readingRhythm: "æ²‰æµ¸å¼æ·±åº¦é˜…è¯»ï¼Œä¸»è¦åœ¨å‘¨æœ«æˆ–å‡æœŸ",
          lifeRole: "ç‹¬ç«‹ä¸“ä¸šäººå£«ã€çŸ¥è¯†ä¼ æ’­è€…ã€æ€è€ƒè€…",
          currentFocus: "è·¨å­¦ç§‘æ€ç»´èƒ½åŠ›ã€çŸ¥è¯†æ•´åˆã€è®¤çŸ¥æ·±åº¦",
          preferredTitle: "è€å¸ˆ",
          summary: "ä¸€ä¸ªç³»ç»ŸåŒ–æ„å»ºçŸ¥è¯†ä½“ç³»ã€è¿½æ±‚æ·±åº¦ç†è§£å’Œè·¨é¢†åŸŸæ€è€ƒçš„çŸ¥è¯†å·¥ä½œè€…",
          userProfession: "çŸ¥è¯†å·¥ä½œè€…",
          focus: "æ¦‚å¿µæ˜ å°„ã€ç»“æ„åŒ–æ€»ç»“ä¸å»¶å±•æ€è€ƒ",
        },
        D: {
          age: "28å²",
          profession: "å…¬å¸ä¸­å±‚ç®¡ç†è€…æˆ–é«˜çº§æ‰§è¡Œè€…",
          readingGoal: "å¿«é€Ÿè·å–æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®æ´å¯Ÿï¼Œæé«˜å·¥ä½œæ•ˆç‡å’Œå†³ç­–èƒ½åŠ›",
          readingDuration: "å•æ¬¡15-30åˆ†é’Ÿ",
          readingRhythm: "ç¢ç‰‡åŒ–é˜…è¯»ï¼Œä¸»è¦åœ¨é€šå‹¤æˆ–çŸ­æš‚ä¼‘æ¯æ—¶é—´",
          lifeRole: "èŒåœºå¥‹æ–—è€…ã€å¯èƒ½ä¹Ÿæ˜¯çˆ¶æ¯ã€å®¶åº­è´£ä»»æ‰¿æ‹…è€…",
          currentFocus: "æ—¶é—´ç®¡ç†ã€å†³ç­–æ•ˆç‡ã€å¿«é€Ÿå­¦ä¹ èƒ½åŠ›",
          preferredTitle: "å°é™ˆ",
          summary: "ä¸€ä¸ªæ—¶é—´æœ‰é™ã€è¿½æ±‚å¿«é€Ÿè·å–å¯è½åœ°æ ¸å¿ƒè§‚ç‚¹å¹¶ç«‹å³åº”ç”¨çš„èŒåœºå®å¹²æ´¾",
          userProfession: "å¿™ç¢Œçš„èŒåœºäººå£«",
          focus: "æµ“ç¼©ç»“è®ºã€è¡ŒåŠ¨æ¸…å•å’Œå®è·µæ·å¾„",
        },
      };

      let selectedDensity = "50% æ ¸å¿ƒ";

      function renderStatus(el, message, type = "info") {
        el.style.display = "block";
        el.className = `status ${type}`;
        el.textContent = message;
      }

      function hideStatus(el) {
        el.style.display = "none";
      }

      // åˆ‡æ¢ä¸» TABï¼ˆä¸ªæ€§åŒ–è§£è¯» / ä¹¦ç±é‡æ„ï¼‰
      function switchMainTab(tabName) {
        const mainTabContent = document.getElementById("mainTabContent");
        const restructureTabContent = document.getElementById("restructureTabContent");
        const mainTabBtn = document.getElementById("mainTabBtn");
        const restructureTabBtn = document.getElementById("restructureTabBtn");

        if (tabName === "main") {
          if (mainTabContent) mainTabContent.style.display = "block";
          if (restructureTabContent) restructureTabContent.style.display = "none";
          if (mainTabBtn) {
            mainTabBtn.classList.add("active");
            mainTabBtn.style.borderBottomColor = "#2563eb";
            mainTabBtn.style.color = "#2563eb";
            mainTabBtn.style.fontWeight = "600";
          }
          if (restructureTabBtn) {
            restructureTabBtn.classList.remove("active");
            restructureTabBtn.style.borderBottomColor = "transparent";
            restructureTabBtn.style.color = "#64748b";
            restructureTabBtn.style.fontWeight = "500";
          }
        } else if (tabName === "restructure") {
          if (mainTabContent) mainTabContent.style.display = "none";
          if (restructureTabContent) restructureTabContent.style.display = "block";
          if (restructureTabBtn) {
            restructureTabBtn.classList.add("active");
            restructureTabBtn.style.borderBottomColor = "#2563eb";
            restructureTabBtn.style.color = "#2563eb";
            restructureTabBtn.style.fontWeight = "600";
          }
          if (mainTabBtn) {
            mainTabBtn.classList.remove("active");
            mainTabBtn.style.borderBottomColor = "transparent";
            mainTabBtn.style.color = "#64748b";
            mainTabBtn.style.fontWeight = "500";
          }
          // åŠ è½½ä¹¦ç±åˆ—è¡¨åˆ°é‡æ„ä¹¦ç±é€‰æ‹©å™¨
          loadBooksForRestructure();
        }
      }

      // åˆ‡æ¢æç¤ºè¯æ ‡ç­¾é¡µ
      function switchPromptTab(tabName) {
        // éšè—æ‰€æœ‰é¢æ¿
        document.querySelectorAll(".prompt-tab-panel").forEach(panel => {
          panel.style.display = "none";
        });
        // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
        document.querySelectorAll(".prompt-tab").forEach(tab => {
          tab.classList.remove("active");
        });
        // æ˜¾ç¤ºé€‰ä¸­çš„é¢æ¿
        const panel = document.getElementById(`promptTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
        if (panel) {
          panel.style.display = "block";
        }
        // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
        const tab = document.querySelector(`[data-tab="${tabName}"]`);
        if (tab) {
          tab.classList.add("active");
        }
      }

      // åŠ è½½æç¤ºè¯å„éƒ¨åˆ†
      async function loadPromptParts() {
        try {
          const response = await fetch("/api/settings/prompt_parts");
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }
          if (data.intro_prompt) introPrompt.value = data.intro_prompt;
          if (data.body_prompt) bodyPrompt.value = data.body_prompt;
          if (data.quiz_prompt) quizPrompt.value = data.quiz_prompt;
          if (data.question_prompt) questionPrompt.value = data.question_prompt;
          renderStatus(promptStatus, "æç¤ºè¯å·²åŠ è½½", "success");
        } catch (error) {
          console.error(error);
          renderStatus(promptStatus, `åŠ è½½å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ä¿å­˜æç¤ºè¯å„éƒ¨åˆ†
      async function savePromptParts() {
        try {
          const payload = {
            intro_prompt: introPrompt.value.trim(),
            body_prompt: bodyPrompt.value.trim(),
            quiz_prompt: quizPrompt.value.trim(),
            question_prompt: questionPrompt.value.trim(),
          };
          const response = await fetch("/api/settings/prompt_parts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }
          renderStatus(promptStatus, "æç¤ºè¯å·²ä¿å­˜", "success");
        } catch (error) {
          console.error(error);
          renderStatus(promptStatus, `ä¿å­˜å¤±è´¥: ${error.message}`, "error");
        }
      }

      // å•ç‹¬ç”ŸæˆæŸä¸ªéƒ¨åˆ†
      async function generateSinglePart(part) {
        if (!selectedBook || !selectedChapter || !selectedPreference.value) {
          renderStatus(promptStatus, "è¯·å…ˆé€‰æ‹©ä¹¦ç±ã€ç« èŠ‚å’Œç”¨æˆ·åå¥½", "error");
          return;
        }

        const prefConfig = preferenceConfigs[selectedPreference.value];
        if (!prefConfig) {
          renderStatus(promptStatus, "ç”¨æˆ·åå¥½é…ç½®é”™è¯¯", "error");
          return;
        }

        // è·å–å¯¹åº”éƒ¨åˆ†çš„æç¤ºè¯
        let partPrompt = "";
        let resultElement = null;
        let buttonElement = null;
        
        if (part === "intro") {
          partPrompt = introPrompt.value.trim();
          resultElement = document.getElementById("introResult");
          buttonElement = document.getElementById("generateIntroBtn");
        } else if (part === "body") {
          partPrompt = bodyPrompt.value.trim();
          resultElement = document.getElementById("bodyResult");
          buttonElement = document.getElementById("generateBodyBtn");
        } else if (part === "quiz") {
          partPrompt = quizPrompt.value.trim();
          resultElement = document.getElementById("quizResult");
          buttonElement = document.getElementById("generateQuizBtn");
        } else if (part === "question") {
          partPrompt = questionPrompt.value.trim();
          resultElement = document.getElementById("questionResult");
          buttonElement = document.getElementById("generateQuestionBtn");
        }

        if (!partPrompt) {
          renderStatus(promptStatus, `è¯·å…ˆè¾“å…¥${part}éƒ¨åˆ†çš„æç¤ºè¯`, "error");
          return;
        }

        // ç¦ç”¨æŒ‰é’®
        if (buttonElement) {
          buttonElement.disabled = true;
          buttonElement.textContent = "ç”Ÿæˆä¸­...";
        }

        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        if (resultElement) {
          resultElement.style.display = "block";
          resultElement.innerHTML = "<p style='color: #64748b;'>æ­£åœ¨ç”Ÿæˆ...</p>";
        }

        // å¦‚æœæ˜¯æ­£æ–‡éƒ¨åˆ†ï¼Œä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å‹ interpretWithDeepThinking
        if (part === "body") {
          // ========== è¾“å…¥éƒ¨åˆ†ï¼šå‡†å¤‡ç« èŠ‚å†…å®¹å’Œæç¤ºè¯ ==========
          const chapterTitle = selectedChapter.title_zh || selectedChapter.title;
          const chapterContent = selectedChapter.content_zh || selectedChapter.content; // è¾“å…¥ï¼šé€‰æ‹©çš„ç« èŠ‚å†…å®¹
          const chapterSummary = selectedChapter.summary || chapterTitle;
          const prompt = partPrompt; // è¾“å…¥ï¼šæç¤ºè¯ï¼ˆä» bodyPrompt è¾“å…¥æ¡†è·å–ï¼‰

          try {
            // ========== è°ƒç”¨æ·±åº¦æ€è€ƒå‡½æ•°ï¼šinterpretWithDeepThinking ==========
            // è¾“å…¥å‚æ•°ï¼š
            //   - chapterContent: é€‰æ‹©çš„ç« èŠ‚å†…å®¹
            //   - prompt: æç¤ºè¯
            //   - options: å ä½ç¬¦æ›¿æ¢é…ç½®
            // è¾“å‡ºï¼šåŒ…å«ä¸¤éƒ¨åˆ†çš„å¯¹è±¡
            //   - reasoning_content: ç¬¬ä¸€éƒ¨åˆ† - æ€è€ƒè¿‡ç¨‹
            //   - content: ç¬¬äºŒéƒ¨åˆ† - æœ€ç»ˆç»“æœï¼ˆæ·±åº¦æ€è€ƒåçš„å†…å®¹ï¼‰
            const result = await interpretWithDeepThinking(
              chapterContent,  // è¾“å…¥ï¼šç« èŠ‚å†…å®¹
              prompt,           // è¾“å…¥ï¼šæç¤ºè¯
              {
                replacements: {
                  chapter_fulltext: chapterContent,
                  chapter_summary: chapterSummary,
                  chapter_title: chapterTitle
                }
              }
            );
            
            // ========== è¾“å‡ºéƒ¨åˆ†ï¼šæ˜¾ç¤ºæ·±åº¦æ€è€ƒåçš„å†…å®¹ ==========
            // result.reasoning_content: ç¬¬ä¸€éƒ¨åˆ† - æ€è€ƒè¿‡ç¨‹
            // result.content: ç¬¬äºŒéƒ¨åˆ† - æœ€ç»ˆç»“æœï¼ˆè¿™æ˜¯æ·±åº¦æ€è€ƒåçš„å†…å®¹ï¼‰
            if (resultElement) {
              renderDeepThinkingResult(resultElement, result);
            }

            renderStatus(promptStatus, "æ­£æ–‡éƒ¨åˆ†ç”Ÿæˆå®Œæˆï¼ï¼ˆä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å‹ï¼‰", "success");
          } catch (error) {
            console.error("ç”Ÿæˆå¤±è´¥:", error);
            const errorMessage = error.message || "ç”Ÿæˆå¤±è´¥";
            
            if (resultElement) {
              resultElement.innerHTML = `<p style='color: #ef4444;'>${errorMessage}</p>`;
            }
            renderStatus(promptStatus, errorMessage, "error");
          } finally {
            // æ¢å¤æŒ‰é’®
            if (buttonElement) {
              buttonElement.disabled = false;
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆæ­£æ–‡";
            }
          }
          return; // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œåé¢çš„ä»£ç 
        }

        // å…¶ä»–éƒ¨åˆ†ä½¿ç”¨åŸæ¥çš„æ¥å£
        const payload = {
          part: part,
          chapterTitle: selectedChapter.title_zh || selectedChapter.title,
          chapterText: selectedChapter.content_zh || selectedChapter.content,
          chapterSummary: selectedChapter.summary || selectedChapter.title_zh || selectedChapter.title,
          // å‘åå…¼å®¹å­—æ®µ
          userProfession: prefConfig.userProfession,
          readingGoal: prefConfig.readingGoal,
          focus: prefConfig.focus,
          density: selectedDensity,
          // æ–°çš„6ä¸ªç»´åº¦å­—æ®µ
          userAge: prefConfig.age,
          userProfessionDetail: prefConfig.profession,
          userReadingGoal: prefConfig.readingGoal,
          userReadingDuration: prefConfig.readingDuration,
          userReadingRhythm: prefConfig.readingRhythm,
          userLifeRole: prefConfig.lifeRole,
          userCurrentFocus: prefConfig.currentFocus,
          userPreferredTitle: prefConfig.preferredTitle,
          userSummary: prefConfig.summary,
          intro_prompt: introPrompt.value.trim(),
          body_prompt: bodyPrompt.value.trim(),
          quiz_prompt: quizPrompt.value.trim(),
          question_prompt: questionPrompt.value.trim(),
        };

        try {
          const response = await fetch("/api/generate/part", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            signal: AbortSignal.timeout(300000), // 5åˆ†é’Ÿè¶…æ—¶
          });

          if (!response.ok) {
            let errorMessage = "ç”Ÿæˆå¤±è´¥";
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();
          
          // æ˜¾ç¤ºç»“æœ
          if (resultElement) {
            let resultHtml = "";
            if (part === "quiz" && Array.isArray(data.result)) {
              // é—®ç­”éƒ¨åˆ†ï¼šæ˜¾ç¤ºä¸ºåˆ—è¡¨
              resultHtml = "<h4 style='margin-top: 0; color: #1e293b;'>ç”Ÿæˆçš„é—®ç­”ï¼š</h4>";
              data.result.forEach((item, index) => {
                resultHtml += `<div style="margin-bottom: 16px; padding: 12px; background: #ffffff; border-radius: 6px; border-left: 3px solid #2563eb;">`;
                resultHtml += `<p><strong>é¢˜ç›® ${index + 1}ï¼š</strong> ${item.question || ""}</p>`;
                if (item.options && Array.isArray(item.options)) {
                  resultHtml += `<ul style="margin: 8px 0; padding-left: 20px;">`;
                  item.options.forEach((opt, idx) => {
                    resultHtml += `<li>${String.fromCharCode(65 + idx)}. ${opt}</li>`;
                  });
                  resultHtml += `</ul>`;
                }
                resultHtml += `<p><strong>ç­”æ¡ˆï¼š</strong> ${item.answer || "?"}</p>`;
                if (item.explanation) {
                  resultHtml += `<p><strong>è§£æï¼š</strong> ${item.explanation}</p>`;
                }
                resultHtml += `</div>`;
              });
            } else {
              // å…¶ä»–éƒ¨åˆ†ï¼šç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
              resultHtml = `<h4 style='margin-top: 0; color: #1e293b;'>ç”Ÿæˆç»“æœï¼š</h4>`;
              resultHtml += `<div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b;">${data.result || "æ— ç»“æœ"}</div>`;
            }
            resultElement.innerHTML = resultHtml;
          }

          renderStatus(promptStatus, `${part}éƒ¨åˆ†ç”Ÿæˆå®Œæˆï¼`, "success");
        } catch (error) {
          console.error("ç”Ÿæˆå¤±è´¥:", error);
          let errorMessage = "ç”Ÿæˆå¤±è´¥";
          if (error.name === "AbortError" || error.name === "TimeoutError") {
            errorMessage = "è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•";
          } else if (error.message) {
            errorMessage = error.message;
          } else if (error instanceof TypeError && error.message.includes("fetch")) {
            errorMessage = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ";
          }
          
          if (resultElement) {
            resultElement.innerHTML = `<p style='color: #ef4444;'>${errorMessage}</p>`;
          }
          renderStatus(promptStatus, errorMessage, "error");
        } finally {
          // æ¢å¤æŒ‰é’®
          if (buttonElement) {
            buttonElement.disabled = false;
            if (part === "intro") {
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆå¯¼è¯»";
            } else if (part === "body") {
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆæ­£æ–‡";
            } else if (part === "quiz") {
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆé—®ç­”";
            } else if (part === "question") {
              buttonElement.textContent = "ğŸš€ å•ç‹¬ç”Ÿæˆé—®é¢˜";
            }
          }
        }
      }

      /**
       * ç”Ÿæˆç›®å½•ä¸æ‘˜è¦æ–‡æœ¬
       * 
       * è¾“å…¥ï¼šç« èŠ‚æ•°ç»„
       * è¾“å‡ºï¼šæ ¼å¼åŒ–çš„æ–‡æœ¬å­—ç¬¦ä¸²ï¼ˆç« èŠ‚åºå·+ç« èŠ‚æ ‡é¢˜+æ‘˜è¦ï¼‰
       * 
       * @param {Array} entries - ç« èŠ‚æ•°ç»„ï¼Œæ¯ä¸ªç« èŠ‚å¯¹è±¡åŒ…å« title_zh, title, summary ç­‰å­—æ®µ
       * @returns {string} ç”Ÿæˆçš„ç›®å½•ä¸æ‘˜è¦æ–‡æœ¬
       */
      function generateTocSummaryText(entries) {
        if (!entries || entries.length === 0) {
          return "";
        }

        let text = "";
        for (let i = 0; i < entries.length; i++) {
          const entry = entries[i];
          const chapterNumber = i + 1;
          const chapterTitle = entry.title_zh || entry.title || `ç¬¬${chapterNumber}ç« `;
          const chapterSummary = entry.summary || "";

          // æ ¼å¼ï¼šç« èŠ‚åºå·+ç« èŠ‚æ ‡é¢˜+æ‘˜è¦
          text += `${chapterNumber}. ${chapterTitle}`;
          if (chapterSummary) {
            text += `\n${chapterSummary}`;
          }
          text += "\n\n";
        }

        return text.trim();
      }

      // åŠ è½½ä¹¦ç±åˆ—è¡¨
      async function loadBooks() {
        try {
          const response = await fetch("/api/admin/books?page=1&per_page=100");
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }

          books = data.books || [];
          bookSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>';
          books.forEach((book) => {
            const option = document.createElement("option");
            option.value = book.id;
            option.textContent = `${book.filename} (${book.chapter_count}ç« )`;
            bookSelect.appendChild(option);
          });
        } catch (error) {
          console.error(error);
          renderStatus(promptStatus, `åŠ è½½ä¹¦ç±å¤±è´¥: ${error.message}`, "error");
        }
      }

      // åŠ è½½ç« èŠ‚åˆ—è¡¨
      async function loadChapters(bookId) {
        chapterSelect.disabled = true;
        chapterSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        try {
          const response = await fetch(`/api/admin/books/${bookId}`);
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }

          selectedBook = data.book;
          chapters = data.chapters || [];

          chapterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç« èŠ‚...</option>';
          chapters.forEach((chapter, index) => {
            const option = document.createElement("option");
            option.value = chapter.id;
            const displayTitle = chapter.title_zh || chapter.title;
            option.textContent = `${index + 1}. ${displayTitle}`;
            chapterSelect.appendChild(option);
          });

          chapterSelect.disabled = false;
          updateGenerateButton();
        } catch (error) {
          console.error(error);
          chapterSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
          renderStatus(promptStatus, `åŠ è½½ç« èŠ‚å¤±è´¥: ${error.message}`, "error");
        }
      }

      // é€‰æ‹©ç”¨æˆ·åå¥½
      function selectPreference(pref) {
        selectedPreference.value = pref;
        document.querySelectorAll(".preference-card").forEach((card) => {
          card.classList.remove("selected");
        });
        document.querySelector(`[data-preference="${pref}"]`).classList.add("selected");
        updateGenerateButton();
      }

      function selectDensity(value) {
        selectedDensity = value;
        document.querySelectorAll(".density-option").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.density === value);
        });
      }

      // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
      function updateGenerateButton() {
        const hasBook = bookSelect.value && selectedBook;
        const hasChapter = chapterSelect.value && selectedChapter;
        const hasPreference = selectedPreference.value;
        generateButton.disabled = !(hasBook && hasChapter && hasPreference);
        
        // æ›´æ–°ç›®å½•ä¸æ‘˜è¦è¯»å–æŒ‰é’®çŠ¶æ€ï¼ˆåªéœ€è¦æœ‰ä¹¦ç±å³å¯ï¼‰
        const tocSummaryButton = document.getElementById("tocSummaryButton");
        if (tocSummaryButton) {
          tocSummaryButton.disabled = !hasBook;
        }
      }

      // ç”Ÿæˆè§£è¯»
      async function generateInterpretation() {
        if (!selectedBook || !selectedChapter || !selectedPreference.value) {
          renderStatus(generationStatus, "è¯·å®Œæˆæ‰€æœ‰å¿…å¡«é¡¹", "error");
          return;
        }

        const prefConfig = preferenceConfigs[selectedPreference.value];
        if (!prefConfig) {
          renderStatus(generationStatus, "ç”¨æˆ·åå¥½é…ç½®é”™è¯¯", "error");
          return;
        }

        generateButton.disabled = true;
        renderStatus(generationStatus, "æ­£åœ¨ç”Ÿæˆè§£è¯»ï¼Œè¯·ç¨å€™...", "info");
        outputSection.style.display = "none";

        const payload = {
          chapterTitle: selectedChapter.title_zh || selectedChapter.title,
          chapterText: selectedChapter.content_zh || selectedChapter.content,
          chapterSummary: selectedChapter.summary || selectedChapter.title_zh || selectedChapter.title,
          // å‘åå…¼å®¹å­—æ®µ
          userProfession: prefConfig.userProfession,
          readingGoal: prefConfig.readingGoal,
          focus: prefConfig.focus,
          density: selectedDensity,
          // æ–°çš„6ä¸ªç»´åº¦å­—æ®µ
          userAge: prefConfig.age,
          userProfessionDetail: prefConfig.profession,
          userReadingGoal: prefConfig.readingGoal,
          userReadingDuration: prefConfig.readingDuration,
          userReadingRhythm: prefConfig.readingRhythm,
          userLifeRole: prefConfig.lifeRole,
          userCurrentFocus: prefConfig.currentFocus,
          userPreferredTitle: prefConfig.preferredTitle,
          userSummary: prefConfig.summary,
        };

        // ä½¿ç”¨åˆ†è§£çš„æç¤ºè¯
        payload.intro_prompt = introPrompt.value.trim();
        payload.body_prompt = bodyPrompt.value.trim();
        payload.quiz_prompt = quizPrompt.value.trim();
        payload.question_prompt = questionPrompt.value.trim();

        try {
          const response = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            signal: AbortSignal.timeout(600000), // 10åˆ†é’Ÿè¶…æ—¶
          });

          if (!response.ok) {
            let errorMessage = "ç”Ÿæˆå¤±è´¥";
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();
          console.log("âœ… æ”¶åˆ°æœåŠ¡å™¨å“åº”:", data);
          console.log("ğŸ“Š data.result:", data.result);
          console.log("ğŸ”§ data.result._debug_info:", data.result?._debug_info);
          console.log("ğŸ§  data.result._thinking_process:", data.result?._thinking_process ? "å­˜åœ¨ï¼ˆé•¿åº¦: " + data.result._thinking_process.length + " å­—ç¬¦ï¼‰" : "ä¸å­˜åœ¨");
          
          renderStatus(generationStatus, "è§£è¯»ç”Ÿæˆå®Œæˆï¼", "success");
          currentInterpretationResult = data.result; // ä¿å­˜è§£è¯»ç»“æœ
          
          // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿä¼šæ˜¾ç¤ºæç¤ºï¼‰
          displayDebugInfo(data.result);
          
          // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿä¼šæ˜¾ç¤ºæç¤ºï¼‰
          displayThinkingProcess(data.result);
          
          // æ˜¾ç¤ºè§£è¯»ç»“æœ
          displayMarkdownResult(data.result);
          
          // å¦‚æœå¯ç”¨äº†æ’­å®¢ï¼Œæ˜¾ç¤ºç”Ÿæˆæ’­å®¢æŒ‰é’®
          if (enablePodcast.checked && data.result) {
            showPodcastButton();
          } else {
            hidePodcastButton();
          }
        } catch (error) {
          console.error("ç”Ÿæˆè§£è¯»å¤±è´¥:", error);
          let errorMessage = "ç”Ÿæˆå¤±è´¥";
          if (error.name === "AbortError" || error.name === "TimeoutError") {
            errorMessage = "è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•";
          } else if (error.message) {
            errorMessage = error.message;
          } else if (error instanceof TypeError && error.message.includes("fetch")) {
            errorMessage = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ";
          }
          renderStatus(generationStatus, errorMessage, "error");
        } finally {
          generateButton.disabled = false;
        }
      }

      // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
      function displayDebugInfo(result) {
        const debugInfoSection = document.getElementById("debugInfoSection");
        const debugInfoContent = document.getElementById("debugInfoContent");
        
        if (!debugInfoSection || !debugInfoContent) {
          console.error("âŒ æ‰¾ä¸åˆ°è°ƒè¯•ä¿¡æ¯åŒºåŸŸçš„DOMå…ƒç´ ï¼");
          return;
        }
        
        console.log("ğŸ”§ displayDebugInfo called with result:", result);
        console.log("ğŸ”§ _debug_info:", result?._debug_info);
        
        // å§‹ç»ˆæ˜¾ç¤ºåŒºåŸŸ
        debugInfoSection.style.display = "block";
        
        if (!result) {
          debugInfoContent.innerHTML = `<div style="color: #f59e0b;">âš ï¸ æœªæ”¶åˆ°ç»“æœæ•°æ®</div>`;
          return;
        }
        
        // å³ä½¿æ²¡æœ‰ _debug_infoï¼Œä¹Ÿæ˜¾ç¤ºä¸€ä¸ªé»˜è®¤çš„è°ƒè¯•ä¿¡æ¯åŒºåŸŸ
        if (!result._debug_info) {
          console.log("âš ï¸ No _debug_info found, showing default debug info");
          const keys = Object.keys(result);
          debugInfoContent.innerHTML = `
            <div style="margin-bottom: 8px; color: #f59e0b;"><strong>âš ï¸ è°ƒè¯•ä¿¡æ¯:</strong> æœªä»æœåŠ¡å™¨è·å–åˆ°è°ƒè¯•ä¿¡æ¯ï¼Œå¯èƒ½åç«¯æœªè¿”å› _debug_info å­—æ®µ</div>
            <div style="margin-bottom: 8px;"><strong>ç»“æœå¯¹è±¡é”®:</strong> ${keys.join(', ')}</div>
            <div style="margin-top: 12px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 12px;">
              <strong>æç¤º:</strong> è¯·æ£€æŸ¥åç«¯ä»£ç ä¸­ call_llm å‡½æ•°æ˜¯å¦æ­£ç¡®æ·»åŠ äº† _debug_info å­—æ®µ
            </div>
          `;
          return;
        }
        
        const info = result._debug_info;
        
        // æ„å»ºå®Œæ•´çš„å‚æ•°æ˜¾ç¤º
        let thinkingDisplay = 'âŒ æœªå¯ç”¨';
        if (info.thinking) {
          if (info.thinking.type === 'enabled') {
            thinkingDisplay = '<span style="color: #059669;">âœ… å·²å¯ç”¨ (type: enabled)</span>';
          } else if (info.thinking.type === 'disabled') {
            thinkingDisplay = '<span style="color: #dc2626;">âŒ å·²ç¦ç”¨ (type: disabled)</span>';
          } else if (info.thinking.type === 'auto') {
            thinkingDisplay = '<span style="color: #f59e0b;">ğŸ”„ è‡ªåŠ¨ (type: auto)</span>';
          } else {
            thinkingDisplay = `<span style="color: #64748b;">${JSON.stringify(info.thinking)}</span>`;
          }
        } else if (info.thinking_mode !== undefined) {
          thinkingDisplay = info.thinking_mode ? '<span style="color: #059669;">âœ… å·²å¯ç”¨</span>' : '<span style="color: #dc2626;">âŒ æœªå¯ç”¨</span>';
        }
        
        debugInfoContent.innerHTML = `
          <div style="margin-bottom: 12px; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">æ¨¡å‹åç§°:</strong> <span style="color: #1e40af; font-weight: 600; font-size: 15px;">${info.model || 'N/A'}</span></div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">è°ƒç”¨æ–¹å¼:</strong> <span style="color: #64748b;">${info.method || 'N/A'}</span></div>
            ${info.base_url ? `<div style="margin-bottom: 8px;"><strong style="color: #475569;">Base URL:</strong> <span style="color: #64748b; font-size: 12px; word-break: break-all;">${info.base_url}</span></div>` : ''}
            ${info.endpoint ? `<div style="margin-bottom: 8px;"><strong style="color: #475569;">APIç«¯ç‚¹:</strong> <span style="color: #64748b; font-size: 12px; word-break: break-all;">${info.endpoint}</span></div>` : ''}
          </div>
          
          <div style="margin-top: 16px; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="margin-bottom: 10px; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">å‚æ•°é…ç½®</div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">Temperature:</strong> <span style="color: #059669; font-weight: 600;">${info.temperature !== undefined ? info.temperature : 0.3}</span></div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">Max Tokens:</strong> <span style="color: #059669; font-weight: 600;">${info.max_tokens !== undefined ? info.max_tokens : 16000}</span></div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">æ·±åº¦æ€è€ƒ (Thinking):</strong> ${thinkingDisplay}</div>
            <div style="margin-bottom: 8px;"><strong style="color: #475569;">Stream:</strong> ${info.stream ? '<span style="color: #059669;">âœ… å·²å¯ç”¨</span>' : '<span style="color: #dc2626;">âŒ æœªå¯ç”¨</span>'}</div>
          </div>
          
          ${info.thinking ? `<div style="margin-top: 12px; padding: 8px; background: #f0f9ff; border-radius: 4px; font-size: 12px; color: #1e40af;">
            <strong>Thinking å‚æ•°è¯¦æƒ…:</strong> <code style="background: #ffffff; padding: 2px 6px; border-radius: 3px;">${JSON.stringify(info.thinking, null, 2)}</code>
          </div>` : ''}
        `;
      }
      
      // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
      function displayThinkingProcess(result) {
        const thinkingSection = document.getElementById("thinkingProcessSection");
        const thinkingContent = document.getElementById("thinkingProcessContent");
        
        if (!thinkingSection || !thinkingContent) {
          console.error("âŒ æ‰¾ä¸åˆ°æ€è€ƒè¿‡ç¨‹åŒºåŸŸçš„DOMå…ƒç´ ï¼");
          return;
        }
        
        console.log("ğŸ§  displayThinkingProcess called with result:", result);
        console.log("ğŸ§  _thinking_process:", result?._thinking_process ? "å­˜åœ¨ï¼ˆé•¿åº¦: " + result._thinking_process.length + " å­—ç¬¦ï¼‰" : "ä¸å­˜åœ¨");
        
        // å§‹ç»ˆæ˜¾ç¤ºåŒºåŸŸ
        thinkingSection.style.display = "block";
        
        if (!result) {
          thinkingContent.innerHTML = `<div style="color: #f59e0b;">âš ï¸ æœªæ”¶åˆ°ç»“æœæ•°æ®</div>`;
          return;
        }
        
        if (!result._thinking_process) {
          console.log("âš ï¸ No _thinking_process found");
          thinkingContent.innerHTML = `
            <div style="color: #f59e0b; padding: 12px; background: #fef3c7; border-radius: 4px;">
              <strong>âš ï¸ æœªæ£€æµ‹åˆ°æ€è€ƒè¿‡ç¨‹</strong><br>
              <div style="margin-top: 8px; font-size: 13px;">
                å¯èƒ½çš„åŸå› ï¼š<br>
                1. æ¨¡å‹æœªè¿”å›æ€è€ƒè¿‡ç¨‹<br>
                2. æ€è€ƒè¿‡ç¨‹æ ¼å¼æœªè¢«è¯†åˆ«<br>
                3. åç«¯æœªæ­£ç¡®æå–æ€è€ƒè¿‡ç¨‹<br><br>
                ç»“æœå¯¹è±¡é”®: ${Object.keys(result).join(', ')}
              </div>
            </div>
          `;
          return;
        }
        
        thinkingContent.textContent = result._thinking_process;
      }
      
      // æ˜¾ç¤ºMarkdownæ ¼å¼çš„ç»“æœ
      function displayMarkdownResult(result) {
        if (!markdownOutput || !outputSection) {
          console.error("âŒ æ‰¾ä¸åˆ°markdownè¾“å‡ºåŒºåŸŸçš„DOMå…ƒç´ ï¼");
          return;
        }
        
        if (!result) {
          markdownOutput.innerHTML = "<p>æš‚æ— ç»“æœ</p>";
          outputSection.style.display = "block";
          return;
        }

        let markdown = "";
        
        // æ€è€ƒè¿‡ç¨‹å·²ç»åœ¨ç‹¬ç«‹åŒºåŸŸæ˜¾ç¤ºï¼Œè¿™é‡Œä¸å†é‡å¤æ˜¾ç¤º

        if (result.personalized_intro) {
          markdown += `## 1. ä¸ªæ€§åŒ–å¯¼è¯»\n\n${result.personalized_intro}\n\n`;
        }

        if (result.interpretation) {
          markdown += `## 2. æ­£å¼è§£è¯»å†…å®¹\n\n${result.interpretation}\n\n`;
        }

        if (result.summary_and_application) {
          markdown += `## 3. ç« èŠ‚æ€»ç»“ä¸åº”ç”¨\n\n${result.summary_and_application}\n\n`;
        }

        if (result.powerful_questions) {
          markdown += `## 4. å¼ºæœ‰åŠ›çš„æ€è€ƒé—®é¢˜\n\n`;
          if (typeof result.powerful_questions === "string") {
            markdown += `${result.powerful_questions}\n\n`;
          } else if (Array.isArray(result.powerful_questions)) {
            result.powerful_questions.forEach((q) => {
              markdown += `- ${q}\n`;
            });
            markdown += `\n`;
          }
        }

        if (result.quiz && Array.isArray(result.quiz)) {
          markdown += `## 5. ç« èŠ‚è€ƒè¯•\n\n`;
          result.quiz.forEach((item, index) => {
            markdown += `### é¢˜ç›® ${index + 1}\n\n`;
            markdown += `**${item.question || ""}**\n\n`;
            if (item.options && Array.isArray(item.options)) {
              item.options.forEach((opt, idx) => {
                markdown += `${String.fromCharCode(65 + idx)}. ${opt}\n`;
              });
            }
            markdown += `\n**ç­”æ¡ˆï¼š** ${item.answer || "?"}\n\n`;
            if (item.explanation) {
              markdown += `**è§£æï¼š** ${item.explanation}\n\n`;
            }
            markdown += `---\n\n`;
          });
        }

        // ä½¿ç”¨ marked åº“æ¸²æŸ“ Markdown
        if (typeof marked !== "undefined") {
          markdownOutput.innerHTML = marked.parse(markdown);
        } else {
          // é™çº§æ–¹æ¡ˆï¼šç›´æ¥æ˜¾ç¤ºåŸå§‹ Markdown
          markdownOutput.textContent = markdown;
        }

        outputSection.style.display = "block";
        markdownOutput.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // äº‹ä»¶ç›‘å¬
      bookSelect.addEventListener("change", (e) => {
        const bookId = e.target.value;
        if (bookId) {
          loadChapters(bookId);
        } else {
          chapterSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©ä¹¦ç±</option>';
          chapterSelect.disabled = true;
          selectedBook = null;
          selectedChapter = null;
          updateGenerateButton();
        }
      });

      chapterSelect.addEventListener("change", (e) => {
        const chapterId = e.target.value;
        if (chapterId && chapters.length > 0) {
          selectedChapter = chapters.find((ch) => ch.id === parseInt(chapterId));
        } else {
          selectedChapter = null;
        }
        updateGenerateButton();
      });

      // ç›®å½•ä¸æ‘˜è¦è¯»å–åŠŸèƒ½
      document.addEventListener("DOMContentLoaded", () => {
        const tocSummaryButton = document.getElementById("tocSummaryButton");
        const tocSummaryResult = document.getElementById("tocSummaryResult");
        const tocSummaryText = document.getElementById("tocSummaryText");
        const copyTocSummaryButton = document.getElementById("copyTocSummaryButton");

        if (tocSummaryButton) {
          tocSummaryButton.addEventListener("click", async () => {
            if (!selectedBook || !chapters || chapters.length === 0) {
              renderStatus(promptStatus, "è¯·å…ˆé€‰æ‹©ä¹¦ç±å¹¶åŠ è½½ç« èŠ‚", "error");
              return;
            }

            tocSummaryButton.disabled = true;
            tocSummaryButton.textContent = "è¯»å–ä¸­...";
            tocSummaryButton.style.opacity = "0.6";
            tocSummaryResult.style.display = "none";

            try {
              // ç”Ÿæˆç›®å½•ä¸æ‘˜è¦æ–‡æœ¬
              let text = "";
              for (let i = 0; i < chapters.length; i++) {
                const chapter = chapters[i];
                const chapterNumber = i + 1;
                const chapterTitle = chapter.title_zh || chapter.title || `ç¬¬${chapterNumber}ç« `;
                const chapterSummary = chapter.summary || "";

                // æ ¼å¼ï¼šç« èŠ‚åºå·+ç« èŠ‚æ ‡é¢˜+æ‘˜è¦
                text += `${chapterNumber}. ${chapterTitle}`;
                if (chapterSummary) {
                  text += `\n${chapterSummary}`;
                }
                text += "\n\n";
              }

              // æ˜¾ç¤ºç»“æœ
              tocSummaryText.value = text.trim();
              tocSummaryResult.style.display = "block";
              // ç¡®ä¿è§£è¯»ç»“æœåŒºåŸŸæ˜¾ç¤º
              const outputSection = document.getElementById("outputSection");
              if (outputSection) {
                outputSection.style.display = "block";
              }
              renderStatus(promptStatus, `æˆåŠŸè¯»å– ${chapters.length} ä¸ªç« èŠ‚çš„ç›®å½•ä¸æ‘˜è¦`, "success");
            } catch (error) {
              console.error("è¯»å–ç›®å½•ä¸æ‘˜è¦å¤±è´¥:", error);
              renderStatus(promptStatus, `è¯»å–å¤±è´¥: ${error.message}`, "error");
            } finally {
              tocSummaryButton.disabled = false;
              tocSummaryButton.textContent = "ğŸ“‹ ç›®å½•ä¸æ‘˜è¦è¯»å–";
              tocSummaryButton.style.opacity = "1";
            }
          });
        }

        // å¤åˆ¶ç›®å½•ä¸æ‘˜è¦æ–‡æœ¬
        if (copyTocSummaryButton) {
          copyTocSummaryButton.addEventListener("click", () => {
            if (tocSummaryText && tocSummaryText.value) {
              tocSummaryText.select();
              document.execCommand("copy");
              renderStatus(promptStatus, "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
              
              // æ˜¾ç¤ºä¸´æ—¶æç¤º
              const originalText = copyTocSummaryButton.textContent;
              copyTocSummaryButton.textContent = "âœ“ å·²å¤åˆ¶";
              setTimeout(() => {
                copyTocSummaryButton.textContent = originalText;
              }, 2000);
            }
          });
        }
      });

      // æ˜¾ç¤ºæ’­å®¢æŒ‰é’®
      function showPodcastButton() {
        podcastSection.style.display = "block";
        document.getElementById("podcastButtonContainer").style.display = "block";
        document.getElementById("podcastAudioContainer").style.display = "none";
      }

      // éšè—æ’­å®¢æŒ‰é’®
      function hidePodcastButton() {
        podcastSection.style.display = "none";
      }

      // ä»ç»“æœç”Ÿæˆæ’­å®¢ï¼ˆç‚¹å‡»æŒ‰é’®æ—¶è°ƒç”¨ï¼‰
      async function generatePodcastFromResult() {
        if (!currentInterpretationResult) {
          podcastStatus.textContent = "æ²¡æœ‰å¯ç”¨çš„è§£è¯»ç»“æœ";
          return;
        }
        await generatePodcast(currentInterpretationResult);
      }

      // ç”Ÿæˆæ’­å®¢éŸ³é¢‘
      async function generatePodcast(interpretationResult) {
        if (!interpretationResult) {
          return;
        }
        
        // ç»„åˆè§£è¯»æ–‡æœ¬
        let podcastText = "";
        if (interpretationResult.personalized_intro) {
          podcastText += interpretationResult.personalized_intro + "\n\n";
        }
        if (interpretationResult.interpretation) {
          podcastText += interpretationResult.interpretation + "\n\n";
        }
        if (interpretationResult.summary_and_application) {
          podcastText += interpretationResult.summary_and_application + "\n\n";
        }
        
        if (!podcastText.trim()) {
          podcastStatus.textContent = "æ²¡æœ‰å¯ç”¨çš„æ–‡æœ¬å†…å®¹ç”Ÿæˆæ’­å®¢";
          return;
        }
        
        // éšè—æŒ‰é’®ï¼Œæ˜¾ç¤ºéŸ³é¢‘å®¹å™¨
        document.getElementById("podcastButtonContainer").style.display = "none";
        document.getElementById("podcastAudioContainer").style.display = "block";
        podcastStatus.textContent = "æ­£åœ¨ç”Ÿæˆæ’­å®¢éŸ³é¢‘...";
        podcastAudio.src = "";
        currentAudioBlob = null;
        
        try {
          const podcastPayload = {
            text: podcastText,
            voice_type: voiceType.value,
            language: "zh",
            speed_ratio: 1.0,
            volume_ratio: 1.0,
            pitch_ratio: 1.0,
          };
          
          const response = await fetch("/api/podcast/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(podcastPayload),
            signal: AbortSignal.timeout(120000), // 2åˆ†é’Ÿè¶…æ—¶
          });
          
          if (!response.ok) {
            let errorMessage = "ç”Ÿæˆæ’­å®¢å¤±è´¥";
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }
          
          const data = await response.json();
          
          // å°†Base64éŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºBlob
          const audioBytes = Uint8Array.from(atob(data.audio_base64), c => c.charCodeAt(0));
          currentAudioBlob = new Blob([audioBytes], { type: "audio/mpeg" });
          const audioUrl = URL.createObjectURL(currentAudioBlob);
          
          podcastAudio.src = audioUrl;
          podcastStatus.textContent = `æ’­å®¢ç”ŸæˆæˆåŠŸï¼æ—¶é•¿ï¼š${data.duration || "æœªçŸ¥"}ç§’`;
        } catch (error) {
          console.error("ç”Ÿæˆæ’­å®¢å¤±è´¥:", error);
          podcastStatus.textContent = `ç”Ÿæˆæ’­å®¢å¤±è´¥: ${error.message}`;
          podcastStatus.style.color = "#b91c1c";
        }
      }
      
      // ä¸‹è½½æ’­å®¢éŸ³é¢‘
      downloadPodcast.addEventListener("click", () => {
        if (!currentAudioBlob) {
          alert("æ²¡æœ‰å¯ä¸‹è½½çš„éŸ³é¢‘");
          return;
        }
        
        const url = URL.createObjectURL(currentAudioBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `æ’­å®¢_${selectedChapter?.title_zh || selectedChapter?.title || "è§£è¯»"}_${new Date().getTime()}.mp3`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
      
      // æ’­å®¢é…ç½®æ˜¾ç¤º/éšè—
      enablePodcast.addEventListener("change", (e) => {
        podcastConfig.style.display = e.target.checked ? "flex" : "none";
      });
      
      // ========== ä¹¦ç±é‡æ„åŠŸèƒ½ ==========
      let restructureBook = null;
      let restructureChapters = [];
      let restructuredTocContent = null; // å­˜å‚¨é‡æ„åçš„ç›®å½•å†…å®¹
      let newBookStructure = null; // å­˜å‚¨æ–°ä¹¦ç±ç»“æ„

      // ä¸ºä¹¦ç±é‡æ„åŠ è½½ä¹¦ç±åˆ—è¡¨
      async function loadBooksForRestructure() {
        const restructureBookSelect = document.getElementById("restructureBookSelect");
        if (!restructureBookSelect) return;

        try {
          const response = await fetch("/api/admin/books?page=1&per_page=100");
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }

          const booksList = data.books || [];
          restructureBookSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>';
          booksList.forEach((book) => {
            const option = document.createElement("option");
            option.value = book.id;
            option.textContent = `${book.filename} (${book.chapter_count}ç« )`;
            restructureBookSelect.appendChild(option);
          });
        } catch (error) {
          console.error("åŠ è½½ä¹¦ç±å¤±è´¥:", error);
          const restructureStatus = document.getElementById("restructureStatus");
          if (restructureStatus) {
            renderStatus(restructureStatus, `åŠ è½½ä¹¦ç±å¤±è´¥: ${error.message}`, "error");
          }
        }
      }

      // ä¹¦ç±é€‰æ‹©å˜åŒ–äº‹ä»¶
      const restructureBookSelect = document.getElementById("restructureBookSelect");
      if (restructureBookSelect) {
        restructureBookSelect.addEventListener("change", async (e) => {
          const bookId = e.target.value;
          const restructureTocButton = document.getElementById("restructureTocButton");
          const restructureStatus = document.getElementById("restructureStatus");
          
          if (bookId) {
            try {
              const response = await fetch(`/api/admin/books/${bookId}`);
              const data = await response.json();
              if (data.error) {
                throw new Error(data.error);
              }

              restructureBook = data.book;
              restructureChapters = data.chapters || [];
              
              // å¯ç”¨é‡æ„ç›®å½•æŒ‰é’®
              if (restructureTocButton) {
                restructureTocButton.disabled = false;
              }
              
              if (restructureStatus) {
                renderStatus(restructureStatus, `å·²åŠ è½½ä¹¦ç±ï¼š${restructureBook.filename} (${restructureChapters.length}ç« )`, "success");
              }
            } catch (error) {
              console.error("åŠ è½½ä¹¦ç±ç« èŠ‚å¤±è´¥:", error);
              if (restructureStatus) {
                renderStatus(restructureStatus, `åŠ è½½å¤±è´¥: ${error.message}`, "error");
              }
            }
          } else {
            restructureBook = null;
            restructureChapters = [];
            if (restructureTocButton) {
              restructureTocButton.disabled = true;
            }
          }
        });
      }

      // é‡æ„ç›®å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const restructureTocButton = document.getElementById("restructureTocButton");
      if (restructureTocButton) {
        restructureTocButton.addEventListener("click", async () => {
          if (!restructureBook || !restructureChapters || restructureChapters.length === 0) {
            const restructureStatus = document.getElementById("restructureStatus");
            if (restructureStatus) {
              renderStatus(restructureStatus, "è¯·å…ˆé€‰æ‹©ä¹¦ç±", "error");
            }
            return;
          }

          const restructurePrompt = document.getElementById("restructurePrompt");
          if (!restructurePrompt || !restructurePrompt.value.trim()) {
            const restructureStatus = document.getElementById("restructureStatus");
            if (restructureStatus) {
              renderStatus(restructureStatus, "è¯·è¾“å…¥é‡æ„æç¤ºè¯", "error");
            }
            return;
          }

          // ç¦ç”¨æŒ‰é’®
          restructureTocButton.disabled = true;
          restructureTocButton.textContent = "é‡æ„ä¸­...";
          
          const restructureResult = document.getElementById("restructureResult");
          const restructureResultContent = document.getElementById("restructureResultContent");
          const restructureStatus = document.getElementById("restructureStatus");
          const generateNewBookButton = document.getElementById("generateNewBookButton");

          if (restructureResult) {
            restructureResult.style.display = "none";
          }
          if (restructureStatus) {
            renderStatus(restructureStatus, "æ­£åœ¨è¯»å–ä¹¦ç±ç›®å½•ä¸æ‘˜è¦...", "info");
          }

          try {
            // ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆç›®å½•ä¸æ‘˜è¦æ–‡æœ¬
            const tocSummaryText = generateTocSummaryText(restructureChapters);
            
            if (restructureStatus) {
              renderStatus(restructureStatus, "æ­£åœ¨è°ƒç”¨æ·±åº¦æ€è€ƒæ¨¡å‹ç”Ÿæˆæ–°ç›®å½•...", "info");
            }

            // ç¬¬äºŒæ­¥ï¼šæ„å»ºå®Œæ•´çš„æç¤ºè¯ï¼ˆç”¨æˆ·æç¤ºè¯ + åŸç›®å½•ä¸æ‘˜è¦ï¼‰
            const userPrompt = restructurePrompt.value.trim();
            const fullPrompt = `${userPrompt}\n\nã€åŸä¹¦ç±ç›®å½•ä¸æ‘˜è¦ã€‘\n${tocSummaryText}`;

            // ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨æ·±åº¦æ€è€ƒæ¨¡å‹
            const result = await interpretWithDeepThinking(
              tocSummaryText,  // content
              fullPrompt,       // prompt
              {
                replacements: {
                  chapter_fulltext: tocSummaryText
                }
              }
            );

            // ä¿å­˜é‡æ„åçš„ç›®å½•å†…å®¹
            restructuredTocContent = result.content;

            // ç¬¬å››æ­¥ï¼šæ˜¾ç¤ºç»“æœ
            if (restructureResultContent) {
              // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆç»“æœ
              let resultHtml = "";
              
              // æ€è€ƒè¿‡ç¨‹
              if (result.reasoning_content) {
                resultHtml += `<div style="margin-bottom: 16px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">`;
                resultHtml += `<h5 style="margin-top: 0; margin-bottom: 12px; color: #1e40af; font-size: 15px; font-weight: 600;">ğŸ§  æ€è€ƒè¿‡ç¨‹</h5>`;
                resultHtml += `<div style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; font-size: 14px; max-height: 300px; overflow-y: auto; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #bfdbfe;">${escapeHtml(result.reasoning_content)}</div>`;
                resultHtml += `</div>`;
              }
              
              // æœ€ç»ˆç»“æœï¼ˆé‡æ„åçš„ç›®å½•ï¼‰
              if (result.content) {
                resultHtml += `<div style="padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">`;
                resultHtml += `<h5 style="margin-top: 0; margin-bottom: 12px; color: #065f46; font-size: 15px; font-weight: 600;">âœ… é‡æ„åçš„ç›®å½•</h5>`;
                resultHtml += `<div style="white-space: pre-wrap; line-height: 1.8; color: #1e293b; font-size: 14px; padding: 12px; background: #ffffff; border-radius: 6px; border: 1px solid #86efac;">${escapeHtml(result.content)}</div>`;
                resultHtml += `</div>`;
              } else {
                resultHtml += `<div style="padding: 12px; background: #fee2e2; border-radius: 6px; border-left: 3px solid #ef4444;">`;
                resultHtml += `<p style="color: #991b1b; margin: 0;">âŒ æœªè·å–åˆ°é‡æ„ç»“æœ</p>`;
                resultHtml += `</div>`;
              }
              
              restructureResultContent.innerHTML = resultHtml;
            }

            if (restructureResult) {
              restructureResult.style.display = "block";
            }
            
            // å¯ç”¨æ–°ä¹¦ç”ŸæˆæŒ‰é’®
            if (generateNewBookButton && result.content) {
              generateNewBookButton.disabled = false;
            }
            
            if (restructureStatus) {
              renderStatus(restructureStatus, "ç›®å½•é‡æ„å®Œæˆï¼å¯ä»¥ç‚¹å‡»ã€æ–°ä¹¦ç”Ÿæˆã€‘æŒ‰é’®ç”Ÿæˆæ–°ä¹¦", "success");
            }
          } catch (error) {
            console.error("é‡æ„ç›®å½•å¤±è´¥:", error);
            const errorMessage = error.message || "é‡æ„å¤±è´¥";
            if (restructureStatus) {
              renderStatus(restructureStatus, `é‡æ„å¤±è´¥: ${errorMessage}`, "error");
            }
            if (restructureResultContent) {
              restructureResultContent.innerHTML = `<p style='color: #ef4444;'>${escapeHtml(errorMessage)}</p>`;
            }
            if (restructureResult) {
              restructureResult.style.display = "block";
            }
          } finally {
            // æ¢å¤æŒ‰é’®
            restructureTocButton.disabled = false;
            restructureTocButton.textContent = "ğŸ”„ é‡æ„ç›®å½•";
          }
        });
      }

      /**
       * è§£ææ–°ç›®å½•ç»“æ„ï¼Œæå–PART1, PART2ç­‰ç« èŠ‚ä¿¡æ¯
       * @param {string} tocText - é‡æ„åçš„ç›®å½•æ–‡æœ¬
       * @returns {Array} ç« èŠ‚æ•°ç»„ï¼ŒåŒ…å« {title: string, partNumber: number}
       */
      function parseNewTocStructure(tocText) {
        if (!tocText) return [];
        
        const parts = [];
        const lines = tocText.split('\n');
        
        for (const line of lines) {
          const trimmedLine = line.trim();
          if (!trimmedLine) continue;
          
          // åŒ¹é… PART1, PART 1, ç¬¬ä¸€éƒ¨åˆ†, ç¬¬1éƒ¨åˆ†, 1. ç­‰æ ¼å¼
          const partMatch = trimmedLine.match(/^(?:PART\s*)?(\d+)[\.ã€]?\s*(?:ç¬¬\s*)?(?:ä¸€|äºŒ|ä¸‰|å››|äº”|å…­|ä¸ƒ|å…«|ä¹|å|\d+)?éƒ¨åˆ†[ï¼š:ï¼š]?\s*(.+)$/i);
          if (partMatch) {
            const partNumber = parseInt(partMatch[1]);
            const title = partMatch[2] || trimmedLine.replace(/^(?:PART\s*)?\d+[\.ã€]?\s*/, '');
            parts.push({
              partNumber: partNumber,
              title: title.trim(),
              originalText: trimmedLine
            });
            continue;
          }
          
          // åŒ¹é…æ•°å­—å¼€å¤´çš„ç« èŠ‚
          const numMatch = trimmedLine.match(/^(\d+)[\.ã€]\s*(.+)$/);
          if (numMatch) {
            const partNumber = parseInt(numMatch[1]);
            const title = numMatch[2].trim();
            parts.push({
              partNumber: partNumber,
              title: title,
              originalText: trimmedLine
            });
          }
        }
        
        return parts.sort((a, b) => a.partNumber - b.partNumber);
      }

      /**
       * æ ¹æ®æ–°ç›®å½•åŒ¹é…åŸä¹¦ç±ç« èŠ‚å†…å®¹
       * @param {Array} newParts - æ–°ç›®å½•çš„ç« èŠ‚æ•°ç»„
       * @param {Array} originalChapters - åŸä¹¦ç±çš„ç« èŠ‚æ•°ç»„
       * @returns {Array} åŒ¹é…åçš„ç« èŠ‚å†…å®¹æ•°ç»„
       */
      function matchChaptersToNewParts(newParts, originalChapters) {
        const matchedContent = [];
        
        for (const part of newParts) {
          // å°è¯•æ ¹æ®æ ‡é¢˜åŒ¹é…åŸç« èŠ‚
          const matchedChapters = originalChapters.filter(chapter => {
            const chapterTitle = (chapter.title_zh || chapter.title || '').toLowerCase();
            const partTitle = part.title.toLowerCase();
            
            // ç®€å•åŒ¹é…ï¼šå¦‚æœæ–°æ ‡é¢˜åŒ…å«åœ¨åŸæ ‡é¢˜ä¸­ï¼Œæˆ–åŸæ ‡é¢˜åŒ…å«åœ¨æ–°æ ‡é¢˜ä¸­
            return chapterTitle.includes(partTitle) || partTitle.includes(chapterTitle);
          });
          
          // åˆå¹¶åŒ¹é…çš„ç« èŠ‚å†…å®¹
          let combinedContent = '';
          for (const chapter of matchedChapters) {
            const content = chapter.content_zh || chapter.content || '';
            if (content) {
              combinedContent += content + '\n\n';
            }
          }
          
          matchedContent.push({
            partNumber: part.partNumber,
            title: part.title,
            content: combinedContent.trim(),
            originalChapters: matchedChapters
          });
        }
        
        return matchedContent;
      }

      /**
       * è°ƒç”¨å•æ®µæ–‡ç« åˆ†å‰²æ¥å£
       * @param {string} title - ç« èŠ‚æ ‡é¢˜
       * @param {string} content - ç« èŠ‚å†…å®¹
       * @param {number} maxWordCount - æœ€å¤§å­—æ•°
       * @returns {Promise<Array>} åˆ†å‰²åçš„æ®µè½æ•°ç»„
       */
      async function splitChapterContent(title, content, maxWordCount) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†é’Ÿè¶…æ—¶
        
        try {
          const response = await fetch("/api/restructure/split-chapter", {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "Accept": "application/json"
            },
            body: JSON.stringify({
              title: title || "æœªå‘½åç« èŠ‚",
              content: content.trim(),
              max_word_count: maxWordCount,
              word_count: 0 // åç«¯ä¼šè‡ªåŠ¨è®¡ç®—
            }),
            signal: controller.signal,
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            let errorMessage = `åˆ†å‰²å¤±è´¥ (çŠ¶æ€ç : ${response.status})`;
            try {
              const errorText = await response.text();
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                errorMessage = errorText || errorMessage;
              }
            } catch (e) {
              // å¦‚æœæ— æ³•è¯»å–å“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯æ¶ˆæ¯
            }
            throw new Error(errorMessage);
          }
          
          let splitResult;
          try {
            splitResult = await response.json();
          } catch (jsonError) {
            throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ${jsonError.message}`);
          }
          
          const segments = splitResult.segments || [];
          
          if (segments.length === 0) {
            throw new Error("åˆ†å‰²å¤±è´¥ï¼Œæœªç”Ÿæˆä»»ä½•ç‰‡æ®µ");
          }
          
          // æ ¼å¼åŒ–è¿”å›ç»“æœ
          return segments.map((segment, index) => ({
            title: segment.title || `ç¬¬${index + 1}éƒ¨åˆ†`,
            content: segment.content || "",
            word_count: segment.word_count || 0
          }));
          
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === "AbortError") {
            throw new Error("è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡10åˆ†é’Ÿï¼‰ï¼Œè¯·ç¨åé‡è¯•æˆ–å‡å°‘æ–‡ç« é•¿åº¦");
          }
          const errorMsg = fetchError.message || String(fetchError);
          if (errorMsg.includes("Failed to fetch") || errorMsg.includes("NetworkError")) {
            throw new Error("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ");
          }
          throw fetchError;
        }
      }

      // æ–°ä¹¦ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const generateNewBookButton = document.getElementById("generateNewBookButton");
      if (generateNewBookButton) {
        generateNewBookButton.addEventListener("click", async () => {
          if (!restructuredTocContent) {
            const restructureStatus = document.getElementById("restructureStatus");
            if (restructureStatus) {
              renderStatus(restructureStatus, "è¯·å…ˆå®Œæˆç›®å½•é‡æ„", "error");
            }
            return;
          }

          const restructureMaxWords = document.getElementById("restructureMaxWords");
          const maxWordCount = parseInt(restructureMaxWords?.value || "5000");
          
          if (isNaN(maxWordCount) || maxWordCount <= 0) {
            const restructureStatus = document.getElementById("restructureStatus");
            if (restructureStatus) {
              renderStatus(restructureStatus, "åˆ†å‰²å­—æ•°ä¸Šé™è®¾ç½®æ— æ•ˆ", "error");
            }
            return;
          }

          // ç¦ç”¨æŒ‰é’®
          generateNewBookButton.disabled = true;
          generateNewBookButton.textContent = "ç”Ÿæˆä¸­...";
          
          const restructureStatus = document.getElementById("restructureStatus");
          const newBookResult = document.getElementById("newBookResult");
          const newBookResultContent = document.getElementById("newBookResultContent");

          if (newBookResult) {
            newBookResult.style.display = "none";
          }
          if (restructureStatus) {
            renderStatus(restructureStatus, "å¼€å§‹ç”Ÿæˆæ–°ä¹¦...", "info");
          }

          try {
            // ç¬¬ä¸€æ­¥ï¼šè§£ææ–°ç›®å½•ç»“æ„
            if (restructureStatus) {
              renderStatus(restructureStatus, "æ­£åœ¨è§£ææ–°ç›®å½•ç»“æ„...", "info");
            }
            const newParts = parseNewTocStructure(restructuredTocContent);
            
            if (newParts.length === 0) {
              throw new Error("æ— æ³•è§£ææ–°ç›®å½•ç»“æ„ï¼Œè¯·æ£€æŸ¥é‡æ„åçš„ç›®å½•æ ¼å¼");
            }

            // ç¬¬äºŒæ­¥ï¼šåŒ¹é…åŸä¹¦ç±ç« èŠ‚å†…å®¹åˆ°æ–°ç›®å½•
            if (restructureStatus) {
              renderStatus(restructureStatus, `æ­£åœ¨åŒ¹é…åŸä¹¦ç±ç« èŠ‚åˆ°æ–°ç›®å½•ï¼ˆ${newParts.length}ä¸ªéƒ¨åˆ†ï¼‰...`, "info");
            }
            const matchedContent = matchChaptersToNewParts(newParts, restructureChapters);

            // ç¬¬ä¸‰æ­¥ï¼šé€ç« å¤„ç† - åˆå¹¶å†…å®¹å¹¶åˆ†å‰²
            const newBookChapters = [];
            
            for (let i = 0; i < matchedContent.length; i++) {
              const part = matchedContent[i];
              
              if (restructureStatus) {
                renderStatus(restructureStatus, `æ­£åœ¨å¤„ç†ç¬¬ ${i + 1}/${matchedContent.length} éƒ¨åˆ†ï¼š${part.title}...`, "info");
              }

              // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œè·³è¿‡
              if (!part.content || part.content.trim().length === 0) {
                newBookChapters.push({
                  partNumber: part.partNumber,
                  title: part.title,
                  segments: [{
                    title: part.title,
                    content: "[è¯¥éƒ¨åˆ†æš‚æ— å†…å®¹]",
                    word_count: 0
                  }]
                });
                continue;
              }

              try {
                // è°ƒç”¨åˆ†å‰²æ¥å£
                const segments = await splitChapterContent(part.title, part.content, maxWordCount);
                
                newBookChapters.push({
                  partNumber: part.partNumber,
                  title: part.title,
                  segments: segments
                });

                if (restructureStatus) {
                  renderStatus(restructureStatus, `ç¬¬ ${i + 1} éƒ¨åˆ†å®Œæˆï¼š${segments.length} ä¸ªæ®µè½`, "info");
                }
              } catch (error) {
                console.error(`å¤„ç†ç¬¬ ${i + 1} éƒ¨åˆ†å¤±è´¥:`, error);
                // å¦‚æœåˆ†å‰²å¤±è´¥ï¼Œä»ç„¶ä¿ç•™åŸå†…å®¹
                newBookChapters.push({
                  partNumber: part.partNumber,
                  title: part.title,
                  segments: [{
                    title: part.title,
                    content: part.content,
                    word_count: part.content.length,
                    error: error.message
                  }]
                });
              }
            }

            // ä¿å­˜æ–°ä¹¦ç±ç»“æ„
            newBookStructure = {
              originalBook: restructureBook,
              newToc: restructuredTocContent,
              chapters: newBookChapters,
              maxWordCount: maxWordCount,
              generatedAt: new Date().toISOString()
            };

            // ç¬¬å››æ­¥ï¼šæ˜¾ç¤ºæ–°ä¹¦ç»“æ„
            if (newBookResultContent) {
              let resultHtml = `<div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6;">`;
              resultHtml += `<h4 style="margin: 0 0 8px 0; color: #1e40af;">ğŸ“š æ–°ä¹¦ç»“æ„</h4>`;
              resultHtml += `<div style="font-size: 13px; color: #475569;">`;
              resultHtml += `<div>åŸä¹¦ç±ï¼š${restructureBook?.filename || 'æœªçŸ¥'}</div>`;
              resultHtml += `<div>æ–°ä¹¦ç±éƒ¨åˆ†æ•°ï¼š${newBookChapters.length}</div>`;
              resultHtml += `<div>åˆ†å‰²å­—æ•°ä¸Šé™ï¼š${maxWordCount}å­—</div>`;
              resultHtml += `<div>ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</div>`;
              resultHtml += `</div></div>`;

              // æ˜¾ç¤ºæ¯ä¸ªéƒ¨åˆ†çš„è¯¦ç»†ä¿¡æ¯
              for (const chapter of newBookChapters) {
                resultHtml += `<div style="margin-bottom: 20px; padding: 16px; background: #ffffff; border-radius: 8px; border: 1px solid #e2e8f0;">`;
                resultHtml += `<h5 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px; font-weight: 600;">ç¬¬ ${chapter.partNumber} éƒ¨åˆ†ï¼š${escapeHtml(chapter.title)}</h5>`;
                resultHtml += `<div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">åŒ…å« ${chapter.segments.length} ä¸ªæ®µè½</div>`;
                
                // æ˜¾ç¤ºæ¯ä¸ªæ®µè½
                for (let j = 0; j < chapter.segments.length; j++) {
                  const segment = chapter.segments[j];
                  resultHtml += `<div style="margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #cbd5e1;">`;
                  resultHtml += `<div style="font-weight: 600; color: #475569; margin-bottom: 6px;">æ®µè½ ${j + 1}ï¼š${escapeHtml(segment.title)}</div>`;
                  if (segment.word_count > 0) {
                    resultHtml += `<div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">å­—æ•°ï¼š${segment.word_count.toLocaleString()} å­—</div>`;
                  }
                  if (segment.error) {
                    resultHtml += `<div style="font-size: 12px; color: #ef4444; margin-bottom: 8px;">âš ï¸ åˆ†å‰²å¤±è´¥ï¼š${escapeHtml(segment.error)}</div>`;
                  }
                  resultHtml += `<div style="font-size: 13px; color: #64748b; max-height: 100px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6;">${escapeHtml(segment.content.substring(0, 500))}${segment.content.length > 500 ? '...' : ''}</div>`;
                  resultHtml += `</div>`;
                }
                
                resultHtml += `</div>`;
              }

              newBookResultContent.innerHTML = resultHtml;
            }

            if (newBookResult) {
              newBookResult.style.display = "block";
            }
            if (restructureStatus) {
              renderStatus(restructureStatus, `æ–°ä¹¦ç”Ÿæˆå®Œæˆï¼å…± ${newBookChapters.length} ä¸ªéƒ¨åˆ†`, "success");
            }
          } catch (error) {
            console.error("ç”Ÿæˆæ–°ä¹¦å¤±è´¥:", error);
            const errorMessage = error.message || "ç”Ÿæˆå¤±è´¥";
            if (restructureStatus) {
              renderStatus(restructureStatus, `ç”Ÿæˆå¤±è´¥: ${errorMessage}`, "error");
            }
            if (newBookResultContent) {
              newBookResultContent.innerHTML = `<p style='color: #ef4444;'>${escapeHtml(errorMessage)}</p>`;
            }
            if (newBookResult) {
              newBookResult.style.display = "block";
            }
          } finally {
            // æ¢å¤æŒ‰é’®
            generateNewBookButton.disabled = false;
            generateNewBookButton.textContent = "ğŸ“– æ–°ä¹¦ç”Ÿæˆ";
          }
        });
      }

      // åˆå§‹åŒ–ï¼šåŠ è½½æç¤ºè¯å¹¶è®¾ç½®ç¬¬ä¸€ä¸ªæ ‡ç­¾ä¸ºæ¿€æ´»çŠ¶æ€
      document.addEventListener("DOMContentLoaded", () => {
        loadPromptParts();
        switchPromptTab("intro");
        selectDensity(selectedDensity);
        // è‡ªåŠ¨é«˜äº®å½“å‰é¡µé¢çš„å¯¼èˆªé“¾æ¥
        highlightCurrentNav();
      });

      // è‡ªåŠ¨é«˜äº®å½“å‰é¡µé¢çš„å¯¼èˆªé“¾æ¥
      function highlightCurrentNav() {
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-link').forEach(link => {
          if (link.getAttribute('href') === currentPath || 
              (currentPath === '/' && link.getAttribute('href') === '/') ||
              (currentPath !== '/' && currentPath.endsWith(link.getAttribute('href'))) ||
              link.getAttribute('href').includes(currentPath)) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      }

      generateButton.addEventListener("click", generateInterpretation);

      // åˆå§‹åŒ–
      loadBooks();
    </script>
  </body>
</html>
