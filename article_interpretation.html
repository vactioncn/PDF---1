<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è§£è¯»æ–‡ç« ç”Ÿæˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: light;
      font-family: "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      background-color: #f8fafc;
      color: #0f172a;
    }

    /* å¯¼èˆªæ æ ·å¼ */
    .top-navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 20px;
      margin: -24px -24px 24px -24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }

    .nav-brand {
      color: white;
      font-weight: 600;
      font-size: 18px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-brand:hover { opacity: 0.9; }

    .nav-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .nav-link:hover { background: rgba(255, 255, 255, 0.2); }
    .nav-link.active { background: rgba(255, 255, 255, 0.25); font-weight: 500; }

    body {
      margin: 0;
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 32px;
      font-weight: 600;
      color: #0f172a;
    }

    .subtitle {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 32px;
    }

    .panel {
      background: #ffffff;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      margin-bottom: 24px;
      border: 1px solid #e2e8f0;
    }

    .panel h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full-width { grid-column: 1 / -1; }

    label {
      font-weight: 600;
      font-size: 14px;
      color: #475569;
    }

    select, textarea {
      padding: 10px 14px;
      border: 1.5px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #ffffff;
    }

    select:focus, textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea {
      min-height: 200px;
      resize: vertical;
    }

    button {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: white;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    button.secondary { background: #64748b; }
    button.success { background: #10b981; }

    button:disabled {
      background: #cbd5e1;
      color: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      background: #f1f5f9;
      border-left: 4px solid #cbd5e1;
      display: none;
    }

    .status.info { display: block; background: #eff6ff; border-left-color: #3b82f6; color: #1e40af; }
    .status.success { display: block; background: #f0fdf4; border-left-color: #10b981; color: #065f46; }
    .status.error { display: block; background: #fef2f2; border-left-color: #ef4444; color: #991b1b; }

    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .result-container {
      margin-top: 20px;
      padding: 24px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      display: none;
    }

    .result-container.visible { display: block; }

    .result-content {
      line-height: 1.8;
      color: #1e293b;
      font-size: 15px;
    }

    .result-content h1, .result-content h2, .result-content h3 {
      color: #0f172a;
      margin-top: 24px;
      margin-bottom: 12px;
    }

    .result-content p { margin-bottom: 16px; }

    .thinking-box {
      margin-top: 16px;
      display: none;
    }

    .thinking-box.visible { display: block; }

    .thinking-box summary {
      cursor: pointer;
      padding: 8px 12px;
      background: #fef3c7;
      border-radius: 6px;
      font-weight: 500;
      color: #92400e;
    }

    .thinking-content {
      margin-top: 8px;
      padding: 12px;
      background: #fffbeb;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.7;
      color: #78350f;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .chapter-info {
      padding: 16px;
      background: #f1f5f9;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #475569;
      display: none;
    }

    .chapter-info.visible { display: block; }

    .word-count {
      font-size: 13px;
      color: #64748b;
      margin-top: 12px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <!-- å¯¼èˆªæ  -->
  <nav class="top-navbar">
    <div class="nav-container">
      <a href="/" class="nav-brand">ğŸ“š PDFè§£è¯»ç³»ç»Ÿ</a>
      <div class="nav-links">
        <a href="/" class="nav-link">ğŸ  é¦–é¡µ</a>
        <a href="/aigen_test_page.html" class="nav-link">âœ¨ ä¸ªæ€§åŒ–è§£è¯»</a>
        <a href="/article_interpretation.html" class="nav-link active">ğŸ“ è§£è¯»æ–‡ç« </a>
        <a href="/book_restructure_page.html" class="nav-link">ğŸ“š ä¹¦ç±é‡æ„</a>
        <a href="/parser_test_page.html" class="nav-link">ğŸ“„ æ–‡æ¡£è§£æ</a>
        <a href="/admin_books.html" class="nav-link">ğŸ“– ä¹¦ç±ç®¡ç†</a>
        <a href="/admin.html" class="nav-link">âš™ï¸ ç³»ç»Ÿç®¡ç†</a>
      </div>
    </div>
  </nav>

  <h1>ğŸ“ è§£è¯»æ–‡ç« ç”Ÿæˆ</h1>
  <p class="subtitle">é€‰æ‹©ä¹¦ç±å’Œç« èŠ‚ï¼Œä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å‹ç”Ÿæˆ 2000-2500 å­—çš„ä¸“ä¸šè§£è¯»æ–‡ç« </p>

  <!-- é€‰æ‹©ä¹¦ç±å’Œç« èŠ‚ -->
  <section class="panel">
    <h2>ğŸ“š é€‰æ‹©å†…å®¹</h2>
    <div class="form-grid">
      <div class="form-group">
        <label for="bookSelect">é€‰æ‹©ä¹¦ç±</label>
        <select id="bookSelect">
          <option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="chapterSelect">é€‰æ‹©ç« èŠ‚</label>
        <select id="chapterSelect" disabled>
          <option value="">è¯·å…ˆé€‰æ‹©ä¹¦ç±...</option>
        </select>
      </div>
    </div>
    
    <div class="chapter-info" id="chapterInfo">
      <strong>ç« èŠ‚ä¿¡æ¯ï¼š</strong>
      <div id="chapterTitle" style="margin-top: 8px;"></div>
      <div id="chapterWordCount" style="margin-top: 4px; color: #64748b;"></div>
    </div>

    <div class="action-buttons">
      <button id="generateBtn" disabled>ğŸš€ ç”Ÿæˆè§£è¯»æ–‡ç« </button>
      <button id="copyBtn" class="secondary" style="display: none;">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    </div>
    
    <div class="status" id="statusArea"></div>
  </section>

  <!-- æç¤ºè¯é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
  <section class="panel">
    <details>
      <summary style="cursor: pointer; font-weight: 600; font-size: 16px; color: #1e293b;">ğŸ”§ æç¤ºè¯é…ç½®ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
      <div style="margin-top: 16px;">
        <div class="form-group full-width">
          <label for="promptText">è§£è¯»æç¤ºè¯ï¼ˆ{BOOK_CHAPTER} å°†è¢«æ›¿æ¢ä¸ºç« èŠ‚å†…å®¹ï¼‰</label>
          <textarea id="promptText" rows="20"></textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 12px;">
          <button class="secondary" onclick="resetPrompt()">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
          <button class="secondary" onclick="savePrompt()">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
        </div>
      </div>
    </details>
  </section>

  <!-- ç»“æœå±•ç¤º -->
  <section class="panel" id="resultSection" style="display: none;">
    <h2>ğŸ“„ è§£è¯»ç»“æœ</h2>
    
    <details class="thinking-box" id="thinkingBox">
      <summary>ğŸ’­ æŸ¥çœ‹æ€è€ƒè¿‡ç¨‹</summary>
      <div class="thinking-content" id="thinkingContent"></div>
    </details>
    
    <div class="result-container visible">
      <div class="result-content" id="resultContent"></div>
      <div class="word-count" id="resultWordCount"></div>
    </div>
  </section>

  <script>
    // é»˜è®¤æç¤ºè¯
    const DEFAULT_PROMPT = `# Role: é¡¶çº§çŸ¥è¯†"è§£å‰–å¸ˆ"ä¸ç•…é”€ä¸“æ ä½œå®¶

## Profile
ä½ ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå¤è¿°è€…ï¼Œä½ æ˜¯ä¸€ä½ç»“åˆäº†**"è´¹æ›¼çš„é™ç»´æ‰“å‡»èƒ½åŠ›"**ã€**"çº¦ç‘Ÿå¤«Â·èˆ’æ ¼æ›¼çš„æ»‘æ¢¯æ–‡æ¡ˆæŠ€å·§"**ä»¥åŠ**"é©¬å°”ç§‘å§†Â·æ ¼æ‹‰å¾·å¨å°”çš„å™äº‹æ´å¯ŸåŠ›"**çš„é¡¶å°–å†…å®¹è§£å‰–å¸ˆã€‚ä½ çš„ä½¿å‘½æ˜¯å°†ä»»ä½•ä¸€æ®µè¾“å…¥çš„ä¹¦ç±ç« èŠ‚æ–‡æœ¬ï¼ˆæ— è®ºå¤šä¹ˆæ¯ç‡¥æˆ–æ·±å¥¥ï¼‰ï¼Œé‡é“¸ä¸ºä¸€ç¯‡è®©äºº"é¢…å†…é«˜æ½®"çš„æ·±åº¦è§£è¯»æ–‡ç« ï¼Œéœ€è¦†ç›–ä¹¦ç±ç« èŠ‚çš„æ ¸å¿ƒè®ºç‚¹ã€å…³é”®æ¡ˆä¾‹ã€åº•å±‚é€»è¾‘åŠå®è·µä»·å€¼å››ä¸ªæ ¸å¿ƒç»´åº¦ï¼Œæ·±åº¦ä½“ç°åœ¨å¯¹åº•å±‚é€»è¾‘çš„é€šä¿—åŒ–æ‹†è§£å’Œå®è·µä»·å€¼çš„åœºæ™¯åŒ–å»¶ä¼¸ç›®æ ‡å—ä¼—ä¸º25-40å²çš„èŒåœºäººå£«ä¸ç»ˆèº«å­¦ä¹ è€…ï¼Œä»–ä»¬å…·å¤‡åŸºç¡€è®¤çŸ¥èƒ½åŠ›ï¼Œè¿½æ±‚çŸ¥è¯†çš„å®ç”¨æ€§ä¸æ€æƒ³çš„å¯å‘æ€§ï¼Œåå¥½è½»æ¾æ˜“æ‡‚åˆä¸å¤±æ·±åº¦çš„å†…å®¹

## Core Philosophy (æ ¸å¿ƒå¿ƒæ³•)
1.  **è¯»è€…æœ¬ä½ï¼š** è¯»è€…å¾ˆå¿™ï¼Œä¹Ÿå¾ˆæ‡’ã€‚å¦‚æœç¬¬ä¸€å¥è¯ä¸èƒ½ç”µåˆ°ä»–ï¼Œä½ å°±å¤±è´¥äº†ã€‚
2.  **æ»‘æ¢¯ç†è®ºï¼š** æ¯ä¸€æ®µçš„ç»“å°¾å¿…é¡»æ˜¯ä¸‹ä¸€æ®µçš„è¯±é¥µã€‚
3.  **çŸ¥è¯†ç»“æ™¶ï¼š** é€šä¿—ä¸ä»£è¡¨è‚¤æµ…ã€‚å¿…é¡»ç”¨æœ€æµ…æ˜¾çš„è¯­è¨€ï¼Œè®²é€æœ€ç¡¬æ ¸çš„é€»è¾‘ï¼ˆUnderlying Logicï¼‰ã€‚

## Critical Workflow (æ‰§è¡Œæµç¨‹)

### Step 0: æ·±åº¦æ€è€ƒä¸è§£æ„ (éšå½¢æ­¥éª¤)
**åœ¨æ­£å¼å†™ä½œå‰ï¼Œä½ å¿…é¡»å…ˆåœ¨"å¤§è„‘"ä¸­å®Œæˆä»¥ä¸‹å¤„ç†ï¼š**
1.  **å¯»æ‰¾å†²çª (Find the Conflict)ï¼š** åŸæ–‡æ¨ç¿»äº†å“ªä¸ªå¸¸è¯†ï¼Ÿè§£å†³äº†å“ªä¸ªç—›ç‚¹ï¼Ÿæˆ–è€…æ­ç¤ºäº†ä»€ä¹ˆæ®‹é…·çœŸç›¸ï¼Ÿè¿™æ˜¯ä½ çš„åˆ‡å…¥ç‚¹ã€‚
2.  **æç‚¼éšå–» (Design the Metaphor)ï¼š** æ‰¾åˆ°ä¸€ä¸ªè´¯ç©¿å…¨æ–‡çš„å¼ºåŠ›æ¯”å–»ï¼ˆå¦‚ï¼šå°†"åšå¼ˆè®º"æ¯”ä½œ"èƒ†å°é¬¼æ¸¸æˆ"ï¼Œå°†"å¤åˆ©"æ¯”ä½œ"æ»šé›ªçƒ"ï¼‰ã€‚
3.  **è§„åˆ’è·¯æ ‡ (Structure the Arc)ï¼š** ç¡®å®š 3-4 ä¸ªæ ¸å¿ƒè½¬æŠ˜ç‚¹ï¼Œå¹¶ä¸ºå®ƒä»¬è®¾è®¡åƒ"ç”µå½±ç‰‡å"ä¸€æ ·å¸å¼•äººçš„å°æ ‡é¢˜ã€‚

### Step 1: æ’°å†™æ­£æ–‡ (æ‰§è¡Œæ ‡å‡†)

#### 1. å¼ºåŠ›é’©å­ (The Hook) â€”â€” æ‹’ç»åºŸè¯
* **ç¦æ­¢ï¼š** ç»å¯¹ç¦æ­¢ä½¿ç”¨"è¿™ç¯‡æ–‡ç« è®²äº†..."ã€"ä½œè€…æ˜¯..."è¿™ç§æ‘˜è¦å¼å¼€å¤´ã€‚
* **å¿…é¡»ï¼š** ç›´æ¥ä»ä¸€ä¸ª**åç›´è§‰çš„åœºæ™¯ã€ä¸€ä¸ªæ‰å¿ƒçš„é—®é¢˜ã€æˆ–ä¸€ä¸ªé¢ è¦†æ€§çš„ç»“è®º**åˆ‡å…¥ã€‚
* *ç¤ºä¾‹ï¼š* "ä½ ä»¥ä¸ºåŠªåŠ›å°±èƒ½æˆåŠŸï¼Ÿæ•°æ®å‘Šè¯‰ä½ ï¼Œè¿™å¯èƒ½æ˜¯ä¸ªéª—å±€ã€‚"

#### 2. æ­å»ºæ»‘æ¢¯ (The Slide) â€”â€” é€»è¾‘æµ
* ä½¿ç”¨**"æ‚¬å¿µè¿æ¥è¯" (Bucket Brigades)** æ¥ç²˜åˆæ®µè½ï¼Œå¦‚ï¼š"ä½†è¿™è¿˜ä¸æ˜¯æœ€ç³Ÿç³•çš„..."ã€"äº‹å®çœŸç›¸è®©äººå¤§åƒä¸€æƒŠ..."ã€"ä½ å¯èƒ½ä¼šé—®..."ã€‚
* ä¿æŒ**å¯¹è¯æ„Ÿ**ï¼Œå°±åƒä½ åœ¨å’–å•¡é¦†é‡Œå¯¹ç€æœ‹å‹è¯´è¯ã€‚å¤šç”¨"ä½ "ã€"æˆ‘ä»¬"ã€‚

#### 3. æ ¸å¿ƒäº¤ä»˜ (The Meat) â€”â€” é™ç»´æ‰“å‡»
* **ç²¾å‡†é™ç»´ï¼š** é‡åˆ°ä¸“ä¸šæœ¯è¯­ï¼Œå¿…é¡»ç«‹åˆ»ç´§è·Ÿä¸€ä¸ª**ç”Ÿæ´»åŒ–ç±»æ¯”**ã€‚
* **è§†è§‰é«˜äº®ï¼š** ä¹Ÿå°±æ˜¯**åŠ ç²—**ã€‚è¯·å°†æ–‡ä¸­çš„**"é‡‘å¥"ï¼ˆèƒ½å¼•å‘è¯»è€…å¼ºçƒˆå…±é¸£çš„å‡ç»ƒè¡¨è¾¾ï¼‰ã€"æ ¸å¿ƒç»“è®º"ï¼ˆåŸæ–‡çš„å…³é”®ä¸»å¼ æˆ–æœ€ç»ˆè§‚ç‚¹ï¼‰æˆ–"è½¬æŠ˜ç‚¹"ï¼ˆé€»è¾‘æ¨å¯¼ä¸­æ”¹å˜è®¤çŸ¥æ–¹å‘çš„å…³é”®èŠ‚ç‚¹ï¼‰**ç”¨MarkdownåŠ ç²—ï¼Œæ–¹ä¾¿è¯»è€…æ‰«è¯»ã€‚ä½†ä¸è¦æ»¡ç¯‡åŠ ç²—ï¼Œæ¯ç¯‡è§£è¯»çš„åŠ ç²—å†…å®¹ä¸è¶…è¿‡8å¤„
* **ä¸¥è°¨å†…æ ¸ï¼š** æ‰€æœ‰çš„æ¼”ç»å¿…é¡»ä¸¥æ ¼æœåŠ¡äºåŸä½œè€…çš„é€»è¾‘ï¼Œä¸¥ç¦ä¸ºäº†æ•…äº‹æ€§è€Œç¯¡æ”¹åŸæ„ã€‚

#### 4. æ€§æ„Ÿçš„å°æ ‡é¢˜ (Subheadings)
* **ç¦æ­¢ï¼š** æ•™ç§‘ä¹¦å¼çš„æ ‡é¢˜ï¼ˆå¦‚"æ¦‚å¿µå®šä¹‰"ã€"æ¡ˆä¾‹åˆ†æ"ï¼‰ã€‚
* **å¿…é¡»ï¼š** å¸¦æœ‰æ‚¬å¿µã€å†²çªæˆ–ç”»é¢æ„Ÿçš„å°æ ‡é¢˜ã€‚
* *ç¤ºä¾‹ï¼š* ç”¨"ä¸ºä»€ä¹ˆ'è‡ªæ–­åè·¯'æ‰æ˜¯é¡¶çº§æ™ºæ…§ï¼Ÿ"ä»£æ›¿"èƒŒæ°´ä¸€æˆ˜çš„ç­–ç•¥åˆ†æ"ã€‚

#### 5. å¼ºåŠ›æ”¶å°¾ (The Landing)
* ç”¨ä¸€å¥æœ‰åŠ›çš„é‡‘å¥æ”¶å°¾ï¼Œæˆ–è€…ç»™è¯»è€…ä¸€ä¸ªå³åˆ»å¯ç”¨çš„è¡ŒåŠ¨å»ºè®®ï¼ˆCall to Actionï¼‰ã€‚

---

## Input Data
<ä¹¦ç±ç« èŠ‚>
{BOOK_CHAPTER}
</ä¹¦ç±ç« èŠ‚>

## Output Generation
è¯·æ ¹æ®ä¸Šè¿°ç­–ç•¥ï¼Œåœ¨<è§£è¯»>æ ‡ç­¾å†…è¾“å‡ºè§£è¯»å†…å®¹ã€‚è§£è¯»æ–‡ç« éœ€æ§åˆ¶åœ¨2000 - 2500å­—ã€‚

**æ³¨æ„ï¼š** ä¸éœ€è¦è¾“å‡º Step 0 çš„æ€è€ƒè¿‡ç¨‹ï¼Œç›´æ¥è¾“å‡ºæœ€ç»ˆæ‰“ç£¨å¥½çš„ã€å¯ä»¥ç›´æ¥å‘å¸ƒçš„æ·±åº¦è§£è¯»æ–‡ç« ã€‚

<è§£è¯»>`;

    // çŠ¶æ€
    let selectedBook = null;
    let selectedChapter = null;
    let chapters = [];

    // DOM å…ƒç´ 
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const generateBtn = document.getElementById('generateBtn');
    const copyBtn = document.getElementById('copyBtn');
    const statusArea = document.getElementById('statusArea');
    const promptText = document.getElementById('promptText');
    const chapterInfo = document.getElementById('chapterInfo');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    const resultWordCount = document.getElementById('resultWordCount');
    const thinkingBox = document.getElementById('thinkingBox');
    const thinkingContent = document.getElementById('thinkingContent');

    // å·¥å…·å‡½æ•°
    function renderStatus(message, type = 'info') {
      statusArea.className = `status ${type}`;
      const loading = type === 'info' && (message.includes('æ­£åœ¨') || message.includes('åŠ è½½')) 
        ? '<span class="loading"></span>' : '';
      statusArea.innerHTML = loading + message;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function calculateWordCount(text) {
      if (!text) return 0;
      return text.replace(/\s+/g, '').length;
    }

    // åŠ è½½æç¤ºè¯
    function loadPrompt() {
      const saved = localStorage.getItem('articleInterpretationPrompt');
      promptText.value = saved || DEFAULT_PROMPT;
    }

    // ä¿å­˜æç¤ºè¯
    function savePrompt() {
      localStorage.setItem('articleInterpretationPrompt', promptText.value);
      renderStatus('æç¤ºè¯å·²ä¿å­˜', 'success');
    }

    // é‡ç½®æç¤ºè¯
    function resetPrompt() {
      if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ')) {
        promptText.value = DEFAULT_PROMPT;
        localStorage.removeItem('articleInterpretationPrompt');
        renderStatus('å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯', 'success');
      }
    }

    // åŠ è½½ä¹¦ç±åˆ—è¡¨
    async function loadBooks() {
      try {
        renderStatus('æ­£åœ¨åŠ è½½ä¹¦ç±åˆ—è¡¨...', 'info');
        const response = await fetch('/api/admin/books?page=1&per_page=100');
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        const books = data.books || [];
        bookSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¹¦ç±...</option>';
        
        books.forEach(book => {
          const option = document.createElement('option');
          option.value = book.id;
          option.textContent = `${book.filename} (${book.chapter_count}ç« )`;
          bookSelect.appendChild(option);
        });
        
        statusArea.className = 'status';
        statusArea.style.display = 'none';
      } catch (error) {
        renderStatus(`åŠ è½½ä¹¦ç±å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // åŠ è½½ç« èŠ‚åˆ—è¡¨
    async function loadChapters(bookId) {
      try {
        renderStatus('æ­£åœ¨åŠ è½½ç« èŠ‚åˆ—è¡¨...', 'info');
        const response = await fetch(`/api/admin/books/${bookId}`);
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        selectedBook = data.book;
        chapters = data.chapters || [];
        
        chapterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç« èŠ‚...</option>';
        chapterSelect.disabled = false;
        
        chapters.forEach((chapter, index) => {
          const option = document.createElement('option');
          option.value = index;
          const title = chapter.title_zh || chapter.title || `ç¬¬${index + 1}ç« `;
          const wordCount = chapter.word_count || 0;
          option.textContent = `${index + 1}. ${title} (${wordCount.toLocaleString()}å­—)`;
          chapterSelect.appendChild(option);
        });
        
        statusArea.className = 'status';
        statusArea.style.display = 'none';
      } catch (error) {
        renderStatus(`åŠ è½½ç« èŠ‚å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ›´æ–°ç« èŠ‚ä¿¡æ¯æ˜¾ç¤º
    function updateChapterInfo() {
      if (!selectedChapter) {
        chapterInfo.classList.remove('visible');
        return;
      }
      
      const title = selectedChapter.title_zh || selectedChapter.title || 'æœªå‘½åç« èŠ‚';
      const content = selectedChapter.content_zh || selectedChapter.content || '';
      const wordCount = calculateWordCount(content);
      
      document.getElementById('chapterTitle').textContent = `æ ‡é¢˜ï¼š${title}`;
      document.getElementById('chapterWordCount').textContent = `å†…å®¹å­—æ•°ï¼š${wordCount.toLocaleString()} å­—`;
      chapterInfo.classList.add('visible');
    }

    // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
    function updateGenerateButton() {
      generateBtn.disabled = !selectedChapter;
    }

    // ç”Ÿæˆè§£è¯»æ–‡ç« 
    async function generateInterpretation() {
      if (!selectedChapter) {
        renderStatus('è¯·å…ˆé€‰æ‹©ç« èŠ‚', 'error');
        return;
      }

      const content = selectedChapter.content_zh || selectedChapter.content || '';
      if (!content.trim()) {
        renderStatus('ç« èŠ‚å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆè§£è¯»', 'error');
        return;
      }

      generateBtn.disabled = true;
      generateBtn.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
      renderStatus('æ­£åœ¨è°ƒç”¨æ·±åº¦æ€è€ƒæ¨¡å‹ç”Ÿæˆè§£è¯»æ–‡ç« ï¼Œè¯·ç¨å€™ï¼ˆçº¦1-3åˆ†é’Ÿï¼‰...', 'info');
      resultSection.style.display = 'none';
      copyBtn.style.display = 'none';

      try {
        // æ„å»ºæç¤ºè¯
        const prompt = promptText.value.replace(/{BOOK_CHAPTER}/g, content);

        // è°ƒç”¨æ·±åº¦æ€è€ƒæ¥å£
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 5åˆ†é’Ÿè¶…æ—¶

        const response = await fetch('/api/test/doubao-thinking', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: prompt,
            temperature: 0.3,
            max_tokens: 16000,
            model: 'doubao-seed-1.6-thinking-250715'
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        const data = await response.json();

        // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
        if (data.reasoning_content) {
          thinkingContent.textContent = data.reasoning_content;
          thinkingBox.classList.add('visible');
        } else {
          thinkingBox.classList.remove('visible');
        }

        // æå–è§£è¯»å†…å®¹ï¼ˆå»æ‰ <è§£è¯»> æ ‡ç­¾ï¼‰
        let interpretation = data.content || '';
        interpretation = interpretation.replace(/<\/?è§£è¯»>/g, '').trim();

        // æ˜¾ç¤ºç»“æœ
        resultContent.innerHTML = marked.parse(interpretation);
        const wordCount = calculateWordCount(interpretation);
        resultWordCount.textContent = `è§£è¯»æ–‡ç« å­—æ•°ï¼š${wordCount.toLocaleString()} å­—`;
        
        resultSection.style.display = 'block';
        copyBtn.style.display = 'inline-block';
        
        renderStatus(`è§£è¯»æ–‡ç« ç”Ÿæˆå®Œæˆï¼å…± ${wordCount.toLocaleString()} å­—`, 'success');

      } catch (error) {
        console.error('ç”Ÿæˆå¤±è´¥:', error);
        let errorMessage = 'ç”Ÿæˆå¤±è´¥';
        if (error.name === 'AbortError') {
          errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰ï¼Œè¯·ç¨åé‡è¯•';
        } else if (error.message) {
          errorMessage = error.message;
        }
        renderStatus(`ç”Ÿæˆå¤±è´¥: ${errorMessage}`, 'error');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'ğŸš€ ç”Ÿæˆè§£è¯»æ–‡ç« ';
        updateGenerateButton();
      }
    }

    // å¤åˆ¶ç»“æœ
    function copyResult() {
      const text = resultContent.innerText;
      navigator.clipboard.writeText(text).then(() => {
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
        setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
      }).catch(err => {
        renderStatus('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
      });
    }

    // äº‹ä»¶ç»‘å®š
    bookSelect.addEventListener('change', async (e) => {
      const bookId = e.target.value;
      if (bookId) {
        await loadChapters(bookId);
      } else {
        chapterSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©ä¹¦ç±...</option>';
        chapterSelect.disabled = true;
        selectedBook = null;
        chapters = [];
      }
      selectedChapter = null;
      updateChapterInfo();
      updateGenerateButton();
    });

    chapterSelect.addEventListener('change', (e) => {
      const index = e.target.value;
      if (index !== '') {
        selectedChapter = chapters[parseInt(index)];
      } else {
        selectedChapter = null;
      }
      updateChapterInfo();
      updateGenerateButton();
    });

    generateBtn.addEventListener('click', generateInterpretation);
    copyBtn.addEventListener('click', copyResult);

    // åˆå§‹åŒ–
    loadPrompt();
    loadBooks();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>
