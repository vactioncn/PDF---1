# CloudBase 完整云化配置指南

## 📋 需要配置的云服务清单

### ✅ 已完成
- [x] 容器服务（云托管）- pdf-service
- [x] 静态网站托管 - frontend/dist
- [x] 代码支持 MySQL 数据库

### 🔧 待配置
- [ ] MySQL 云数据库
- [ ] 环境变量配置（API Keys）
- [ ] 日志服务（自动启用）

---

## 第一步：创建 MySQL 云数据库

### 1.1 在控制台创建数据库

1. 打开 CloudBase 控制台：https://tcb.cloud.tencent.com/dev?envId=aireadbook001-7g3su3oo81a89e2e
2. 左侧菜单 → **数据库** → **MySQL**
3. 点击 **新建数据库**
4. 配置信息：
   - **数据库名称**：`pdf_app_db`（或自定义）
   - **字符集**：`utf8mb4`
   - **排序规则**：`utf8mb4_general_ci`
   - **版本**：选择最新版本
   - **规格**：选择最小规格即可（后续可升级）
5. 点击 **确定** 创建

### 1.2 获取数据库连接信息

创建完成后，在数据库列表中：
1. 点击数据库名称进入详情
2. 记录以下信息：
   - **内网地址**（Host）：例如 `10.0.0.1`
   - **端口**（Port）：通常是 `3306`
   - **数据库名**：你创建的名称
   - **用户名**：通常是 `root`
   - **密码**：创建时设置的密码（如果忘记了，可以重置）

### 1.3 构建数据库连接字符串

格式：
```
mysql+pymysql://用户名:密码@内网地址:端口/数据库名?charset=utf8mb4
```

示例：
```
mysql+pymysql://root:your_password@10.0.0.1:3306/pdf_app_db?charset=utf8mb4
```

**⚠️ 重要**：使用**内网地址**，不要使用公网地址（容器服务在同一内网，内网访问更快更安全）

---

## 第二步：配置环境变量

### 2.1 进入环境变量配置页面

1. 控制台 → **云托管** → **pdf-service**
2. 点击 **环境变量** 标签
3. 点击 **新增环境变量**

### 2.2 添加所有必需的环境变量

按以下顺序添加（点击"新增"添加每一条）：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `DATABASE_URL` | `mysql+pymysql://root:密码@内网地址:3306/数据库名?charset=utf8mb4` | MySQL 数据库连接（使用第一步获取的信息） |
| `DOUBAO_API_KEY` | `你的豆包API密钥` | 豆包 API 密钥（必需） |
| `DOUBAO_API_BASE` | `https://ark.cn-beijing.volces.com/api/v3` | 豆包 API 地址（可选，有默认值） |
| `DEEPSEEK_API_KEY` | `你的DeepSeek密钥` | DeepSeek API 密钥（如果使用） |
| `VOLCENGINE_TTS_ACCESS_KEY` | `你的火山引擎AccessKey` | 火山引擎 TTS（如果使用播客功能） |
| `VOLCENGINE_TTS_SECRET_KEY` | `你的火山引擎SecretKey` | 火山引擎 TTS（如果使用播客功能） |
| `VOLCENGINE_TTS_APP_ID` | `你的火山引擎AppID` | 火山引擎 TTS（如果使用播客功能） |

### 2.3 环境变量说明

**必需的环境变量：**
- `DATABASE_URL` - 数据库连接（必须配置，否则使用临时 SQLite）
- `DOUBAO_API_KEY` - 豆包 API 密钥（核心功能必需）

**可选的环境变量：**
- `DOUBAO_API_BASE` - 如果不配置，使用默认值
- `DEEPSEEK_API_KEY` - 如果只使用豆包，可以不配置
- `VOLCENGINE_*` - 如果不用播客功能，可以不配置

### 2.4 保存配置

1. 添加完所有环境变量后，点击 **保存**
2. 系统会自动重启服务，应用新的配置
3. 等待 1-2 分钟让服务重启完成

---

## 第三步：验证配置

### 3.1 检查服务状态

1. 控制台 → **云托管** → **pdf-service**
2. 查看 **运行状态**，应该是 `正常`
3. 查看 **访问地址**，记录下服务域名

### 3.2 测试应用

1. 访问服务地址：`https://你的服务域名/`
2. 测试功能：
   - 访问首页
   - 测试 API 接口（如 `/api/settings/prompt_parts`）
   - 上传文件测试解析功能

### 3.3 检查数据库

1. 控制台 → **数据库** → **MySQL** → 你的数据库
2. 点击 **SQL 编辑器**
3. 执行查询：
   ```sql
   SHOW TABLES;
   ```
4. 应该能看到以下表：
   - `settings`
   - `interpretations`
   - `books`
   - `chapter_summaries`

如果看到这些表，说明数据库配置成功！

---

## 第四步：查看日志（可选）

### 4.1 访问日志

1. 控制台 → **云托管** → **pdf-service**
2. 点击 **日志** 标签
3. 可以查看：
   - 应用启动日志
   - 错误日志
   - 访问日志

### 4.2 常见问题排查

如果遇到问题，查看日志中的错误信息：
- **数据库连接失败**：检查 `DATABASE_URL` 是否正确
- **API 调用失败**：检查 `DOUBAO_API_KEY` 是否有效
- **服务无法启动**：查看启动日志中的错误信息

---

## 🎉 完成！

配置完成后，你的应用已经：
- ✅ 使用云数据库（数据持久化）
- ✅ 使用云容器服务（自动扩缩容）
- ✅ 使用云静态托管（CDN 加速）
- ✅ 环境变量统一管理（安全可靠）

---

## 📝 后续维护

### 更新代码
```bash
# 修改代码后，重新部署
tcb cloudrun deploy -e aireadbook001-7g3su3oo81a89e2e -s pdf-service --port 8080 --source . --force
```

### 更新环境变量
在控制台直接修改环境变量，保存后服务会自动重启

### 查看数据库
在控制台的 SQL 编辑器中直接查询和管理数据

### 备份数据
CloudBase 会自动备份 MySQL 数据库，你也可以手动创建备份

---

## ❓ 需要帮助？

如果遇到问题：
1. 查看控制台的日志
2. 检查环境变量是否正确
3. 确认数据库连接信息
4. 联系我继续排查

